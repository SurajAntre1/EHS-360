{% extends 'base/base.html' %}
{% load static %}

{% block title %}Create Investigation Report{% endblock %}
{% block page_title %}Create Investigation Report{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'accidents:dashboard' %}">Incident Management</a></li>
<li class="breadcrumb-item"><a href="{% url 'accidents:incident_detail' incident.pk %}">{{ incident.report_number }}</a></li>
<li class="breadcrumb-item active">Investigation Report</li>
{% endblock %}

{% block extra_css %}
<!-- Link to Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<style>
/* ... your existing styles ... */
.unsafe-section {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    background-color: #f8f9fa;
    margin-bottom: 20px;
}
.unsafe-section h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
}
.unsafe-checkbox-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
}
.unsafe-checkbox-item {
    padding: 5px 0;
}
.unsafe-checkbox-item .form-check {
    margin-bottom: 0;
}
.unsafe-checkbox-item .form-check-label {
    font-size: 0.95rem;
    color: #495057;
    cursor: pointer;
    padding-left: 5px;
}
.unsafe-checkbox-item .form-check-input {
    margin-top: 0.25rem;
}
.unsafe-checkbox-item .form-check-input:checked ~ .form-check-label {
    color: #000;
    font-weight: 500;
}
.action-item-form {
    position: relative;
    border: 1px solid #e3e6f0;
    background-color: #fdfdff;
}
.remove-action-item-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: none;
    background-color: #e74a3b;
    color: white;
    font-size: 1.2rem;
    line-height: 1;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-bottom: 3px; 
    transition: background-color 0.2s;
    z-index: 10;
}
.remove-action-item-btn:hover {
    background-color: #c82333;
}

/* Styles for Select2 to match Bootstrap 4 */
.select2-container--default .select2-selection--multiple {
    border: 1px solid #ced4da !important;
    min-height: calc(1.5em + .75rem + 2px);
    padding: .375rem .75rem;
}
/* .select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #007bff;
    border-color: #006fe6;
    color: white;
    padding: 2px 8px;
    margin-top: 0.25rem;
/* } */
.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
    color: #6c757d;
}

.select2-container--default 
.select2-selection--multiple 
.select2-selection__choice__remove:hover {
    color: #dc3545; /* red on hover */
}

.select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: #e9ecef;   /* light grey */
    border: 1px solid #ced4da;
    color: #495057;
}

.select2-results__options {
    max-height: 250px; 
    overflow-y: auto;
}
.select2-container--default.select2-container--open 
.select2-selection--multiple {
    border-color: #ced4da !important;
    box-shadow: none !important;
}

/* When focused or focus-within */
.select2-container--default 
.select2-selection--multiple:focus,
.select2-container--default 
.select2-selection--multiple:focus-within {
    border-color: #ced4da !important;
    box-shadow: none !important;
}

/* Safety: override any remaining default rule */
.select2-container--default 
.select2-selection--multiple {
    outline: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    
    <!-- Incident Summary Card -->
    <div class="card border-left-warning shadow mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <h4 class="mb-1">{{ incident.report_number }}</h4>
            <p class="mb-1"><strong>Title:</strong> {{ incident.incident_title }}</p>
            <p class="mb-1"><strong>Date:</strong> {{ incident.incident_date|date:"d/m/Y" }} at {{ incident.incident_time|time:"H:i" }}</p>
            <p class="mb-0"><strong>Location:</strong> {{ incident.plant.name }} - {{ incident.location.name }}</p>
          </div>
          <div class="col-md-4 text-right">
            <span class="badge badge-lg badge-warning">{{ incident.get_incident_type_display }}</span><br>
            <span class="badge badge-lg badge-danger">{{ incident.severity_level }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Investigation Report Form -->
    <div class="ehs-card">
      <div class="card-header bg-warning">
        <h3 class="card-title mb-0">
          <i class="fas fa-search mr-2"></i>Investigation Report (Required within 7 days)
        </h3>
      </div>
      
      <form method="POST" id="investigationForm">
        {% csrf_token %}
        
        <input type="hidden" name="personal_factors_json" id="personalFactorsJson">
        <input type="hidden" name="job_factors_json" id="jobFactorsJson">
        
        <div class="card-body">
          
          <div class="alert alert-info">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Investigation Deadline:</strong> {{ incident.investigation_deadline|date:"d/m/Y" }}
            {% if incident.is_investigation_overdue %}
              <span class="badge badge-danger ml-2">OVERDUE</span>
            {% endif %}
            <br>
            Complete this investigation report as per client requirements. All fields marked with <span class="text-danger">*</span> are mandatory.
          </div>

          <!-- Investigation Details -->
          <h5 class="mb-3"><i class="fas fa-clipboard-list mr-2"></i>Investigation Details</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.investigation_date.id_for_label }}">Investigation Date <span class="text-danger">*</span></label>
              {{ form.investigation_date }}
              {% if form.investigation_date.errors %}
                <div class="text-danger">{{ form.investigation_date.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label>Investigator</label>
              <input type="text" class="form-control" value="{{ user.get_full_name }}" readonly>
            </div>
          </div>

          <div class="row">
              <div class="col-md-12 mb-3">
                <label for="{{ form.investigation_team.id_for_label }}">Investigation Team Members Emails <span class="text-danger">*</span></label>
                {{ form.investigation_team }}
                <small class="form-text text-muted">Enter one or more email addresses separated by commas.</small>
                {% if form.investigation_team.errors %}
                  <div class="invalid-feedback d-block">{{ form.investigation_team.errors }}</div>
                {% endif %}
              </div>
          </div>

          <hr>

          <!-- Findings -->
          <h5 class="mb-3"><i class="fas fa-search-plus mr-2"></i>Investigation Findings</h5>
          
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="{{ form.sequence_of_events.id_for_label }}">Sequence of Events <span class="text-danger">*</span></label>
              {{ form.sequence_of_events }}
              <small class="form-text text-muted">Chronological description of events leading to the incident</small>
              {% if form.sequence_of_events.errors %}
                <div class="text-danger">{{ form.sequence_of_events.errors }}</div>
              {% endif %}
            </div>
          </div>

          <!-- Root Cause Analysis with Checkboxes -->
          <div class="row">
            <div class="col-md-12 mb-3">
              <h6 class="mb-3"><strong>Root Cause(s) of the incident / accident (Tick) (Reasons for immediate cause based on Root Cause Analysis):</strong></h6>
              <div class="row">
                <!-- Personal Factors -->
                <div class="col-md-6">
                  <div class="unsafe-section">
                    <h6><i class="fas fa-user mr-2"></i>Personal Factors</h6>
                    <div class="unsafe-checkbox-grid">
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor" value="Inadequate physical capability of the injured" id="pf1"><label class="form-check-label" for="pf1">Inadequate physical capability of the injured</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor" value="Inadequate physiological capability of the injured" id="pf2"><label class="form-check-label" for="pf2">Inadequate physiological capability of the injured</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor" value="Inadequate Mental capability of the injured" id="pf3"><label class="form-check-label" for="pf3">Inadequate Mental capability of the injured</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor" value="Inadequate psychological capability of the injured" id="pf4"><label class="form-check-label" for="pf4">Inadequate psychological capability of the injured</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor" value="Lack of Knowledge" id="pf5"><label class="form-check-label" for="pf5">Lack of Knowledge</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor" value="Lack of skill" id="pf6"><label class="form-check-label" for="pf6">Lack of skill</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor" value="Lack of motivation" id="pf7"><label class="form-check-label" for="pf7">Lack of motivation</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor" value="Lack of experience in the job" id="pf8"><label class="form-check-label" for="pf8">Lack of experience in the job</label></div></div>
                        <div class="unsafe-checkbox-item"> <div class="form-check"><input class="form-check-input personal-factor-checkbox" type="checkbox" name="personal_factor_other_checkbox" value="Other (explain)" id="pf9"><label class="form-check-label" for="pf9">Other (explain)</label></div><div id="personalFactorOther" class="mt-2" style="display: none;"><input type="text" class="form-control form-control-sm" name="personal_factor_other_text" placeholder="Please specify"></div></div>
                    </div>
                  </div>
                </div>
                <!-- Job Factors -->
                <div class="col-md-6">
                  <div class="unsafe-section">
                    <h6><i class="fas fa-briefcase mr-2"></i>Job Factors</h6>
                    <div class="unsafe-checkbox-grid">
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Inadequate / No supervision of the job" id="jf1"><label class="form-check-label" for="jf1">Inadequate / No supervision of the job</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Inadequate engineering (no safeguards, no railings etc.)" id="jf2"><label class="form-check-label" for="jf2">Inadequate engineering (no safeguards, no railings etc.)</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Inadequate communication of safety requirements" id="jf3"><label class="form-check-label" for="jf3">Inadequate communication of safety requirements</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Improper handling, transportation & storage of materials" id="jf4"><label class="form-check-label" for="jf4">Improper handling, transportation & storage of materials</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Improper contractor selection" id="jf5"><label class="form-check-label" for="jf5">Improper contractor selection</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Inadequate / Improper tools & Equipment" id="jf6"><label class="form-check-label" for="jf6">Inadequate / Improper tools & Equipment</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Excessive wear & tear of tools / equipment" id="jf7"><label class="form-check-label" for="jf7">Excessive wear & tear of tools / equipment</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Inadequate work procedures" id="jf8"><label class="form-check-label" for="jf8">Inadequate work procedures</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Inadequate management system" id="jf9"><label class="form-check-label" for="jf9">Inadequate management system</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Poor Maintenance" id="jf10"><label class="form-check-label" for="jf10">Poor Maintenance</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor" value="Abuse or misuse of equipment" id="jf11"><label class="form-check-label" for="jf11">Abuse or misuse of equipment</label></div></div>
                        <div class="unsafe-checkbox-item"><div class="form-check"><input class="form-check-input job-factor-checkbox" type="checkbox" name="job_factor_other_checkbox" value="Other (explain)" id="jf12"><label class="form-check-label" for="jf12">Other (explain)</label></div><div id="jobFactorOther" class="mt-2" style="display: none;"><input type="text" class="form-control form-control-sm" name="job_factor_other_text" placeholder="Please specify"></div></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3 required-field">
              <label for="{{ form.root_cause_analysis.id_for_label }}">Additional Root Cause Analysis Details<span class="text-danger">*</span></label>
              {{ form.root_cause_analysis }}
              <small class="form-text text-muted ">Provide additional details or explanation for selected root causes</small>
              {% if form.root_cause_analysis.errors %}
                <div class="text-danger">{{ form.root_cause_analysis.errors }}</div>
              {% endif %}
            </div>
          </div>

          <hr>

          <!-- Evidence -->
          <h5 class="mb-3"><i class="fas fa-file-alt mr-2"></i>Evidence & Statements</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.evidence_collected.id_for_label }}">Evidence Collected</label>
              {{ form.evidence_collected }}
              <small class="form-text text-muted">Physical evidence, photos, documents, etc.</small>
              {% if form.evidence_collected.errors %}<div class="text-danger">{{ form.evidence_collected.errors }}</div>{% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="{{ form.witness_statements.id_for_label }}">Witness Statements</label>
              {{ form.witness_statements }}
              <small class="form-text text-muted">Summary of witness testimonies</small>
              {% if form.witness_statements.errors %}<div class="text-danger">{{ form.witness_statements.errors }}</div>{% endif %}
            </div>
          </div>

          <hr>

          <!-- Recommendations -->
          <h5 class="mb-3"><i class="fas fa-lightbulb mr-2"></i>Recommendations & Action Plan</h5>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="{{ form.immediate_corrective_actions.id_for_label }}">Immediate Corrective Actions <span class="text-danger">*</span></label>
              {{ form.immediate_corrective_actions }}
              <small class="form-text text-muted">Actions already taken or to be taken immediately</small>
              {% if form.immediate_corrective_actions.errors %}<div class="text-danger">{{ form.immediate_corrective_actions.errors }}</div>{% endif %}
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="{{ form.preventive_measures.id_for_label }}">Preventive Measures <span class="text-danger">*</span></label>
              {{ form.preventive_measures }}
              <small class="form-text text-muted">Measures to prevent recurrence of similar incidents</small>
              {% if form.preventive_measures.errors %}<div class="text-danger">{{ form.preventive_measures.errors }}</div>{% endif %}
            </div>
          </div>

          <hr>
          
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0"><i class="fas fa-tasks mr-2"></i>Action Items</h5>
            <button type="button" id="add-action-item-btn" class="btn btn-sm btn-success">
              <i class="fas fa-plus mr-1"></i>Add Action Item
            </button>
          </div>
          
          <div id="action-items-container">
            {{ action_item_formset.management_form }}
            {% for form in action_item_formset %}
              <div class="action-item-form p-3 mb-3 rounded">
                <button type="button" class="remove-action-item-btn" title="Remove Action Item">&times;</button>
                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.action_description.id_for_label }}">Action Description <span class="text-danger">*</span></label>
                    {{ form.action_description }}
                    {% if form.action_description.errors %}<div class="text-danger">{{ form.action_description.errors }}</div>{% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.responsible_person.id_for_label }}">Responsible Person(s) <span class="text-danger">*</span></label>
                    {{ form.responsible_person }}
                    {% if form.responsible_person.errors %}
                      <div class="text-danger small mt-1">{% for error in form.responsible_person.errors %}{{ error }}{% endfor %}</div>
                    {% endif %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.target_date.id_for_label }}">Target Completion Date <span class="text-danger">*</span></label>
                    {{ form.target_date }}
                    {% if form.target_date.errors %}<div class="text-danger">{{ form.target_date.errors }}</div>{% endif %}
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.status.id_for_label }}">Status <span class="text-danger">*</span></label>
                    {{ form.status }}
                    {% if form.status.errors %}<div class="text-danger">{{ form.status.errors }}</div>{% endif %}
                  </div>
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.completion_date.id_for_label }}">Completion Date</label>
                    {{ form.completion_date }}
                    {% if form.completion_date.errors %}<div class="text-danger">{{ form.completion_date.errors }}</div>{% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Hidden template for new action item forms -->
          <div id="empty-action-item-form" class="d-none">
            <div class="action-item-form p-3 mb-3 rounded">
              <button type="button" class="remove-action-item-btn" title="Remove Action Item">&times;</button>
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label for="{{ action_item_formset.empty_form.action_description.id_for_label }}">Action Description <span class="text-danger">*</span></label>
                  {{ action_item_formset.empty_form.action_description }}
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ action_item_formset.empty_form.responsible_person.id_for_label }}">Responsible Person(s) <span class="text-danger">*</span></label>
                  {{ action_item_formset.empty_form.responsible_person }}
                </div>
                <div class="col-md-6 mb-3">
                  <label for="{{ action_item_formset.empty_form.target_date.id_for_label }}">Target Completion Date <span class="text-danger">*</span></label>
                  {{ action_item_formset.empty_form.target_date }}
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="{{ action_item_formset.empty_form.status.id_for_label }}">Status <span class="text-danger">*</span></label>
                  {{ action_item_formset.empty_form.status }}
                </div>
                <div class="col-md-6 mb-3">
                  <label for="{{ action_item_formset.empty_form.completion_date.id_for_label }}">Completion Date</label>
                  {{ action_item_formset.empty_form.completion_date }}
                </div>
              </div>
            </div>
          </div>

          <hr>

          <!-- Sign-off -->
          <h5 class="mb-3"><i class="fas fa-signature mr-2"></i>Report Completion</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.completed_date.id_for_label }}">Report Completion Date <span class="text-danger">*</span></label>
              {{ form.completed_date }}
              {% if form.completed_date.errors %}
                <div class="text-danger">{{ form.completed_date.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label>Completed By</label>
              <input type="text" class="form-control" value="{{ user.get_full_name }}" readonly>
            </div>
          </div>
        </div>

        <div class="card-footer">
          <button type="submit" class="btn btn-warning btn-lg">
            <i class="fas fa-check mr-2"></i>Submit Investigation Report
          </button>
          <a href="{% url 'accidents:incident_detail' incident.pk %}" class="btn btn-secondary btn-lg ml-2">
            <i class="fas fa-times mr-2"></i>Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_js %}
<!-- jQuery (required for Select2) and Select2 JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Use a more robust selector that targets the <select> elements by their name attribute pattern
    const responsiblePersonSelector = 'select[name$="-responsible_person"]';

    // Function to initialize Select2 on a given jQuery element
    function initializeSelect2(element) {
        // Check if the element exists and has not already been initialized by Select2
        if (element.length && !element.hasClass('select2-hidden-accessible')) {
            element.select2({
                width: '100%',
                theme: 'default' // This uses the default theme which we are styling with CSS to match Bootstrap
            });
        }
    }

    // Initialize Select2 on responsible person fields that are already on the page when it loads.
    // We target only the selects inside the main container to avoid initializing on the hidden template form.
    initializeSelect2($('#action-items-container').find(responsiblePersonSelector));

    /* ----------------------------------------------------
       CORRECTED DYNAMIC ACTION ITEMS LOGIC
    ---------------------------------------------------- */
    const addActionItemBtn = document.getElementById('add-action-item-btn');
    const container = document.getElementById('action-items-container');
    const emptyFormTemplate = document.getElementById('empty-action-item-form');
    const totalForms = document.getElementById('id_actionitems-TOTAL_FORMS');
    const today = new Date().toISOString().split('T')[0];

    if (addActionItemBtn && container && emptyFormTemplate && totalForms) {
        
        addActionItemBtn.addEventListener('click', function() {
            let formNum = parseInt(totalForms.value);
            
            // Get the raw HTML from the template and replace the prefix
            const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, formNum);
            
            // Create a temporary container to safely parse the new form HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFormHtml;
            const newFormElement = tempDiv.firstElementChild;
            
            // Append the new form to the container on the page
            container.appendChild(newFormElement);

            // IMPORTANT: Find the new select element within the newly added form and initialize Select2
            const newSelect = $(newFormElement).find(responsiblePersonSelector);
            initializeSelect2(newSelect);

            // Also, set the min date for the new target_date input
            const newTargetDateInput = newFormElement.querySelector('input[name$="-target_date"]');
            if (newTargetDateInput) {
                newTargetDateInput.min = today;
            }

            // Increment the total forms count for the Django formset
            totalForms.value = formNum + 1;
        });

        container.addEventListener('click', function(event) {
            // Use .closest() to find the button, which is more reliable than checking event.target directly
            const removeBtn = event.target.closest('.remove-action-item-btn');
            if (removeBtn) {
                    if (document.activeElement) {
                  document.activeElement.blur();
              }
                
                // Before removing the form, find the Select2 element and properly destroy it
                const selectElement = $(formToRemove).find(responsiblePersonSelector);
                if (selectElement.data('select2')) {
                    selectElement.select2('destroy');
                }
                
                // Now, remove the form element from the DOM
                formToRemove.remove();
            }
        });
    }

    /* ----------------------------------------------------
       ALL YOUR OTHER JS LOGIC (NO CHANGES NEEDED)
    ---------------------------------------------------- */
    const pfOtherCheckbox = document.getElementById('pf9');
    const pfOtherInputDiv = document.getElementById('personalFactorOther');
    const jfOtherCheckbox = document.getElementById('jf12');
    const jfOtherInputDiv = document.getElementById('jobFactorOther');

    if (pfOtherCheckbox && pfOtherInputDiv) {
        pfOtherCheckbox.addEventListener('change', function() {
            pfOtherInputDiv.style.display = this.checked ? 'block' : 'none';
        });
    }

    if (jfOtherCheckbox && jfOtherInputDiv) {
        jfOtherCheckbox.addEventListener('change', function() {
            jfOtherInputDiv.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Set today's date for date inputs on initial page load
    const investigationDateInput = document.getElementById('id_investigation_date');
    if (investigationDateInput && !investigationDateInput.value) investigationDateInput.value = today;
    
    const completedDateInput = document.getElementById('id_completed_date');
    if (completedDateInput && !completedDateInput.value) completedDateInput.value = today;

    // Set min attribute for existing target_date inputs
    document.querySelectorAll('input[name$="-target_date"]').forEach(function(input) {
        input.min = today;
    });

    // Handle the collection of checkbox data on form submission
    const form = document.getElementById('investigationForm');
    if (form) {
        form.addEventListener('submit', function() {
            const personalFactors = [];
            document.querySelectorAll('.personal-factor-checkbox:checked, input[name="personal_factor_other_checkbox"]:checked').forEach(checkbox => {
                if (checkbox.id === 'pf9') {
                    const otherText = document.querySelector('input[name="personal_factor_other_text"]')?.value.trim();
                    if (otherText) personalFactors.push(`Other: ${otherText}`);
                } else {
                    personalFactors.push(checkbox.value);
                }
            });
            const jobFactors = [];
            document.querySelectorAll('.job-factor-checkbox:checked, input[name="job_factor_other_checkbox"]:checked').forEach(checkbox => {
                if (checkbox.id === 'jf12') {
                    const otherText = document.querySelector('input[name="job_factor_other_text"]')?.value.trim();
                    if (otherText) jobFactors.push(`Other: ${otherText}`);
                } else {
                    jobFactors.push(checkbox.value);
                }
            });
            document.getElementById('personalFactorsJson').value = JSON.stringify(personalFactors);
            document.getElementById('jobFactorsJson').value = JSON.stringify(jobFactors);
        });
    }

});

</script>
{% endblock %}