{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit Incident - {{ incident.report_number }}{% endblock %}
{% block page_title %}Edit Incident Report{% endblock %}

{% block extra_css %}
<style>
/* Unsafe Acts and Conditions Section */
.unsafe-section {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    background-color: #f8f9fa;
    margin-bottom: 20px;
}

.unsafe-section h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dee2e6;
}

.unsafe-checkbox-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
}

.unsafe-checkbox-item {
    padding: 5px 0;
}

.unsafe-checkbox-item .form-check {
    margin-bottom: 0;
}

.unsafe-checkbox-item .form-check-label {
    font-size: 0.95rem;
    color: #495057;
    cursor: pointer;
    padding-left: 5px;
}

.unsafe-checkbox-item .form-check-input {
    margin-top: 0.25rem;
}

.unsafe-checkbox-item .form-check-input:checked ~ .form-check-label {
    color: #000;
    font-weight: 500;
}

.other-explanation-box {
    margin-top: 10px;
    display: none;
}

.other-explanation-box.show {
    display: block;
}

/* Affected Person Section Styling */
.affected-person-section {
    background-color: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.affected-person-section h5 {
    color: #dc3545;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #dc3545;
}

.form-group label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 5px;
}

.readonly-field {
    background-color: #e9ecef;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'accidents:dashboard' %}">Incident Management</a></li>
<li class="breadcrumb-item"><a href="{% url 'accidents:incident_detail' incident.pk %}">{{ incident.report_number }}</a></li>
<li class="breadcrumb-item active">Edit</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="ehs-card">
      <div class="card-header bg-primary text-white">
        <h3 class="card-title mb-0">
          <i class="fas fa-edit mr-2"></i>Edit Incident Report - {{ incident.report_number }}
        </h3>
      </div>
      
      <form method="POST" id="incidentForm" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="affected_body_parts_json" id="affectedBodyPartsJson">
        <input type="hidden" name="unsafe_acts_json" id="unsafeActsJson">
        <input type="hidden" name="unsafe_conditions_json" id="unsafeConditionsJson">
        
        <div class="card-body">
          
          <!-- Alert Info -->
          <div class="alert alert-info">
            <i class="fas fa-info-circle mr-2"></i>
            You are editing incident report <strong>{{ incident.report_number }}</strong>.
            All fields marked with <span class="text-danger">*</span> are mandatory.
          </div>

          <!-- Incident Type & Date/Time -->
          <h5 class="mb-3"><i class="fas fa-calendar-alt mr-2"></i>Incident Information</h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="id_incident_type">Type of Incident <span class="text-danger">*</span></label>
              <select name="incident_type" id="id_incident_type" class="form-control" required>
                <option value="">Select incident type</option>
                <option value="FA" {% if incident.incident_type == 'FA' %}selected{% endif %}>First Aid (FA)</option>
                <option value="MTC" {% if incident.incident_type == 'MTC' %}selected{% endif %}>Medical Treatment Case (MTC/RWC)</option>
                <option value="LTI" {% if incident.incident_type == 'LTI' %}selected{% endif %}>Lost Time Injury (LTI)</option>
                <option value="HLFI" {% if incident.incident_type == 'HLFI' %}selected{% endif %}>High Lost Frequency Injury (HLFI)</option>
                <option value="FATALITY" {% if incident.incident_type == 'FATALITY' %}selected{% endif %}>Fatality</option>
              </select>
              {% if form.incident_type.errors %}
                <div class="text-danger">{{ form.incident_type.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-4 mb-3">
              <label for="{{ form.incident_date.id_for_label }}">Date of Incident <span class="text-danger">*</span></label>
              {{ form.incident_date }}
              {% if form.incident_date.errors %}
                <div class="text-danger">{{ form.incident_date.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-4 mb-3">
              <label for="{{ form.incident_time.id_for_label }}">Time of Incident <span class="text-danger">*</span></label>
              {{ form.incident_time }}
              {% if form.incident_time.errors %}
                <div class="text-danger">{{ form.incident_time.errors }}</div>
              {% endif %}
            </div>
          </div>

          <hr>

          <!-- Location Information -->
<h5 class="mb-3"><i class="fas fa-map-marker-alt mr-2"></i>Location Information</h5>
<div class="row">
    
    <!-- Plant Field -->
    <div class="col-md-3 mb-3">
        <label for="id_plant">Plant <span class="text-danger">*</span></label>
        
        {% if user_assigned_plants.count == 1 %}
            <!-- If user has only ONE assigned plant, show it as read-only text -->
            <input type="text" class="form-control" 
                   value="{{ user_assigned_plants.first.name }} ({{ user_assigned_plants.first.code }})" 
                   readonly style="background-color: #e9ecef;">
            <!-- IMPORTANT: Add a hidden input to submit the value -->
            <input type="hidden" name="plant" id="id_plant_hidden" value="{{ user_assigned_plants.first.id }}">
        {% else %}
            <!-- If user has multiple plants, show the dropdown from the form -->
            {{ form.plant }}
        {% endif %}

        {% if form.plant.errors %}
          <div class="text-danger">{{ form.plant.errors }}</div>
        {% endif %}
    </div>
    
    <!-- Zone Field -->
    <div class="col-md-3 mb-3">
        <label for="id_zone">Zone</label>
        
        {% if user_assigned_zones.count == 1 %}
            <input type="text" class="form-control" 
                   value="{{ user_assigned_zones.first.name }} ({{ user_assigned_zones.first.code }})" 
                   readonly style="background-color: #e9ecef;">
            <input type="hidden" name="zone" id="id_zone_hidden" value="{{ user_assigned_zones.first.id }}">
        {% else %}
            {{ form.zone }}
        {% endif %}

        {% if form.zone.errors %}
          <div class="text-danger">{{ form.zone.errors }}</div>
        {% endif %}
    </div>
    
    <!-- Location Field -->
    <div class="col-md-3 mb-3">
        <label for="id_location">Location <span class="text-danger">*</span></label>
        
        {% if user_assigned_locations.count == 1 %}
            <input type="text" class="form-control" 
                   value="{{ user_assigned_locations.first.name }} ({{ user_assigned_locations.first.code }})" 
                   readonly style="background-color: #e9ecef;">
            <input type="hidden" name="location" id="id_location_hidden" value="{{ user_assigned_locations.first.id }}">
        {% else %}
            {{ form.location }}
        {% endif %}

        {% if form.location.errors %}
          <div class="text-danger">{{ form.location.errors }}</div>
        {% endif %}
    </div>
    
    <!-- Sub-Location Field -->
    <div class="col-md-3 mb-3">
        <label for="id_sublocation">Sub-Location</label>
        
        {% if user_assigned_sublocations.count == 1 %}
            <input type="text" class="form-control" 
                   value="{{ user_assigned_sublocations.first.name }}{% if user_assigned_sublocations.first.code %} ({{ user_assigned_sublocations.first.code }}){% endif %}" 
                   readonly style="background-color: #e9ecef;">
            <input type="hidden" name="sublocation" id="id_sublocation_hidden" value="{{ user_assigned_sublocations.first.id }}">
        {% else %}
            <!-- For update form, we directly render the form field which is populated by form's __init__ -->
            {{ form.sublocation }}
        {% endif %}

        {% if form.sublocation.errors %}
          <div class="text-danger">{{ form.sublocation.errors }}</div>
        {% endif %}
    </div>
</div>
          <!-- Additional Location Details -->
          <div class="row mt-3">
            <div class="col-md-12 mb-3">
              <label for="id_additional_location_details">Additional Location Details</label>
              <textarea name="additional_location_details" id="id_additional_location_details" class="form-control" rows="3" placeholder="Specific area, equipment, or landmark near the hazard">{{ incident.additional_location_details }}</textarea>
              <small class="form-text text-muted">Optional: Provide specific details about the exact location (e.g., "Near conveyor belt #3", "Next to chemical storage tank")</small>
            </div>
          </div>

          <hr>

          <!-- Incident Details -->
          <h5 class="mb-3"><i class="fas fa-file-alt mr-2"></i>Incident Details</h5>
          
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="{{ form.description.id_for_label }}">Detailed Description <span class="text-danger">*</span></label>
              {{ form.description }}
              <small class="form-text text-muted">Describe what happened in detail, sequence of events, and circumstances</small>
              {% if form.description.errors %}
                <div class="text-danger">{{ form.description.errors }}</div>
              {% endif %}
            </div>
          </div>

          <hr>

          <!-- Unsafe Acts and Unsafe Conditions Section -->
          <div id="unsafeActsConditionsSection">
            <h5 class="mb-3"><i class="fas fa-exclamation-triangle mr-2"></i>Unsafe Acts & Unsafe Conditions</h5>
            
            <div class="alert alert-warning">
              <i class="fas fa-info-circle mr-2"></i>
              <strong>Note:</strong> Select all applicable unsafe acts and/or unsafe conditions that contributed to this incident.
            </div>

            <div class="row">
              <!-- Unsafe Acts -->
              <div class="col-md-6">
                <div class="unsafe-section">
                  <h6><i class="fas fa-user-times mr-2"></i>Unsafe Act (Tick one or combination)</h6>
                  <div class="unsafe-checkbox-grid">
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Operating Equipment without authority" id="ua1">
                        <label class="form-check-label" for="ua1">Operating Equipment without authority</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Failure to warn / Secure" id="ua2">
                        <label class="form-check-label" for="ua2">Failure to warn / Secure</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Operating at unsafe speed" id="ua3">
                        <label class="form-check-label" for="ua3">Operating at unsafe speed</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Bi-passing safety devices/ Interlocks" id="ua4">
                        <label class="form-check-label" for="ua4">Bi-passing safety devices/ Interlocks</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Using unsafe equipment" id="ua5">
                        <label class="form-check-label" for="ua5">Using unsafe equipment</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Unsafe loading/unloading/Lifting" id="ua6">
                        <label class="form-check-label" for="ua6">Unsafe loading/unloading/Lifting</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Improper position for task" id="ua7">
                        <label class="form-check-label" for="ua7">Improper position for task</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Taking unsafe positions or postures" id="ua8">
                        <label class="form-check-label" for="ua8">Taking unsafe positions or postures</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Working on dangerous or moving equipment" id="ua9">
                        <label class="form-check-label" for="ua9">Working on dangerous or moving equipment</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Failure to use PPE" id="ua10">
                        <label class="form-check-label" for="ua10">Failure to use PPE</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Horse play / Improper personal behavior" id="ua11">
                        <label class="form-check-label" for="ua11">Horse play / Improper personal behavior</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Servicing equipment while in operation" id="ua12">
                        <label class="form-check-label" for="ua12">Servicing equipment while in operation</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-act-checkbox" type="checkbox" name="unsafe_act" value="Other (explain)" id="ua13">
                        <label class="form-check-label" for="ua13">Other (explain)</label>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Other explanation text box for Unsafe Acts -->
                  <div class="other-explanation-box" id="unsafeActsOtherBox">
                    <label for="unsafe_acts_other">Please explain:</label>
                    <textarea class="form-control" id="unsafe_acts_other" name="unsafe_acts_other" rows="2" placeholder="Explain the other unsafe act...">{{ incident.unsafe_acts_other }}</textarea>
                  </div>
                </div>
              </div>

              <!-- Unsafe Conditions -->
              <div class="col-md-6">
                <div class="unsafe-section">
                  <h6><i class="fas fa-hard-hat mr-2"></i>Unsafe Condition (Tick one or combination)</h6>
                  <div class="unsafe-checkbox-grid">
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Inadequate guards/ barriers" id="uc1">
                        <label class="form-check-label" for="uc1">Inadequate guards/ barriers</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Defective conditions of machines, tools, equipment" id="uc2">
                        <label class="form-check-label" for="uc2">Defective conditions of machines, tools, equipment</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Unsafe design or construction" id="uc3">
                        <label class="form-check-label" for="uc3">Unsafe design or construction</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Inadequate illumination" id="uc4">
                        <label class="form-check-label" for="uc4">Inadequate illumination</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Inadequate ventilation" id="uc5">
                        <label class="form-check-label" for="uc5">Inadequate ventilation</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Poor housekeeping" id="uc6">
                        <label class="form-check-label" for="uc6">Poor housekeeping</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Non-provision of PPE" id="uc7">
                        <label class="form-check-label" for="uc7">Non-provision of PPE</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Slippery floors" id="uc8">
                        <label class="form-check-label" for="uc8">Slippery floors</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Broken/Uneven floors" id="uc9">
                        <label class="form-check-label" for="uc9">Broken/Uneven floors</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Absence of hand rails" id="uc10">
                        <label class="form-check-label" for="uc10">Absence of hand rails</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Exposure to excessive noise" id="uc11">
                        <label class="form-check-label" for="uc11">Exposure to excessive noise</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Congested or restricted work areas" id="uc12">
                        <label class="form-check-label" for="uc12">Congested or restricted work areas</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Extreme temperature" id="uc13">
                        <label class="form-check-label" for="uc13">Extreme temperature</label>
                      </div>
                    </div>
                    <div class="unsafe-checkbox-item">
                      <div class="form-check">
                        <input class="form-check-input unsafe-condition-checkbox" type="checkbox" name="unsafe_condition" value="Other (explain)" id="uc14">
                        <label class="form-check-label" for="uc14">Other (explain)</label>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Other explanation text box for Unsafe Conditions -->
                  <div class="other-explanation-box" id="unsafeConditionsOtherBox">
                    <label for="unsafe_conditions_other">Please explain:</label>
                    <textarea class="form-control" id="unsafe_conditions_other" name="unsafe_conditions_other" rows="2" placeholder="Explain the other unsafe condition...">{{ incident.unsafe_conditions_other }}</textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <hr>

          <!-- ===== NEW AFFECTED PERSON SECTION WITH MANUAL ENTRY ===== -->
          <div class="affected-person-section">
            <h5><i class="fas fa-user-injured mr-2"></i>Affected Person Information (Manual Entry)</h5>
            
            <div class="alert alert-info mb-3">
              <i class="fas fa-info-circle mr-2"></i>
              <strong>Note:</strong> Update affected person details. All fields marked with <span class="text-danger">*</span> are mandatory.
            </div>

            <!-- Row 1: Employment Category -->
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="id_affected_employment_category">Employment Category <span class="text-danger">*</span></label>
                <select name="affected_employment_category" id="id_affected_employment_category" class="form-control" required>
                  <option value="">-- Select Employment Category --</option>
                  <option value="PERMANENT" {% if incident.affected_employment_category == 'PERMANENT' %}selected{% endif %}>Permanent</option>
                  <option value="CONTRACT" {% if incident.affected_employment_category == 'CONTRACT' %}selected{% endif %}>Contract</option>
                  <!-- <option value="ON_ROLL" {% if incident.affected_employment_category == 'ON_ROLL' %}selected{% endif %}>On Roll</option> -->
                </select>
                <small class="form-text text-muted">Select the employment category</small>
              </div>
            </div>

            <!-- Row 2: Name, Employee ID, Department -->
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="id_affected_person_name">Name of Affected Person <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="id_affected_person_name" name="affected_person_name" 
                       value="{{ incident.affected_person_name }}" placeholder="Enter full name" required maxlength="200">
                <small class="form-text text-muted">Enter the full name of affected person</small>
              </div>
              
              <div class="col-md-4 mb-3">
                <label for="id_affected_person_employee_id">Employee ID <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="id_affected_person_employee_id" name="affected_person_employee_id" 
                       value="{{ incident.affected_person_employee_id }}" placeholder="Enter employee ID" required maxlength="50">
                <small class="form-text text-muted">Enter the employee identification number</small>
              </div>
              
              <div class="col-md-4 mb-3">
                <label for="id_affected_person_department">Department <span class="text-danger">*</span></label>
                <select name="affected_person_department" id="id_affected_person_department" class="form-control" required>
                  <option value="">-- Select Department --</option>
                  {% for department in departments %}
                    <option value="{{ department.id }}" {% if incident.affected_person_department and department.id == incident.affected_person_department.id %}selected{% endif %}>
                      {{ department.name }}
                    </option>
                  {% endfor %}
                </select>
                <small class="form-text text-muted">Select the department from master list</small>
              </div>
            </div>

            <!-- Row 3: Date of Birth, Gender, Age (Auto-calculated) -->
            <div class="row">
              <div class="col-md-4 mb-3">
                <label for="id_affected_date_of_birth">Date of Birth <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="id_affected_date_of_birth" name="affected_date_of_birth" 
                       value="{{ incident.affected_date_of_birth|date:'Y-m-d' }}" required>
                <small class="form-text text-muted">Select the date of birth</small>
              </div>
              
              <div class="col-md-4 mb-3">
                <label for="id_affected_gender">Gender <span class="text-danger">*</span></label>
                <select name="affected_gender" id="id_affected_gender" class="form-control" required>
                  <option value="">-- Select Gender --</option>
                  <option value="MALE" {% if incident.affected_gender == 'MALE' %}selected{% endif %}>Male</option>
                  <option value="FEMALE" {% if incident.affected_gender == 'FEMALE' %}selected{% endif %}>Female</option>
                  <option value="OTHER" {% if incident.affected_gender == 'OTHER' %}selected{% endif %}>Other</option>
                  <option value="PREFER_NOT_TO_SAY" {% if incident.affected_gender == 'PREFER_NOT_TO_SAY' %}selected{% endif %}>Prefer not to say</option>
                </select>
                <small class="form-text text-muted">Select gender</small>
              </div>
              
              <div class="col-md-4 mb-3">
                <label for="id_affected_age">Age</label>
                <input type="number" class="form-control readonly-field" id="id_affected_age" name="affected_age" 
                       value="{{ incident.affected_age }}" placeholder="Calculated automatically" readonly>
                <small class="form-text text-muted">Age is calculated automatically from date of birth</small>
              </div>
            </div>

            <!-- Row 4: Job Title, Date of Joining -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="id_affected_job_title">Job Title <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="id_affected_job_title" name="affected_job_title" 
                       value="{{ incident.affected_job_title }}" placeholder="Enter job title" required maxlength="100">
                <small class="form-text text-muted">Enter the job title or designation</small>
              </div>
              
              <div class="col-md-6 mb-3">
                <label for="id_affected_date_of_joining">Date of Joining <span class="text-danger">*</span></label>
                <input type="date" class="form-control" id="id_affected_date_of_joining" name="affected_date_of_joining" 
                       value="{{ incident.affected_date_of_joining|date:'Y-m-d' }}" required>
                <small class="form-text text-muted">Select the date of joining</small>
              </div>
            </div>
          </div>
          <!-- ===== END OF NEW AFFECTED PERSON SECTION ===== -->

          <hr>
          
          <!-- Body Parts Section -->
          <div id="bodyPartsSection" style="{% if incident.incident_type == 'LTI' or incident.incident_type == 'MTC' or incident.incident_type == 'FA' or incident.incident_type == 'HLFI' or incident.incident_type == 'FATALITY' %}display: block;{% else %}display: none;{% endif %}">
            {% include 'accidents/body_diagram_interactive.html' %}
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="{{ form.nature_of_injury.id_for_label }}">Nature of Injury <span class="text-danger">*</span></label>
              {{ form.nature_of_injury }}
              <small class="form-text text-muted">Required: Describe the type and extent of injury (e.g., cut, fracture, burn)</small>
              {% if form.nature_of_injury.errors %}
                <div class="text-danger">{{ form.nature_of_injury.errors }}</div>
              {% endif %}
            </div>
          </div>

          <hr>

          <!-- Photo Attachments -->
          <h5 class="mb-3"><i class="fas fa-camera mr-2"></i>Photo Evidence</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="photos">Upload Photos (if any)</label>
              <input type="file" class="form-control-file" id="photos" name="photos" multiple accept="image/*">
              <small class="form-text text-muted">Multiple photos can be selected. Supported formats: JPG, PNG</small>
            </div>
          </div>
          
          {% if incident.photos.all %}
          <div class="row">
            <div class="col-md-12 mb-3">
              <label>Existing Photos:</label>
              <div class="d-flex flex-wrap">
                {% for photo in incident.photos.all %}
                  <div class="mr-2 mb-2">
                    <img src="{{ photo.photo.url }}" alt="Incident photo" style="width: 100px; height: 100px; object-fit: cover; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onclick="window.open('{{ photo.photo.url }}', '_blank')">
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
          {% endif %}

          <hr>

          <!-- Reporting Information -->
          <h5 class="mb-3"><i class="fas fa-user-edit mr-2"></i>Reporting Information</h5>
          <div class="row">
              <div class="col-md-6 mb-3">
                  <label>Reported By</label>
                  <input type="text" class="form-control" value="{{ incident.reported_by.get_full_name|default:incident.reported_by.username }}" readonly style="background-color: #e9ecef;">
              </div>
              <div class="col-md-6 mb-3">
                  <label>Reported Date</label>
                  <input type="text" class="form-control" value="{{ incident.reported_date|date:'d/m/Y H:i' }}" readonly style="background-color: #e9ecef;">
              </div>
          </div>

          <hr>
        </div>
        
        <div class="card-footer">
          <button type="submit" class="btn btn-primary btn-lg">
            <i class="fas fa-save mr-2"></i>Update Incident Report
          </button>
          <a href="{% url 'accidents:incident_detail' incident.pk %}" class="btn btn-secondary btn-lg ml-2">
            <i class="fas fa-times mr-2"></i>Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const plantSelect = document.getElementById('id_plant');
    const zoneSelect = document.getElementById('id_zone');
    const locationSelect = document.getElementById('id_location');
    const sublocationSelect = document.getElementById('id_sublocation');
    const incidentTypeSelect = document.getElementById('id_incident_type');
    const bodyPartsSection = document.getElementById('bodyPartsSection');
    const natureOfInjuryField = document.getElementById('id_nature_of_injury');
    
    // Age calculation fields
    const dateOfBirthField = document.getElementById('id_affected_date_of_birth');
    const ageField = document.getElementById('id_affected_age');
    
    // Function to calculate age from date of birth
    function calculateAge(dateOfBirth) {
        if (!dateOfBirth) return '';
        
        const today = new Date();
        const birthDate = new Date(dateOfBirth);
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        
        return age >= 0 ? age : '';
    }
    
    // Auto-calculate age when date of birth changes
    dateOfBirthField.addEventListener('change', function() {
        const age = calculateAge(this.value);
        ageField.value = age;
    });
    
    // Initialize selected body parts from existing data
    window.selectedBodyParts = new Set({{ incident.affected_body_parts|default:"[]"|safe }});
    
    // Initialize unsafe acts and conditions from existing data
    const existingUnsafeActs = {{ incident.unsafe_acts|default:"[]"|safe }};
    const existingUnsafeConditions = {{ incident.unsafe_conditions|default:"[]"|safe }};
    
    // Pre-check existing unsafe acts
    existingUnsafeActs.forEach(act => {
        const checkbox = document.querySelector(`.unsafe-act-checkbox[value="${act}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // Pre-check existing unsafe conditions
    existingUnsafeConditions.forEach(condition => {
        const checkbox = document.querySelector(`.unsafe-condition-checkbox[value="${condition}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    // Check if "Other" is selected for unsafe acts and show text field
    if (existingUnsafeActs.includes('Other (explain)')) {
        document.getElementById('unsafeActsOtherBox').classList.add('show');
    }
    
    // Check if "Other" is selected for unsafe conditions and show text field
    if (existingUnsafeConditions.includes('Other (explain)')) {
        document.getElementById('unsafeConditionsOtherBox').classList.add('show');
    }
    
    // Load zones when plant is selected
    if (plantSelect) {
        plantSelect.addEventListener('change', function() {
            const plantId = this.value;
            
            if (plantId) {
                fetch(`{% url 'accidents:ajax_get_zones' %}?plant_id=${plantId}`)
                    .then(response => response.json())
                    .then(data => {
                        zoneSelect.innerHTML = '<option value="">Select a zone</option>';
                        locationSelect.innerHTML = '<option value="">Select a zone first</option>';
                        sublocationSelect.innerHTML = '<option value="">Select a location first</option>';
                        
                        if (data.length === 0) {
                            zoneSelect.innerHTML = '<option value="">No zones available</option>';
                        } else {
                            data.forEach(zone => {
                                const option = document.createElement('option');
                                option.value = zone.id;
                                option.textContent = `${zone.name} (${zone.code})`;
                                if (zone.id == {{ incident.zone.id|default:'null' }}) {
                                    option.selected = true;
                                }
                                zoneSelect.appendChild(option);
                            });
                            
                            if (zoneSelect.value) {
                                zoneSelect.dispatchEvent(new Event('change'));
                            }
                        }
                    })
                    .catch(error => console.error('Error loading zones:', error));
            }
        });
    }
    
    // Load locations when zone is selected
    if (zoneSelect) {
        zoneSelect.addEventListener('change', function() {
            const zoneId = this.value;
            
            if (zoneId) {
                fetch(`{% url 'accidents:ajax_get_locations' %}?zone_id=${zoneId}`)
                    .then(response => response.json())
                    .then(data => {
                        locationSelect.innerHTML = '<option value="">Select a location</option>';
                        sublocationSelect.innerHTML = '<option value="">Select a location first</option>';
                        
                        if (data.length === 0) {
                            locationSelect.innerHTML = '<option value="">No locations available</option>';
                        } else {
                            data.forEach(location => {
                                const option = document.createElement('option');
                                option.value = location.id;
                                option.textContent = `${location.name} (${location.code})`;
                                if (location.id == {{ incident.location.id|default:'null' }}) {
                                    option.selected = true;
                                }
                                locationSelect.appendChild(option);
                            });
                            
                            if (locationSelect.value) {
                                locationSelect.dispatchEvent(new Event('change'));
                            }
                        }
                    })
                    .catch(error => console.error('Error loading locations:', error));
            }
        });
    }
    
    // Load sublocations when location is selected
    if (locationSelect) {
        locationSelect.addEventListener('change', function() {
            const locationId = this.value;
            
            if (locationId) {
                fetch(`{% url 'accidents:ajax_get_sublocations' %}?location_id=${locationId}`)
                    .then(response => response.json())
                    .then(data => {
                        sublocationSelect.innerHTML = '<option value="">-- Select Sub-Location --</option>';
                        
                        if (data.length > 0) {
                            data.forEach(sublocation => {
                                const option = document.createElement('option');
                                option.value = sublocation.id;
                                option.textContent = sublocation.code ? 
                                    `${sublocation.name} (${sublocation.code})` : 
                                    sublocation.name;
                                if (sublocation.id == {{ incident.sublocation.id|default:'null' }}) {
                                    option.selected = true;
                                }
                                sublocationSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => console.error('Error loading sublocations:', error));
            }
        });
    }
    
    // Show/hide body parts based on incident type
    incidentTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        if (selectedType === 'LTI' || selectedType === 'MTC' || selectedType === 'FA' || selectedType === 'HLFI' || selectedType === 'FATALITY') {
            bodyPartsSection.style.display = 'block';
            natureOfInjuryField.setAttribute('required', 'required');
        } else {
            bodyPartsSection.style.display = 'none';
            natureOfInjuryField.removeAttribute('required');
        }
    });
    
    // Unsafe Acts - Show/hide "Other" explanation box
    const unsafeActOtherCheckbox = document.getElementById('ua13');
    const unsafeActsOtherBox = document.getElementById('unsafeActsOtherBox');
    
    unsafeActOtherCheckbox.addEventListener('change', function() {
        if (this.checked) {
            unsafeActsOtherBox.classList.add('show');
        } else {
            unsafeActsOtherBox.classList.remove('show');
            document.getElementById('unsafe_acts_other').value = '';
        }
    });
    
    // Unsafe Conditions - Show/hide "Other" explanation box
    const unsafeConditionOtherCheckbox = document.getElementById('uc14');
    const unsafeConditionsOtherBox = document.getElementById('unsafeConditionsOtherBox');
    
    unsafeConditionOtherCheckbox.addEventListener('change', function() {
        if (this.checked) {
            unsafeConditionsOtherBox.classList.add('show');
        } else {
            unsafeConditionsOtherBox.classList.remove('show');
            document.getElementById('unsafe_conditions_other').value = '';
        }
    });
    
    // Form submission
    document.getElementById('incidentForm').addEventListener('submit', function(e) {
        // Validate nature of injury if incident type requires it
        const selectedType = incidentTypeSelect.value;
        if ((selectedType === 'LTI' || selectedType === 'MTC' || selectedType === 'FA' || selectedType === 'HLFI' || selectedType === 'FATALITY') 
            && !natureOfInjuryField.value.trim()) {
            e.preventDefault();
            alert('Nature of Injury is required for this type of incident.');
            natureOfInjuryField.focus();
            return false;
        }
        
        // Validate age is calculated
        if (!ageField.value) {
            e.preventDefault();
            alert('Please select a valid Date of Birth to calculate age.');
            dateOfBirthField.focus();
            return false;
        }
        
        // Save body parts as JSON
        const bodyPartsInput = document.getElementById('affectedBodyPartsJson');
        if (window.selectedBodyParts && window.selectedBodyParts.size > 0) {
            bodyPartsInput.value = JSON.stringify(Array.from(window.selectedBodyParts));
        } else {
            bodyPartsInput.value = '[]';
        }
        
        // Save unsafe acts as JSON
        const unsafeActs = [];
        document.querySelectorAll('.unsafe-act-checkbox:checked').forEach(checkbox => {
            unsafeActs.push(checkbox.value);
        });
        document.getElementById('unsafeActsJson').value = JSON.stringify(unsafeActs);
        
        // Save unsafe conditions as JSON
        const unsafeConditions = [];
        document.querySelectorAll('.unsafe-condition-checkbox:checked').forEach(checkbox => {
            unsafeConditions.push(checkbox.value);
        });
        document.getElementById('unsafeConditionsJson').value = JSON.stringify(unsafeConditions);
    });
    
    // Trigger plant change to load initial zones and locations
    if (plantSelect && plantSelect.value) {
        plantSelect.dispatchEvent(new Event('change'));
    }
});
</script>
{% endblock %}