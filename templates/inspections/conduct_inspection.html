{% extends 'base/base.html' %}
{% load static %}

{% block title %}Conduct Inspection{% endblock %}
{% block page_title %}Conduct Safety Inspection{% endblock %}

{% block extra_css %}
<style>
/* Inspection Category Sections */
.inspection-category-section {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    background-color: #ffffff;
    margin-bottom: 25px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.inspection-category-section h6 {
    color: #2c3e50;
    font-weight: 700;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 3px solid #dc3545;
    font-size: 1.1rem;
}

/* Inspection Point Item */
.inspection-point-item {
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 15px;
    background-color: #f8f9fa;
    transition: all 0.2s;
}

.inspection-point-item:hover {
    border-color: #dc3545;
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.15);
}

.inspection-point-text {
    font-size: 0.95rem;
    color: #495057;
    font-weight: 500;
    margin-bottom: 10px;
    line-height: 1.5;
}

/* Response Radio Buttons */
.response-options {
    display: flex;
    gap: 20px;
    margin-bottom: 10px;
}

.response-radio {
    display: flex;
    align-items: center;
}

.response-radio input[type="radio"] {
    width: 20px;
    height: 20px;
    margin-right: 8px;
    cursor: pointer;
}

.response-radio label {
    margin-bottom: 0;
    cursor: pointer;
    font-weight: 500;
    font-size: 0.95rem;
}

.response-radio.yes label {
    color: #28a745;
}

.response-radio.no label {
    color: #dc3545;
}

.response-radio.na label {
    color: #6c757d;
}

/* Remarks Field */
.remarks-field {
    margin-top: 10px;
    display: none;
}

.remarks-field.show {
    display: block;
}

.remarks-field textarea {
    min-height: 80px;
    border: 1px solid #ced4da;
    border-radius: 5px;
    padding: 10px;
    font-size: 0.9rem;
}

.remarks-field textarea:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
}

/* Photo Upload Section */
.photo-upload-section {
    margin-top: 10px;
    padding: 10px;
    background-color: #fff;
    border: 1px dashed #ced4da;
    border-radius: 5px;
}

.photo-upload-section input[type="file"] {
    font-size: 0.9rem;
}

/* Progress Indicator */
.inspection-progress {
    position: sticky;
    top: 70px;
    background-color: #fff;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 20px;
    z-index: 100;
}

.progress-stats {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
}

.progress-stats span {
    font-size: 0.9rem;
    font-weight: 600;
}

.progress {
    height: 25px;
    border-radius: 5px;
}

.progress-bar {
    font-size: 0.85rem;
    font-weight: 600;
}

/* Alert boxes */
.alert-info {
    background-color: #d1ecf1;
    border-color: #bee5eb;
    color: #0c5460;
}

/* Responsive */
@media (max-width: 768px) {
    .response-options {
        flex-direction: column;
        gap: 10px;
    }
    
    .inspection-progress {
        position: relative;
        top: 0;
    }
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'inspections:dashboard' %}">Inspection Management</a></li>
<li class="breadcrumb-item active">Conduct Inspection</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="ehs-card">
      <div class="card-header bg-info text-white">
        <h3 class="card-title mb-0">
          <i class="fas fa-clipboard-check mr-2"></i>{{ template.template_name }}
        </h3>
      </div>
      
      <form method="POST" id="inspectionForm" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="inspection_responses_json" id="inspectionResponsesJson">
        
        <div class="card-body">
          <!-- Alert Info -->
          <div class="alert alert-info">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Note:</strong> Please complete all inspection points. Any "No" response will automatically generate a finding for corrective action.
            All fields marked with <span class="text-danger">*</span> are mandatory.
          </div>

          <!-- Progress Indicator -->
          <div class="inspection-progress">
            <div class="progress-stats">
              <span><i class="fas fa-check-circle text-success mr-1"></i>Completed: <span id="completedCount">0</span> / <span id="totalCount">{{ total_points }}</span></span>
              <span><i class="fas fa-percent text-info mr-1"></i>Progress: <span id="progressPercent">0</span>%</span>
            </div>
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" 
                   id="progressBar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                0%
              </div>
            </div>
          </div>

          <!-- Inspection Information -->
          <h5 class="mb-3"><i class="fas fa-info-circle mr-2"></i>Inspection Information</h5>
          <div class="row">
            <div class="col-md-3 mb-3">
              <label>Plant</label>
              <input type="text" class="form-control" value="{{ user.plant.name }} ({{ user.plant.code }})" readonly>
            </div>
            <div class="col-md-3 mb-3">
              <label>Location</label>
              <input type="text" class="form-control" value="{{ user.location.name }}" readonly>
            </div>
            <div class="col-md-3 mb-3">
              <label for="{{ form.inspection_date.id_for_label }}">Inspection Date <span class="text-danger">*</span></label>
              {{ form.inspection_date }}
              {% if form.inspection_date.errors %}
                <div class="text-danger">{{ form.inspection_date.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-3 mb-3">
              <label>Conducted By</label>
              <input type="text" class="form-control" value="{{ user.get_full_name }}" readonly>
            </div>
          </div>

          <hr>

          <!-- Inspection Checklist by Category -->
          <h5 class="mb-3"><i class="fas fa-list-check mr-2"></i>Inspection Checklist</h5>
          
          {% for category in categories %}
          <div class="inspection-category-section" id="category-{{ category.id }}">
            <h6>
              <i class="fas fa-folder-open mr-2"></i>{{ category.category_name }}
              <span class="badge badge-secondary float-right">{{ category.inspection_points.count }} Points</span>
            </h6>
            
            {% for point in category.inspection_points.all %}
            <div class="inspection-point-item" data-point-id="{{ point.id }}">
              <div class="inspection-point-text">
                <span class="badge badge-light mr-2">{{ forloop.counter }}</span>
                {{ point.inspection_point_text }}
                {% if point.is_mandatory %}
                <span class="text-danger">*</span>
                {% endif %}
              </div>
              
              <!-- Response Options -->
              <div class="response-options">
                <div class="response-radio yes">
                  <input type="radio" 
                         name="response_{{ point.id }}" 
                         id="yes_{{ point.id }}" 
                         value="YES"
                         data-point-id="{{ point.id }}"
                         class="response-input"
                         {% if point.is_mandatory %}required{% endif %}>
                  <label for="yes_{{ point.id }}">
                    <i class="fas fa-check-circle mr-1"></i>Yes
                  </label>
                </div>
                
                <div class="response-radio no">
                  <input type="radio" 
                         name="response_{{ point.id }}" 
                         id="no_{{ point.id }}" 
                         value="NO"
                         data-point-id="{{ point.id }}"
                         class="response-input"
                         {% if point.is_mandatory %}required{% endif %}>
                  <label for="no_{{ point.id }}">
                    <i class="fas fa-times-circle mr-1"></i>No
                  </label>
                </div>
                
                <div class="response-radio na">
                  <input type="radio" 
                         name="response_{{ point.id }}" 
                         id="na_{{ point.id }}" 
                         value="NA"
                         data-point-id="{{ point.id }}"
                         class="response-input">
                  <label for="na_{{ point.id }}">
                    <i class="fas fa-minus-circle mr-1"></i>N/A
                  </label>
                </div>
              </div>
              
              <!-- Remarks Field (shows when No is selected) -->
              <div class="remarks-field" id="remarks_{{ point.id }}">
                <label for="remarks_text_{{ point.id }}">
                  <i class="fas fa-comment mr-1"></i>Remarks / Action Required <span class="text-danger">*</span>
                </label>
                <textarea class="form-control" 
                          id="remarks_text_{{ point.id }}" 
                          name="remarks_{{ point.id }}"
                          placeholder="Please describe the issue and action required..."
                          rows="3"></textarea>
              </div>
              
              <!-- Photo Upload (optional) -->
              {% if point.requires_photo %}
              <div class="photo-upload-section">
                <label>
                  <i class="fas fa-camera mr-1"></i>Photo Evidence (Required)
                  <span class="text-danger">*</span>
                </label>
                <input type="file" 
                       class="form-control-file" 
                       name="photo_{{ point.id }}"
                       accept="image/*"
                       multiple>
                <small class="form-text text-muted">Upload up to 3 photos for this inspection point</small>
              </div>
              {% else %}
              <div class="photo-upload-section" style="display: none;" id="photo_section_{{ point.id }}">
                <label>
                  <i class="fas fa-camera mr-1"></i>Photo Evidence (Optional)
                </label>
                <input type="file" 
                       class="form-control-file" 
                       name="photo_{{ point.id }}"
                       accept="image/*"
                       multiple>
                <small class="form-text text-muted">Upload photos if needed (up to 3)</small>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endfor %}

          <hr>

          <!-- Additional Comments -->
          <h5 class="mb-3"><i class="fas fa-comments mr-2"></i>Additional Comments</h5>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="overall_comments">Overall Observations / Comments</label>
              <textarea class="form-control" 
                        id="overall_comments" 
                        name="overall_comments"
                        placeholder="Any additional observations or comments about the inspection..."
                        rows="4"></textarea>
            </div>
          </div>

        </div>
        
        <div class="card-footer">
          <button type="button" class="btn btn-secondary btn-lg" id="saveDraftBtn">
            <i class="fas fa-save mr-2"></i>Save as Draft
          </button>
          <button type="submit" class="btn btn-info btn-lg ml-2" id="submitBtn">
            <i class="fas fa-paper-plane mr-2"></i>Submit Inspection
          </button>
          <a href="{% url 'inspections:schedule_list' %}" class="btn btn-outline-secondary btn-lg ml-2">
            <i class="fas fa-times mr-2"></i>Cancel
          </a>
          
          <div class="float-right">
            <span class="badge badge-info p-2" style="font-size: 1rem;">
              <i class="fas fa-clipboard-list mr-1"></i>
              Total Points: {{ total_points }}
            </span>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const totalPoints = {{ total_points }};
    let completedPoints = 0;
    const inspectionResponses = {};
    
    // Update progress
    function updateProgress() {
        completedPoints = Object.keys(inspectionResponses).length;
        const percentage = Math.round((completedPoints / totalPoints) * 100);
        
        document.getElementById('completedCount').textContent = completedPoints;
        document.getElementById('progressPercent').textContent = percentage;
        document.getElementById('progressBar').style.width = percentage + '%';
        document.getElementById('progressBar').textContent = percentage + '%';
        document.getElementById('progressBar').setAttribute('aria-valuenow', percentage);
    }
    
    // Handle response selection
    document.querySelectorAll('.response-input').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const pointId = this.getAttribute('data-point-id');
            const response = this.value;
            const remarksField = document.getElementById('remarks_' + pointId);
            const remarksTextarea = document.getElementById('remarks_text_' + pointId);
            const photoSection = document.getElementById('photo_section_' + pointId);
            
            // Store response
            if (!inspectionResponses[pointId]) {
                inspectionResponses[pointId] = {};
            }
            inspectionResponses[pointId].response = response;
            inspectionResponses[pointId].point_id = pointId;
            
            // Show/hide remarks based on response
            if (response === 'NO') {
                remarksField.classList.add('show');
                remarksTextarea.setAttribute('required', 'required');
                if (photoSection) {
                    photoSection.style.display = 'block';
                }
            } else {
                remarksField.classList.remove('show');
                remarksTextarea.removeAttribute('required');
                remarksTextarea.value = '';
                if (photoSection) {
                    photoSection.style.display = 'none';
                }
            }
            
            updateProgress();
            
            // Scroll to next unanswered question
            scrollToNextUnanswered();
        });
    });
    
    // Handle remarks input
    document.querySelectorAll('[id^="remarks_text_"]').forEach(function(textarea) {
        textarea.addEventListener('input', function() {
            const pointId = this.id.replace('remarks_text_', '');
            if (inspectionResponses[pointId]) {
                inspectionResponses[pointId].remarks = this.value;
            }
        });
    });
    
    // Scroll to next unanswered question
    function scrollToNextUnanswered() {
        const allPoints = document.querySelectorAll('.inspection-point-item');
        for (let item of allPoints) {
            const pointId = item.getAttribute('data-point-id');
            if (!inspectionResponses[pointId] || !inspectionResponses[pointId].response) {
                item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                break;
            }
        }
    }
    
    // Save as Draft
    document.getElementById('saveDraftBtn').addEventListener('click', function() {
        if (confirm('Save inspection as draft? You can continue later.')) {
            document.getElementById('inspectionResponsesJson').value = JSON.stringify(inspectionResponses);
            // Add draft indicator
            const draftInput = document.createElement('input');
            draftInput.type = 'hidden';
            draftInput.name = 'save_as_draft';
            draftInput.value = 'true';
            document.getElementById('inspectionForm').appendChild(draftInput);
            document.getElementById('inspectionForm').submit();
        }
    });
    
    // Submit form
    document.getElementById('inspectionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate all mandatory points are answered
        if (completedPoints < totalPoints) {
            alert(`Please complete all inspection points. ${completedPoints} of ${totalPoints} completed.`);
            scrollToNextUnanswered();
            return false;
        }
        
        // Validate all "No" responses have remarks
        let allRemarksValid = true;
        document.querySelectorAll('.response-input:checked').forEach(function(radio) {
            if (radio.value === 'NO') {
                const pointId = radio.getAttribute('data-point-id');
                const remarksTextarea = document.getElementById('remarks_text_' + pointId);
                if (!remarksTextarea.value.trim()) {
                    allRemarksValid = false;
                    remarksTextarea.focus();
                    remarksTextarea.classList.add('is-invalid');
                }
            }
        });
        
        if (!allRemarksValid) {
            alert('Please provide remarks for all "No" responses.');
            return false;
        }
        
        // Save responses as JSON
        document.getElementById('inspectionResponsesJson').value = JSON.stringify(inspectionResponses);
        
        // Confirm submission
        if (confirm('Submit inspection? This cannot be undone.')) {
            this.submit();
        }
    });
    
    // Set current date
    const dateInput = document.getElementById('id_inspection_date');
    if (!dateInput.value) {
        dateInput.value = new Date().toISOString().split('T')[0];
    }
    
    // Initial progress update
    updateProgress();
});
</script>
{% endblock %}