{% extends 'base/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">
                        <i class="fas fa-times-circle text-danger"></i>
                        Non-Compliant Items
                    </h3>
                    <p class="text-muted mb-0">
                        Inspection questions answered "No" — requiring corrective action
                    </p>
                </div>
                <a href="{% url 'inspections:inspection_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3">
                <div class="text-danger mb-1"><i class="fas fa-times-circle fa-2x"></i></div>
                <h3 class="fw-bold mb-0">{{ total_no_answers }}</h3>
                <small class="text-muted">Total Non-Compliant</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3">
                <div class="text-warning mb-1"><i class="fas fa-star fa-2x"></i></div>
                <h3 class="fw-bold mb-0">{{ critical_no_answers }}</h3>
                <small class="text-muted">Critical Items</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3">
                <div class="text-success mb-1"><i class="fas fa-shield-alt fa-2x"></i></div>
                <h3 class="fw-bold mb-0">{{ converted_hazards_count }}</h3>
                <small class="text-muted">Converted to Hazards</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3">
                <div class="text-info mb-1"><i class="fas fa-clock fa-2x"></i></div>
                <h3 class="fw-bold mb-0">{{ pending_count }}</h3>
                <small class="text-muted">Pending Assignment</small>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card shadow-sm mb-4">
        <div class="card-body py-3">
            <form method="get" class="row g-2 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small fw-bold mb-1">Plant</label>
                    <select name="plant" class="form-select form-select-sm">
                        <option value="">All Plants</option>
                        {% for plant in plants %}
                        <option value="{{ plant.id }}" {% if selected_plant == plant.id|stringformat:"s" %}selected{% endif %}>
                            {{ plant.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold mb-1">Category</label>
                    <select name="category" class="form-select form-select-sm">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.category_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold mb-1">Priority</label>
                    <select name="priority" class="form-select form-select-sm">
                        <option value="">All Items</option>
                        <option value="critical" {% if selected_priority == 'critical' %}selected{% endif %}>Critical Only</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold mb-1">From Date</label>
                    <input type="date" name="date_from" class="form-control form-control-sm" value="{{ date_from|default:'' }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold mb-1">To Date</label>
                    <input type="date" name="date_to" class="form-control form-control-sm" value="{{ date_to|default:'' }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label small fw-bold mb-1">Search</label>
                    <input type="text" name="search" class="form-control form-control-sm"
                           placeholder="Question / Code..." value="{{ search|default:'' }}">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-search"></i> Filter
                    </button>
                    <a href="{% url 'inspections:no_answers_list' %}" class="btn btn-outline-secondary btn-sm ms-2">
                        <i class="fas fa-times"></i> Clear
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Table -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> Non-Compliant Items
                <span class="badge bg-danger ms-2">{{ page_obj.paginator.count }}</span>
            </h5>
            {% if is_admin %}
            <!-- Bulk assign bar — only visible when checkboxes selected -->
            <div id="bulkActionsBar" style="display:none;">
                <span class="text-muted me-3" id="selectedCount">0 selected</span>
                <button type="button" class="btn btn-primary btn-sm" id="openAssignModalBtn">
                    <i class="fas fa-user-check"></i> Assign Selected
                </button>
            </div>
            {% endif %}
        </div>

        <div class="card-body p-0">
            <form id="assignForm" method="POST" action="{% url 'inspections:no_answers_list' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="assign_responses">
                <input type="hidden" name="selected_responses" id="selectedResponsesInput">
                <input type="hidden" name="assigned_to" id="assignedToHidden">
                <input type="hidden" name="assignment_remarks" id="assignmentRemarksHidden">

                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="noAnswersTable">
                        <thead class="table-light">
                            <tr>
                                {% if is_admin %}
                                <th style="width:40px;">
                                    <input type="checkbox" id="selectAll" class="form-check-input" title="Select All">
                                </th>
                                {% endif %}
                                <th>#</th>
                                <th>Question</th>
                                <th>Category</th>
                                <th>Inspection</th>
                                <th>Plant</th>
                                <th>Date</th>
                                <th>Photo</th>
                                <th>Assigned To</th>
                                <th style="width:160px;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for response in page_obj %}
                            <tr id="row-{{ response.id }}"
                                class="{% if response.question.is_critical %}table-warning{% endif %}">

                                {% if is_admin %}
                                <td>
                                    {% if not response.assigned_to and not response.converted_to_hazard %}
                                    <input type="checkbox"
                                           class="form-check-input row-checkbox"
                                           value="{{ response.id }}">
                                    {% endif %}
                                </td>
                                {% endif %}

                                <td>
                                    {{ forloop.counter }}
                                    {% if response.question.is_critical %}
                                    <span class="badge bg-danger ms-1" title="Critical">
                                        <i class="fas fa-star"></i>
                                    </span>
                                    {% endif %}
                                </td>

                                <td>
                                    <strong class="text-primary small">{{ response.question.question_code }}</strong>
                                    <div class="small text-dark mt-1">
                                        {{ response.question.question_text|truncatechars:75 }}
                                    </div>
                                    {% if response.remarks %}
                                    <div class="small text-muted mt-1">
                                        <i class="fas fa-comment text-info"></i>
                                        <em>{{ response.remarks|truncatechars:50 }}</em>
                                    </div>
                                    {% endif %}
                                    {% if response.assignment_remarks %}
                                    <div class="small text-info mt-1">
                                        <i class="fas fa-sticky-note"></i>
                                        <em>{{ response.assignment_remarks|truncatechars:50 }}</em>
                                    </div>
                                    {% endif %}
                                </td>

                                <td>
                                    <span class="badge bg-secondary">
                                        {{ response.question.category.category_name }}
                                    </span>
                                </td>

                                <td>
                                    <strong class="small">{{ response.submission.schedule.schedule_code }}</strong>
                                    <div class="small text-muted">
                                        by {{ response.submission.submitted_by.get_full_name }}
                                    </div>
                                </td>

                                <td>
                                    <small>{{ response.submission.schedule.plant.name }}</small>
                                </td>

                                <td>
                                    <small class="text-muted">
                                        {% if response.answered_at %}
                                            {{ response.answered_at|date:"d M Y" }}
                                        {% else %}
                                            {{ response.submission.schedule.scheduled_date|date:"d M Y" }}
                                        {% endif %}
                                    </small>
                                </td>

                                <td class="text-center">
                                    {% if response.photo %}
                                    <a href="{{ response.photo.url }}" target="_blank">
                                        <img src="{{ response.photo.url }}"
                                             style="width:38px;height:38px;object-fit:cover;border-radius:4px;"
                                             class="border">
                                    </a>
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>

                                <td>
                                    {% if response.assigned_to %}
                                    <div class="small">
                                        <i class="fas fa-user text-success"></i>
                                        <strong>{{ response.assigned_to.get_full_name }}</strong>
                                    </div>
                                    {% if response.assigned_at %}
                                    <div class="small text-muted">
                                        {{ response.assigned_at|date:"d M Y" }}
                                    </div>
                                    {% endif %}
                                    {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="fas fa-clock"></i> Unassigned
                                    </span>
                                    {% endif %}
                                </td>

                                <!-- ACTION COLUMN -->
                                <td>
                                    {% if response.converted_to_hazard %}
                                        <!-- Already converted -->
                                        <a href="{% url 'hazards:hazard_detail' response.converted_to_hazard.id %}"
                                           class="btn btn-success btn-sm w-100">
                                            <i class="fas fa-shield-alt"></i><br>
                                            <small>{{ response.converted_to_hazard.report_number }}</small>
                                        </a>

                                    {% elif response.assigned_to and response.assigned_to == current_user %}
                                        <!-- Assigned to ME → Show Convert button -->
                                        <button type="button"
                                                class="btn btn-warning btn-sm w-100 convert-btn"
                                                data-response-id="{{ response.id }}"
                                                data-question-code="{{ response.question.question_code }}"
                                                data-question-text="{{ response.question.question_text|truncatechars:80 }}"
                                                data-category="{{ response.question.category.category_name }}"
                                                data-is-critical="{{ response.question.is_critical|yesno:'true,false' }}"
                                                data-schedule="{{ response.submission.schedule.schedule_code }}"
                                                data-plant="{{ response.submission.schedule.plant.name }}"
                                                data-remarks="{{ response.remarks|default:'' }}"
                                                data-assignment-remarks="{{ response.assignment_remarks|default:'' }}">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Convert to Hazard
                                        </button>

                                    {% elif response.assigned_to and response.assigned_to != current_user %}
                                        <!-- Assigned to someone else -->
                                        <span class="badge bg-info text-white">
                                            <i class="fas fa-user-check"></i> Assigned
                                        </span>

                                    {% else %}
                                        <!-- Not assigned yet -->
                                        {% if is_admin %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-clock"></i> Pending
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            Not assigned
                                        </span>
                                        {% endif %}
                                    {% endif %}
                                </td>

                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="{% if is_admin %}11{% else %}10{% endif %}"
                                    class="text-center py-5 text-muted">
                                    <i class="fas fa-check-circle fa-3x mb-3 text-success d-block"></i>
                                    {% if is_admin %}
                                    No non-compliant items found.
                                    {% else %}
                                    No items assigned to you yet.
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if selected_plant %}&plant={{ selected_plant }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}">{{ num }}</a>
            </li>
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

</div>


<!-- ============================================================
     MODAL 1: Assign to Responsible Person (Admin only)
============================================================ -->
{% if is_admin %}
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-check"></i> Assign Non-Compliant Items
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <strong id="assignSummaryText">0 item(s) selected</strong>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Assign To <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="assignToSelect" required>
                        <option value="">-- Select Responsible Person --</option>
                        {% for user in available_users %}
                        <option value="{{ user.id }}">
                            {{ user.get_full_name }}
                            {% if user.department %} — {{ user.department.name }}{% endif %}
                            {% if user.plant %} ({{ user.plant.name }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Instructions / Remarks</label>
                    <textarea class="form-control" id="assignRemarksInput" rows="3"
                              placeholder="Add instructions for the assigned person..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmAssignBtn">
                    <i class="fas fa-user-check"></i> Assign Items
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}


<!-- ============================================================
     MODAL 2: Convert to Hazard
     Visible to ALL users — shown when Convert button is clicked
============================================================ -->
<div class="modal fade" id="convertHazardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Convert to Hazard Report
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">

                <!-- Source info summary -->
                <div class="alert alert-light border mb-4">
                    <div class="row align-items-start">
                        <div class="col-md-10">
                            <p class="mb-1">
                                <strong>Question:</strong>
                                <span id="modalQuestionCode" class="badge bg-primary ms-1"></span>
                                <span id="modalCriticalBadge" class="badge bg-danger ms-1 d-none">
                                    <i class="fas fa-star"></i> CRITICAL
                                </span>
                            </p>
                            <p class="mb-1 small text-dark" id="modalQuestionText"></p>
                            <p class="mb-1 small">
                                <strong>Category:</strong>
                                <span id="modalCategory" class="badge bg-secondary ms-1"></span>
                            </p>
                            <p class="mb-0 small text-muted">
                                <strong>Inspection:</strong>
                                <span id="modalSchedule"></span> |
                                <strong>Plant:</strong>
                                <span id="modalPlant"></span>
                            </p>
                        </div>
                    </div>
                    <div id="modalRemarksBlock" class="mt-2 small text-muted d-none">
                        <i class="fas fa-comment text-info"></i>
                        <em id="modalRemarksText"></em>
                    </div>
                    <div id="modalAssignRemarksBlock" class="mt-1 small text-primary d-none">
                        <i class="fas fa-sticky-note"></i>
                        <em id="modalAssignRemarksText"></em>
                    </div>
                </div>

                <form id="convertHazardForm">
                    {% csrf_token %}
                    <input type="hidden" id="convertResponseId" value="">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                Hazard Type <span class="text-danger">*</span>
                            </label>
                            <select name="hazard_type" id="hazardTypeSelect" class="form-select" required>
                                <option value="">-- Select Type --</option>
                                <option value="UC" selected>Unsafe Condition</option>
                                <option value="UA">Unsafe Act</option>
                                <option value="NM">Near Miss</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                Hazard Category <span class="text-danger">*</span>
                            </label>
                            <select name="hazard_category" id="hazardCategorySelect" class="form-select" required>
                                <option value="">-- Select Category --</option>
                                <option value="slip_trip_fall">Slip/Trip/Fall</option>
                                <option value="chemical">Chemical</option>
                                <option value="electrical">Electrical</option>
                                <option value="fire">Fire</option>
                                <option value="equipment">Equipment/Machinery</option>
                                <option value="ergonomic">Ergonomic</option>
                                <option value="biological">Biological</option>
                                <option value="environmental">Environmental</option>
                                <option value="confined_space">Confined Space</option>
                                <option value="working_at_height">Working at Height</option>
                                <option value="manual_handling">Manual Handling</option>
                                <option value="noise">Noise/Vibration</option>
                                <option value="temperature">Temperature Extremes</option>
                                <option value="radiation">Radiation</option>
                                <option value="vehicular">Vehicular/Traffic</option>
                                <option value="other" selected>Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                Severity <span class="text-danger">*</span>
                            </label>
                            <select name="severity" id="severitySelect" class="form-select" required>
                                <option value="">-- Select Severity --</option>
                                <option value="low">Low — 30 days deadline</option>
                                <option value="medium">Medium — 15 days deadline</option>
                                <option value="high">High — 7 days deadline</option>
                                <option value="critical">Critical — 1 day deadline</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Action Deadline</label>
                            <div class="alert alert-secondary mb-0 py-2" id="deadlinePreview">
                                <small>
                                    <i class="fas fa-calendar-alt"></i>
                                    Select severity to see deadline
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Immediate Action Taken / Recommended</label>
                        <textarea name="immediate_action" id="immediateActionText"
                                  class="form-control" rows="3"
                                  placeholder="Describe any immediate steps taken or recommended..."></textarea>
                    </div>
                </form>

                <!-- Error message -->
                <div class="alert alert-danger d-none mt-2" id="convertError"></div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-warning fw-bold" id="submitConvertBtn">
                    <i class="fas fa-exclamation-triangle"></i> Create Hazard Report
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Success Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:9999;">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0">
        <div class="d-flex">
            <div class="toast-body" id="successToastBody">Done!</div>
            <button type="button" class="close text-white me-2" data-dismiss="toast" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {

    // ============================================================
    // ADMIN: Select All + Bulk Assign
    // ============================================================
    const selectAll = document.getElementById('selectAll');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCountEl = document.getElementById('selectedCount');
    const openAssignModalBtn = document.getElementById('openAssignModalBtn');
    const confirmAssignBtn = document.getElementById('confirmAssignBtn');
    const selectedResponsesInput = document.getElementById('selectedResponsesInput');

    function getCheckedIds() {
        return Array.from(document.querySelectorAll('.row-checkbox:checked')).map(b => b.value);
    }

    function updateBulkBar() {
        if (!bulkActionsBar) return;
        const ids = getCheckedIds();
        bulkActionsBar.style.display = ids.length > 0 ? 'block' : 'none';
        if (selectedCountEl) selectedCountEl.textContent = ids.length + ' selected';
    }

    if (selectAll) {
        selectAll.addEventListener('change', function () {
            document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = selectAll.checked);
            updateBulkBar();
        });
    }

    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBulkBar);
    });

    if (openAssignModalBtn) {
        openAssignModalBtn.addEventListener('click', function () {
            const ids = getCheckedIds();
            if (!ids.length) { alert('Please select at least one item.'); return; }
            document.getElementById('assignSummaryText').textContent = ids.length + ' item(s) selected for assignment';
            selectedResponsesInput.value = ids.join(',');
            $('#assignModal').modal('show');
        });
    }

    if (confirmAssignBtn) {
        confirmAssignBtn.addEventListener('click', function () {
            const assignTo = document.getElementById('assignToSelect').value;
            if (!assignTo) { alert('Please select a person to assign.'); return; }
            document.getElementById('assignedToHidden').value = assignTo;
            document.getElementById('assignmentRemarksHidden').value =
                document.getElementById('assignRemarksInput').value;
            document.getElementById('assignForm').submit();
        });
    }


    // ============================================================
    // CONVERT TO HAZARD MODAL
    // ============================================================
    // convertHazardModal — controlled via jQuery $('#convertHazardModal')
    const severitySelect = document.getElementById('severitySelect');
    const deadlinePreview = document.getElementById('deadlinePreview');
    const convertError = document.getElementById('convertError');
    const submitConvertBtn = document.getElementById('submitConvertBtn');

    const severityDays = { low: 30, medium: 15, high: 7, critical: 1 };

    // Bootstrap 4 modal — use jQuery API
    // No instance needed — $('#id').modal() handles everything

    // Open modal on Convert button click
    document.querySelectorAll('.convert-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            const isCritical = this.dataset.isCritical === 'true';

            // Fill source info
            document.getElementById('convertResponseId').value = this.dataset.responseId;
            document.getElementById('modalQuestionCode').textContent = this.dataset.questionCode;
            document.getElementById('modalQuestionText').textContent = this.dataset.questionText;
            document.getElementById('modalCategory').textContent = this.dataset.category;
            document.getElementById('modalSchedule').textContent = this.dataset.schedule;
            document.getElementById('modalPlant').textContent = this.dataset.plant;

            // Critical badge
            const critBadge = document.getElementById('modalCriticalBadge');
            critBadge.classList.toggle('d-none', !isCritical);

            // Remarks
            const remarks = this.dataset.remarks;
            const remarksBlock = document.getElementById('modalRemarksBlock');
            if (remarks) {
                remarksBlock.classList.remove('d-none');
                document.getElementById('modalRemarksText').textContent = remarks;
            } else {
                remarksBlock.classList.add('d-none');
            }

            // Assignment remarks
            const assignRemarks = this.dataset.assignmentRemarks;
            const assignBlock = document.getElementById('modalAssignRemarksBlock');
            if (assignRemarks) {
                assignBlock.classList.remove('d-none');
                document.getElementById('modalAssignRemarksText').textContent = assignRemarks;
            } else {
                assignBlock.classList.add('d-none');
            }

            // Auto-set severity
            severitySelect.value = isCritical ? 'high' : 'medium';

            // Reset
            document.getElementById('immediateActionText').value = '';
            convertError.classList.add('d-none');
            submitConvertBtn.disabled = false;
            submitConvertBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Create Hazard Report';

            updateDeadline();
            $('#convertHazardModal').modal('show');
        });
    });

    // Update deadline when severity changes
    if (severitySelect) {
        severitySelect.addEventListener('change', updateDeadline);
    }

    function updateDeadline() {
        const severity = severitySelect ? severitySelect.value : '';
        if (severity && severityDays[severity]) {
            const days = severityDays[severity];
            const date = new Date();
            date.setDate(date.getDate() + days);
            const dateStr = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'long', year: 'numeric' });
            const colorMap = { low: 'success', medium: 'info', high: 'warning', critical: 'danger' };
            const color = colorMap[severity] || 'secondary';
            deadlinePreview.className = `alert alert-${color} mb-0 py-2`;
            deadlinePreview.innerHTML = `<i class="fas fa-calendar-check"></i> <strong>${dateStr}</strong> <span class="text-muted ms-2">(${days} days from today)</span>`;
        } else {
            deadlinePreview.className = 'alert alert-secondary mb-0 py-2';
            deadlinePreview.innerHTML = '<small><i class="fas fa-calendar-alt"></i> Select severity to see deadline</small>';
        }
    }

    // Submit via AJAX
    if (submitConvertBtn) {
        submitConvertBtn.addEventListener('click', function () {
            const responseId = document.getElementById('convertResponseId').value;
            const hazardType = document.getElementById('hazardTypeSelect').value;
            const hazardCategory = document.getElementById('hazardCategorySelect').value;
            const severity = severitySelect.value;
            const immediateAction = document.getElementById('immediateActionText').value;
            const csrfToken = document.getElementById('convertHazardForm')
                                       .querySelector('[name=csrfmiddlewaretoken]').value;

            if (!hazardType || !hazardCategory || !severity) {
                convertError.textContent = 'Please fill in all required fields.';
                convertError.classList.remove('d-none');
                return;
            }

            // Disable button to prevent double-click
            submitConvertBtn.disabled = true;
            submitConvertBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            convertError.classList.add('d-none');

            const formData = new FormData();
            formData.append('hazard_type', hazardType);
            formData.append('hazard_category', hazardCategory);
            formData.append('severity', severity);
            formData.append('immediate_action', immediateAction);

            fetch(`/inspections/response/${responseId}/convert-to-hazard/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    $('#convertHazardModal').modal('hide');

                    // Replace the button in the row with hazard link
                    const row = document.getElementById('row-' + responseId);
                    if (row) {
                        const actionCell = row.querySelector('td:last-child');
                        actionCell.innerHTML = `
                            <a href="${data.hazard_url}"
                               class="btn btn-success btn-sm w-100" target="_blank">
                                <i class="fas fa-shield-alt"></i><br>
                                <small>${data.hazard_number}</small>
                            </a>`;
                        // Remove warning highlight from row
                        row.classList.remove('table-warning');
                        row.classList.add('table-success');
                    }

                    // Show success toast
                    document.getElementById('successToastBody').innerHTML =
                        '<i class="fas fa-check-circle me-2"></i> Hazard <strong>' +
                        data.hazard_number + '</strong> created! ' +
                        '<a href="' + data.hazard_url + '" class="text-white text-decoration-underline ms-2" target="_blank">View →</a>';
                    $('#successToast').toast({ delay: 6000 });
                    $('#successToast').toast('show');

                } else {
                    convertError.textContent = data.error || 'Something went wrong. Please try again.';
                    convertError.classList.remove('d-none');
                    submitConvertBtn.disabled = false;
                    submitConvertBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Create Hazard Report';
                }
            })
            .catch(() => {
                convertError.textContent = 'Network error. Please check your connection and try again.';
                convertError.classList.remove('d-none');
                submitConvertBtn.disabled = false;
                submitConvertBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Create Hazard Report';
            });
        });
    }

});
</script>

{% endblock %}