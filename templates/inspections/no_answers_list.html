{% extends 'base/base.html' %}
{% load static %}
{% block page_title %}{% endblock %}
{% block extra_css %}
<style>
.container-fluid.py-4 {
    max-width: 1600px;
}
h3 {
    font-weight: 600;
}
.stats-card {
    border-radius: 10px;
    transition: 0.2s ease-in-out;
}

.stats-card:hover {
    transform: translateY(-2px);
}

.stats-card .icon {
    font-size: 22px;
    margin-bottom: 6px;
}

.stats-card h3 {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 4px;
}

.stats-card small {
    font-size: 13px;
}
.filter-card .card-body {
    padding: 18px 20px;
}

.filter-card label {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
}

.filter-card .form-control,
.filter-card .form-select {
    height: 36px;
    font-size: 13px;
    border-radius: 6px;
}

.filter-card .btn {
    height: 36px;
    font-size: 13px;
    border-radius: 6px;
}
#noAnswersTable th {
    font-size: 13px;
    font-weight: 600;
    vertical-align: middle;
}

#noAnswersTable td {
    font-size: 13px;
    vertical-align: middle;
}

#noAnswersTable td:first-child,
#noAnswersTable th:first-child {
    text-align: center;
    width: 42px;
}

#noAnswersTable input[type="checkbox"] {
    transform: scale(1.05);
    cursor: pointer;
}

/* Question column formatting */
.question-code {
    font-weight: 600;
    font-size: 12px;
}

.question-text {
    font-size: 13px;
}

/* Action column */
.action-cell .btn {
    font-size: 12px;
    padding: 6px 8px;
}

/* Bulk bar */
#bulkActionsBar {
    display: flex;
    align-items: center;
    gap: 10px;
}
.ehs-table-wrapper {
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    overflow: hidden;
}

/* Table */
.ehs-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 14px;
}

/* Header */
.ehs-table thead {
    background: linear-gradient(135deg, #f8f9fa, #eef2f6);
}

.ehs-table thead th {
    font-weight: 600;
    color: #34495e;
    padding: 14px 12px;
    text-align: left;
    border-bottom: 2px solid #e3e6ea;
    position: sticky;
    top: 0;
    z-index: 2;
}

/* Body */
.ehs-table tbody td {
    padding: 12px;
    vertical-align: middle;
    border-bottom: 1px solid #f0f2f5;
}

/* Hover effect */
.ehs-table tbody tr {
    transition: all 0.2s ease;
}

.ehs-table tbody tr:hover {
    background-color: #f8fbff;
    transform: scale(1.002);
}

/* Checkbox column */
.ehs-table th:first-child,
.ehs-table td:first-child {
    text-align: center;
    width: 50px;
}

/* Question code style */
.question-code {
    font-weight: 600;
    color: #2c3e50;
}

/* Small muted text */
.small-muted {
    font-size: 12px;
    color: #6c757d;
}

/* Action column */
.action-cell {
    text-align: center;
    width: 140px;
}

/* Buttons */
.ehs-btn-sm {
    padding: 6px 8px;
    font-size: 12px;
    border-radius: 8px;
}

/* Row States */
.table-warning {
    background-color: #fff8e1 !important;
}

.table-success {
    background-color: #e8f5e9 !important;
}

/* Bulk action bar */
#bulkActionsBar {
    background: #ffffff;
    border-top: 1px solid #e9ecef;
    padding: 12px 16px;
    box-shadow: 0 -3px 10px rgba(0,0,0,0.05);
}

/* Responsive */
.table-responsive {
    border-radius: 14px;
    overflow: auto;
}

/* Status badge improvement */
.badge-soft {
    padding: 6px 10px;
    font-size: 11px;
    font-weight: 600;
    border-radius: 20px;
}

.badge-soft-warning {
    background: #fff3cd;
    color: #856404;
}

.badge-soft-success {
    background: #d4edda;
    color: #155724;
}
.ehs-table-wrapper {
    background: #ffffff;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.05);
    overflow: hidden;
}

.ehs-table thead {
    background: linear-gradient(135deg, #f8f9fa, #eef2f6);
}

.ehs-table thead th {
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: .4px;
    padding: 14px 12px;
    border-bottom: 2px solid #e9ecef;
    position: sticky;
    top: 0;
    z-index: 2;
}

.ehs-table tbody td {
    padding: 12px;
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f5;
}

.ehs-row {
    transition: all .2s ease;
}

.ehs-row:hover {
    background: #f8fbff;
}

.ehs-critical {
    background-color: #fff8e1;
}

.ehs-thumb {
    width: 42px;
    height: 42px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: transform .2s ease;
}

.ehs-thumb:hover {
    transform: scale(1.2);
}
</style>
{% endblock %}
{% block content %}
<div class="container-fluid py-4">

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="mb-1">
                        <i class="fas fa-times-circle text-danger"></i>
                        Non-Compliant Items
                    </h3>
                    <p class="text-muted mb-0">
                        Inspection questions answered "No" — requiring corrective action
                    </p>
                </div>
                <a href="{% url 'inspections:inspection_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    {% comment %} <!-- Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3">
                <div class="text-danger mb-1"><i class="fas fa-times-circle fa-2x"></i></div>
                <h3 class="fw-bold mb-0">{{ total_no_answers }}</h3>
                <small class="text-muted">Total Non-Compliant</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3">
                <div class="text-warning mb-1"><i class="fas fa-star fa-2x"></i></div>
                <h3 class="fw-bold mb-0">{{ critical_no_answers }}</h3>
                <small class="text-muted">Critical Items</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3">
                <div class="text-success mb-1"><i class="fas fa-shield-alt fa-2x"></i></div>
                <h3 class="fw-bold mb-0">{{ converted_hazards_count }}</h3>
                <small class="text-muted">Converted to Hazards</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm text-center p-3">
                <div class="text-info mb-1"><i class="fas fa-clock fa-2x"></i></div>
                <h3 class="fw-bold mb-0">{{ pending_count }}</h3>
                <small class="text-muted">Pending Assignment</small>
            </div>
        </div>
    </div> {% endcomment %}

    <!-- Filters -->
  <div class="card shadow-sm filter-card mb-4">
        <div class="card-body">
            <form method="get" class="row g-2 align-items-end">

                <div class="col-md-2">
                    <label>Plant</label>
                    <select name="plant" class="form-control">
                        <option value="">All Plants</option>
                        {% for plant in plants %}
                        <option value="{{ plant.id }}" {% if selected_plant == plant.id|stringformat:"s" %}selected{% endif %}>
                            {{ plant.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label>Category</label>
                    <select name="category" class="form-control">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if selected_category == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.category_name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <label>Priority</label>
                    <select name="priority" class="form-control">
                        <option value="">All Items</option>
                        <option value="critical" {% if selected_priority == 'critical' %}selected{% endif %}>
                            Critical Only
                        </option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label>From Date</label>
                    <input type="date" name="date_from" class="form-control"
                           value="{{ date_from|default:'' }}">
                </div>

                <div class="col-md-2">
                    <label>To Date</label>
                    <input type="date" name="date_to" class="form-control"
                           value="{{ date_to|default:'' }}">
                </div>

                <div class="col-md-2">
                    <label>Search</label>
                    <input type="text" name="search" class="form-control"
                           placeholder="Question / Code..."
                           value="{{ search|default:'' }}">
                </div>

                <div class="col-12 mt-2">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-search mr-1"></i> Filter
                    </button>

                    <a href="{% url 'inspections:no_answers_list' %}"
                       class="btn btn-outline-secondary btn-sm ml-2">
                        <i class="fas fa-times mr-1"></i> Clear
                    </a>
                </div>

            </form>
        </div>
    </div>

    <!-- Main Table -->
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center py-3">
            <h5 class="mb-0">
                <i class="fas fa-list"></i> Non-Compliant Items
                <span class="badge bg-danger ms-2">{{ page_obj.paginator.count }}</span>
            </h5>
            {% if is_admin %}
            <!-- Bulk assign bar — only visible when checkboxes selected -->
            <div id="bulkActionsBar" style="display:none;">
                <span class="text-muted me-3" id="selectedCount">0 selected</span>
                <button type="button" class="btn btn-primary btn-sm" id="openAssignModalBtn">
                    <i class="fas fa-user-check"></i> Assign Selected
                </button>
            </div>
            {% endif %}
        </div>

        <div class="card-body p-0">
            <form id="assignForm" method="POST" action="{% url 'inspections:no_answers_list' %}">
                {% csrf_token %}
                <input type="hidden" name="action" value="assign_responses">
                <input type="hidden" name="selected_responses" id="selectedResponsesInput">
                <input type="hidden" name="assigned_to" id="assignedToHidden">
                <input type="hidden" name="assignment_remarks" id="assignmentRemarksHidden">

                <div class="ehs-table-wrapper">
                    <div class="table-responsive">
                        <table class="table align-middle mb-0 ehs-table" id="noAnswersTable">

                            <thead class="ehs-thead">
                                <tr>
                                    {% if is_admin %}
                                    <th class="text-center" style="width:50px;">
                                        <input type="checkbox"
                                            id="selectAll"
                                            class="form-check-input">
                                    </th>
                                    {% endif %}
                                    <th style="width:60px;">#</th>
                                    <th style="min-width:260px;">Question</th>
                                    <th>Category</th>
                                    <th>Inspection</th>
                                    <th>Plant</th>
                                    <th style="width:110px;">Date</th>
                                    <th class="text-center" style="width:80px;">Photo</th>
                                    <th style="min-width:160px;">Assigned To</th>
                                    <th class="text-center" style="width:170px;">Action</th>
                                </tr>
                            </thead>

                            <tbody>
                                {% for response in page_obj %}
                                <tr id="row-{{ response.id }}"
                                    class="ehs-row {% if response.question.is_critical %}ehs-critical{% endif %}">

                                    {% if is_admin %}
                                    <td class="text-center">
                                        {% if not response.assigned_to and not response.converted_to_hazard %}
                                        <input type="checkbox"
                                            class="form-check-input row-checkbox"
                                            value="{{ response.id }}">
                                        {% endif %}
                                    </td>
                                    {% endif %}

                                    <!-- INDEX -->
                                    <td>
                                        <span class="fw-semibold">{{ forloop.counter }}</span>
                                        {% if response.question.is_critical %}
                                        <span class="badge bg-danger ms-1">
                                            <i class="fas fa-star"></i>
                                        </span>
                                        {% endif %}
                                    </td>

                                    <!-- QUESTION -->
                                    <td>
                                        <div class="fw-semibold text-primary small">
                                            {{ response.question.question_code }}
                                        </div>

                                        <div class="small text-dark mt-1">
                                            {{ response.question.question_text|truncatechars:75 }}
                                        </div>

                                        {% if response.remarks %}
                                        <div class="small text-muted mt-1">
                                            <i class="fas fa-comment text-info me-1"></i>
                                            <em>{{ response.remarks|truncatechars:50 }}</em>
                                        </div>
                                        {% endif %}

                                        {% if response.assignment_remarks %}
                                        <div class="small text-info mt-1">
                                            <i class="fas fa-sticky-note me-1"></i>
                                            <em>{{ response.assignment_remarks|truncatechars:50 }}</em>
                                        </div>
                                        {% endif %}
                                    </td>

                                    <!-- CATEGORY -->
                                    <td>
                                        <span class="badge bg-light text-dark border">
                                            {{ response.question.category.category_name }}
                                        </span>
                                    </td>

                                    <!-- INSPECTION -->
                                    <td>
                                        <div class="fw-semibold small">
                                            {{ response.submission.schedule.schedule_code }}
                                        </div>
                                        <div class="small text-muted">
                                            by {{ response.submission.submitted_by.get_full_name }}
                                        </div>
                                    </td>

                                    <!-- PLANT -->
                                    <td>
                                        <span class="small">
                                            {{ response.submission.schedule.plant.name }}
                                        </span>
                                    </td>

                                    <!-- DATE -->
                                    <td>
                                        <span class="small text-muted">
                                            {% if response.answered_at %}
                                                {{ response.answered_at|date:"d M Y" }}
                                            {% else %}
                                                {{ response.submission.schedule.scheduled_date|date:"d M Y" }}
                                            {% endif %}
                                        </span>
                                    </td>

                                    <!-- PHOTO -->
                                    <td class="text-center">
                                        {% if response.photo %}
                                        <a href="{{ response.photo.url }}" target="_blank">
                                            <img src="{{ response.photo.url }}"
                                                class="ehs-thumb">
                                        </a>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>

                                    <!-- ASSIGNED -->
                                    <td>
                                        {% if response.assigned_to %}
                                        <div class="small">
                                            <i class="fas fa-user text-success me-1"></i>
                                            <strong>{{ response.assigned_to.get_full_name }}</strong>
                                        </div>
                                        {% if response.assigned_at %}
                                        <div class="small text-muted">
                                            {{ response.assigned_at|date:"d M Y" }}
                                        </div>
                                        {% endif %}
                                        {% else %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-clock me-1"></i> Unassigned
                                        </span>
                                        {% endif %}
                                    </td>

                                    <!-- ACTION -->
                                    <td class="text-center">

                                        {% if response.converted_to_hazard %}

                                        <a href="{% url 'hazards:hazard_detail' response.converted_to_hazard.id %}"
                                        class="btn btn-success btn-sm w-100">
                                            <i class="fas fa-shield-alt"></i><br>
                                            <small>{{ response.converted_to_hazard.report_number }}</small>
                                        </a>

                                        {% elif response.assigned_to and response.assigned_to == current_user %}

                                        <button type="button"
                                                class="btn btn-warning btn-sm w-100 convert-btn"
                                                data-response-id="{{ response.id }}"
                                                data-question-code="{{ response.question.question_code }}"
                                                data-question-text="{{ response.question.question_text|truncatechars:80 }}"
                                                data-category="{{ response.question.category.category_name }}"
                                                data-is-critical="{{ response.question.is_critical|yesno:'true,false' }}"
                                                data-schedule="{{ response.submission.schedule.schedule_code }}"
                                                data-plant="{{ response.submission.schedule.plant.name }}"
                                                data-remarks="{{ response.remarks|default:'' }}"
                                                data-assignment-remarks="{{ response.assignment_remarks|default:'' }}">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Convert to Hazard
                                        </button>

                                        {% elif response.assigned_to and response.assigned_to != current_user %}

                                        <span class="badge bg-info text-white">
                                            <i class="fas fa-user-check me-1"></i> Assigned
                                        </span>

                                        {% else %}

                                            {% if is_admin %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock me-1"></i> Pending
                                            </span>
                                            {% else %}
                                            <span class="badge bg-secondary">
                                                Not assigned
                                            </span>
                                            {% endif %}

                                        {% endif %}
                                    </td>

                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{% if is_admin %}11{% else %}10{% endif %}"
                                        class="text-center py-5 text-muted">

                                        <i class="fas fa-check-circle fa-3x mb-3 text-success d-block"></i>

                                        {% if is_admin %}
                                        No non-compliant items found.
                                        {% else %}
                                        No items assigned to you yet.
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>

                        </table>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if selected_plant %}&plant={{ selected_plant }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}{% if search %}&search={{ search }}{% endif %}">{{ num }}</a>
            </li>
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

</div>


<!-- ============================================================
     MODAL 1: Assign to Responsible Person (Admin only)
============================================================ -->
{% if is_admin %}
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-user-check"></i> Assign Non-Compliant Items
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info mb-3">
                    <strong id="assignSummaryText">0 item(s) selected</strong>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        Assign To <span class="text-danger">*</span>
                    </label>
                    <select class="form-select" id="assignToSelect" required>
                        <option value="">-- Select Responsible Person --</option>
                        {% for user in available_users %}
                        <option value="{{ user.id }}">
                            {{ user.get_full_name }}
                            {% if user.department %} — {{ user.department.name }}{% endif %}
                            {% if user.plant %} ({{ user.plant.name }}){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold">Instructions / Remarks</label>
                    <textarea class="form-control" id="assignRemarksInput" rows="3"
                              placeholder="Add instructions for the assigned person..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirmAssignBtn">
                    <i class="fas fa-user-check"></i> Assign Items
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}


<!-- ============================================================
     MODAL 2: Convert to Hazard
     Visible to ALL users — shown when Convert button is clicked
============================================================ -->
<div class="modal fade" id="convertHazardModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Convert to Hazard Report
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body">

                <!-- Source info summary -->
                <div class="alert alert-light border mb-4">
                    <div class="row align-items-start">
                        <div class="col-md-10">
                            <p class="mb-1">
                                <strong>Question:</strong>
                                <span id="modalQuestionCode" class="badge bg-primary ms-1"></span>
                                <span id="modalCriticalBadge" class="badge bg-danger ms-1 d-none">
                                    <i class="fas fa-star"></i> CRITICAL
                                </span>
                            </p>
                            <p class="mb-1 small text-dark" id="modalQuestionText"></p>
                            <p class="mb-1 small">
                                <strong>Category:</strong>
                                <span id="modalCategory" class="badge bg-secondary ms-1"></span>
                            </p>
                            <p class="mb-0 small text-muted">
                                <strong>Inspection:</strong>
                                <span id="modalSchedule"></span> |
                                <strong>Plant:</strong>
                                <span id="modalPlant"></span>
                            </p>
                        </div>
                    </div>
                    <div id="modalRemarksBlock" class="mt-2 small text-muted d-none">
                        <i class="fas fa-comment text-info"></i>
                        <em id="modalRemarksText"></em>
                    </div>
                    <div id="modalAssignRemarksBlock" class="mt-1 small text-primary d-none">
                        <i class="fas fa-sticky-note"></i>
                        <em id="modalAssignRemarksText"></em>
                    </div>
                </div>

                <form id="convertHazardForm">
                    {% csrf_token %}
                    <input type="hidden" id="convertResponseId" value="">

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                Hazard Type <span class="text-danger">*</span>
                            </label>
                            <select name="hazard_type" id="hazardTypeSelect" class="form-select" required>
                                <option value="">-- Select Type --</option>
                                <option value="UC" selected>Unsafe Condition</option>
                                <option value="UA">Unsafe Act</option>
                                <option value="NM">Near Miss</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                Hazard Category <span class="text-danger">*</span>
                            </label>
                            <select name="hazard_category" id="hazardCategorySelect" class="form-select" required>
                                <option value="">-- Select Category --</option>
                                <option value="electrical">Electrical</option>
                                <option value="machine_guarding">Machine Guarding</option>
                                <option value="height_work">Height work</option>
                                <option value="fire">Fire</option>
                                <option value="vehicle_including_forklift">Vehicle including forklift</option>
                                <option value="ppe_violation">PPE Violation</option>
                                <option value="asbestos_spillage_bag_torn">Asbestos Spillage/Bag Torn</option>
                                <option value="hot_work">Hot work</option>
                                <option value="loto">LOTO</option>
                                <option value="sop_violations">SOP Violations</option>
                                <option value="unsafe_storage">Unsafe Storage</option>
                                <option value="slip_trip">Slip Trip</option>
                                <option value="noise">Noise</option>
                                <option value="illumination">Illumination</option>
                                <option value="dust_collection_ventillation">Dust collection / Ventillation</option>
                                <option value="others" selected>Others</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">
                                Severity <span class="text-danger">*</span>
                            </label>
                            <select name="severity" id="severitySelect" class="form-select" required>
                                <option value="">-- Select Severity --</option>
                                <option value="low">Low — 30 days deadline</option>
                                <option value="medium">Medium — 15 days deadline</option>
                                <option value="high">High — 7 days deadline</option>
                                <option value="critical">Critical — 1 day deadline</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Action Deadline</label>
                            <div class="alert alert-secondary mb-0 py-2" id="deadlinePreview">
                                <small>
                                    <i class="fas fa-calendar-alt"></i>
                                    Select severity to see deadline
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Immediate Action Taken / Recommended</label>
                        <textarea name="immediate_action" id="immediateActionText"
                                  class="form-control" rows="3"
                                  placeholder="Describe any immediate steps taken or recommended..."></textarea>
                    </div>
                </form>

                <!-- Error message -->
                <div class="alert alert-danger d-none mt-2" id="convertError"></div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-warning fw-bold" id="submitConvertBtn">
                    <i class="fas fa-exclamation-triangle"></i> Create Hazard Report
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Success Toast -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index:9999;">
    <div id="successToast" class="toast align-items-center text-white bg-success border-0">
        <div class="d-flex">
            <div class="toast-body" id="successToastBody">Done!</div>
            <button type="button" class="close text-white me-2" data-dismiss="toast" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {

    // ============================================================
    // ADMIN: Select All + Bulk Assign
    // ============================================================
    if (window.__NO_ANSWERS_SCRIPT_LOADED__) return;
    window.__NO_ANSWERS_SCRIPT_LOADED__ = true;
    const selectAll = document.getElementById('selectAll');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const selectedCountEl = document.getElementById('selectedCount');
    const openAssignModalBtn = document.getElementById('openAssignModalBtn');
    const confirmAssignBtn = document.getElementById('confirmAssignBtn');
    const selectedResponsesInput = document.getElementById('selectedResponsesInput');

    function getCheckedIds() {
        return Array.from(document.querySelectorAll('.row-checkbox:checked'))
            .map(cb => cb.value);
    }

    function updateBulkBar() {
        if (!bulkActionsBar) return;
        const ids = getCheckedIds();
        bulkActionsBar.style.display = ids.length ? 'flex' : 'none';
        if (selectedCountEl) selectedCountEl.textContent = ids.length + ' selected';
    }

    if (selectAll) {
        selectAll.addEventListener('change', function () {
            document.querySelectorAll('.row-checkbox').forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateBulkBar();
        });
    }

    document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', updateBulkBar);
    });
    let isAssignSubmitting = false;

    if (openAssignModalBtn) {
        openAssignModalBtn.addEventListener('click', function () {
            const ids = getCheckedIds();
            if (!ids.length) {
                alert('Please select at least one item.');
                return;
            }

            document.getElementById('assignSummaryText').textContent =
                ids.length + ' item(s) selected for assignment';

            selectedResponsesInput.value = ids.join(',');
            $('#assignModal').modal('show');
        });
    }

    if (confirmAssignBtn) {
        confirmAssignBtn.addEventListener('click', function () {

            if (isAssignSubmitting) return;

            const assignTo = document.getElementById('assignToSelect').value;
            if (!assignTo) {
                alert('Please select a person to assign.');
                return;
            }

            isAssignSubmitting = true;
            confirmAssignBtn.disabled = true;
            confirmAssignBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Assigning...';

            document.getElementById('assignedToHidden').value = assignTo;
            document.getElementById('assignmentRemarksHidden').value =
                document.getElementById('assignRemarksInput').value;

            document.getElementById('assignForm').submit();
        });
    }


    // ============================================================
    // CONVERT TO HAZARD MODAL
    // ============================================================

    const severitySelect = document.getElementById('severitySelect');
    const deadlinePreview = document.getElementById('deadlinePreview');
    const convertError = document.getElementById('convertError');
    const submitConvertBtn = document.getElementById('submitConvertBtn');

    const severityDays = {
        low: 30,
        medium: 15,
        high: 7,
        critical: 1
    };

    let isConvertSubmitting = false;

    // ---------------------------
    // OPEN CONVERT MODAL
    // ---------------------------

    document.querySelectorAll('.convert-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            isConvertSubmitting = false;
            const isCritical = this.dataset.isCritical === 'true';

            document.getElementById('convertResponseId').value =
                this.dataset.responseId;

            document.getElementById('modalQuestionCode').textContent =
                this.dataset.questionCode;

            document.getElementById('modalQuestionText').textContent =
                this.dataset.questionText;

            document.getElementById('modalCategory').textContent =
                this.dataset.category;

            document.getElementById('modalSchedule').textContent =
                this.dataset.schedule;

            document.getElementById('modalPlant').textContent =
                this.dataset.plant;

            const critBadge = document.getElementById('modalCriticalBadge');
            critBadge.classList.toggle('d-none', !isCritical);

            // Remarks
            const remarksBlock = document.getElementById('modalRemarksBlock');
            if (this.dataset.remarks) {
                remarksBlock.classList.remove('d-none');
                document.getElementById('modalRemarksText').textContent =
                    this.dataset.remarks;
            } else {
                remarksBlock.classList.add('d-none');
            }

            // Assignment remarks
            const assignBlock = document.getElementById('modalAssignRemarksBlock');
            if (this.dataset.assignmentRemarks) {
                assignBlock.classList.remove('d-none');
                document.getElementById('modalAssignRemarksText').textContent =
                    this.dataset.assignmentRemarks;
            } else {
                assignBlock.classList.add('d-none');
            }

            // Reset form
            document.getElementById('hazardTypeSelect').value = 'UC';
            document.getElementById('hazardCategorySelect').value = '';
            severitySelect.value = isCritical ? 'high' : 'medium';

            // Reset
            document.getElementById('immediateActionText').value = '';
            convertError.classList.add('d-none');
            submitConvertBtn.disabled = false;
            submitConvertBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Create Hazard Report';

            updateDeadline();
            $('#convertHazardModal').modal('show');
        });
    });

    // Update deadline when severity changes

    function updateDeadline() {
        const severity = severitySelect.value;
        if (severity && severityDays[severity]) {
            const days = severityDays[severity];
            const date = new Date();
            date.setDate(date.getDate() + days);

            const dateStr = date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });

            const colorMap = {
                low: 'success',
                medium: 'info',
                high: 'warning',
                critical: 'danger'
            };

            const color = colorMap[severity] || 'secondary';

            deadlinePreview.className = 'alert alert-' + color + ' mb-0 py-2';
            deadlinePreview.innerHTML =
                '<i class="fas fa-calendar-check"></i> <strong>' +
                dateStr +
                '</strong> <span class="text-muted ms-2">(' +
                days +
                ' days from today)</span>';

        } else {
            deadlinePreview.className = 'alert alert-secondary mb-0 py-2';
            deadlinePreview.innerHTML =
                '<small><i class="fas fa-calendar-alt"></i> Select severity to see deadline</small>';
        }
    }

    if (severitySelect) {
        severitySelect.addEventListener('change', updateDeadline);
    }

    // ---------------------------
    // SAFE CONVERT SUBMIT
    // ---------------------------

    if (submitConvertBtn) {

        submitConvertBtn.addEventListener('click', function () {

            if (isConvertSubmitting) return;

            const responseId =
                document.getElementById('convertResponseId').value;

            const hazardType =
                document.getElementById('hazardTypeSelect').value;

            const hazardCategory =
                document.getElementById('hazardCategorySelect').value;

            const severity = severitySelect.value;

            const immediateAction =
                document.getElementById('immediateActionText').value;

            const csrfToken =
                document.getElementById('convertHazardForm')
                    .querySelector('[name=csrfmiddlewaretoken]').value;

            if (!hazardType || !hazardCategory || !severity) {
                convertError.textContent =
                    'Please fill in all required fields.';
                convertError.classList.remove('d-none');
                return;
            }

            isConvertSubmitting = true;
            submitConvertBtn.disabled = true;
            submitConvertBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Creating...';

            const convertUrl =
                '/inspections/response/' +
                responseId +
                '/convert-to-hazard/';

            $.ajax({
                url: convertUrl,
                type: 'POST',
                data: {
                    hazard_type: hazardType,
                    hazard_category: hazardCategory,
                    severity: severity,
                    immediate_action: immediateAction,
                    csrfmiddlewaretoken: csrfToken
                },
                headers: { 'X-Requested-With': 'XMLHttpRequest' },

                success: function (data) {

                    if (data.success) {

                        $('#convertHazardModal').modal('hide');

                        const row =
                            document.getElementById('row-' + responseId);

                        if (row) {
                            const actionCell =
                                row.querySelector('td:last-child');

                            actionCell.innerHTML =
                                '<a href="' + data.hazard_url + '" ' +
                                'class="btn btn-success btn-sm w-100" target="_blank">' +
                                '<i class="fas fa-shield-alt"></i><br>' +
                                '<small>' + data.hazard_number + '</small>' +
                                '</a>';

                            row.classList.remove('table-warning');
                            row.classList.add('table-success');
                        }

                    } else {
                        throw new Error(data.error || 'Something went wrong.');
                    }
                },

                error: function () {
                    convertError.textContent =
                        'Server error. Please try again.';
                    convertError.classList.remove('d-none');
                    submitConvertBtn.disabled = false;
                    submitConvertBtn.innerHTML =
                        '<i class="fas fa-exclamation-triangle"></i> Create Hazard Report';
                    isConvertSubmitting = false;
                }
            });
        });
    }

});
</script>

{% endblock %}