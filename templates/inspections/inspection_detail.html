{% extends 'base/base.html' %}
{% load static %}

{% block title %}Inspection Detail{% endblock %}
{% block page_title %}Inspection Details{% endblock %}

{% block extra_css %}
<style>
.inspection-header {
    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
    color: white;
    padding: 30px;
    border-radius: 10px 10px 0 0;
}

.inspection-info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.info-item {
    text-align: center;
}

.info-item-label {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-bottom: 5px;
}

.info-item-value {
    font-size: 1.3rem;
    font-weight: 700;
}

.response-section {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    background-color: #fff;
}

.category-header {
    background-color: #f8f9fa;
    padding: 15px;
    border-left: 4px solid #17a2b8;
    border-radius: 5px;
    margin-bottom: 15px;
}

.response-item {
    padding: 15px;
    border-bottom: 1px solid #e9ecef;
}

.response-item:last-child {
    border-bottom: none;
}

.response-icon {
    font-size: 1.5rem;
    margin-right: 10px;
}

.response-icon.yes {
    color: #28a745;
}

.response-icon.no {
    color: #dc3545;
}

.response-icon.na {
    color: #6c757d;
}

.response-text {
    flex: 1;
}

.finding-card {
    border-left: 4px solid #dc3545;
    margin-bottom: 15px;
}

.photo-gallery {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.photo-gallery img {
    max-width: 150px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s;
}

.photo-gallery img:hover {
    transform: scale(1.05);
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'inspections:dashboard' %}">Inspection Management</a></li>
<li class="breadcrumb-item"><a href="{% url 'inspections:inspection_list' %}">All Inspections</a></li>
<li class="breadcrumb-item active">{{ inspection.inspection_number }}</li>
{% endblock %}

{% block content %}

<!-- Inspection Header -->
<div class="card ehs-card">
    <div class="inspection-header">
        <h3 class="mb-0">
            <i class="fas fa-clipboard-check mr-2"></i>
            {{ inspection.template.template_name }}
        </h3>
        <p class="mb-0 mt-2">Inspection #{{ inspection.inspection_number }}</p>
        
        <div class="inspection-info-grid">
            <div class="info-item">
                <div class="info-item-label">Plant</div>
                <div class="info-item-value">{{ inspection.plant.name }}</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Date</div>
                <div class="info-item-value">{{ inspection.inspection_date|date:"d M Y" }}</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Conducted By</div>
                <div class="info-item-value">{{ inspection.conducted_by.get_full_name }}</div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Compliance Score</div>
                <div class="info-item-value">
                    {% if inspection.overall_score >= 90 %}
                    <span class="badge badge-success" style="font-size: 1.3rem;">
                        {{ inspection.overall_score|floatformat:1 }}%
                    </span>
                    {% elif inspection.overall_score >= 75 %}
                    <span class="badge badge-info" style="font-size: 1.3rem;">
                        {{ inspection.overall_score|floatformat:1 }}%
                    </span>
                    {% elif inspection.overall_score >= 60 %}
                    <span class="badge badge-warning" style="font-size: 1.3rem;">
                        {{ inspection.overall_score|floatformat:1 }}%
                    </span>
                    {% else %}
                    <span class="badge badge-danger" style="font-size: 1.3rem;">
                        {{ inspection.overall_score|floatformat:1 }}%
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Total Findings</div>
                <div class="info-item-value">
                    {% if inspection.total_findings > 0 %}
                    <span class="badge badge-danger" style="font-size: 1.3rem;">
                        {{ inspection.total_findings }}
                    </span>
                    {% else %}
                    <span class="badge badge-success" style="font-size: 1.3rem;">0</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-item-label">Status</div>
                <div class="info-item-value">
                    {% if inspection.status == 'SUBMITTED' %}
                    <span class="badge badge-info" style="font-size: 1rem;">Submitted</span>
                    {% elif inspection.status == 'APPROVED' %}
                    <span class="badge badge-success" style="font-size: 1rem;">Approved</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <!-- Action Buttons -->
        <div class="mb-4">
            {% if inspection.pdf_report %}
            <a href="{{ inspection.pdf_report.url }}" class="btn btn-danger" target="_blank">
                <i class="fas fa-file-pdf mr-1"></i>Download PDF Report
            </a>
            {% endif %}
            <a href="{% url 'inspections:inspection_list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left mr-1"></i>Back to List
            </a>
        </div>

        <!-- Inspection Responses by Category -->
        <h5 class="mb-3"><i class="fas fa-list-check mr-2"></i>Inspection Responses</h5>
        
        {% regroup responses by category as category_list %}
        {% for category in category_list %}
        <div class="response-section">
            <div class="category-header">
                <h6 class="mb-0">
                    <i class="fas fa-folder-open mr-2"></i>
                    {{ category.grouper.category_name }}
                    <span class="badge badge-secondary float-right">
                        {{ category.list|length }} Points
                    </span>
                </h6>
            </div>
            
            {% for response in category.list %}
            <div class="response-item d-flex align-items-start">
                <div class="response-icon 
                    {% if response.response == 'YES' %}yes
                    {% elif response.response == 'NO' %}no
                    {% else %}na{% endif %}">
                    {% if response.response == 'YES' %}
                    <i class="fas fa-check-circle"></i>
                    {% elif response.response == 'NO' %}
                    <i class="fas fa-times-circle"></i>
                    {% else %}
                    <i class="fas fa-minus-circle"></i>
                    {% endif %}
                </div>
                
                <div class="response-text">
                    <p class="mb-1">
                        <strong>{{ forloop.counter }}.</strong> {{ response.inspection_point.inspection_point_text }}
                    </p>
                    
                    <div class="mb-2">
                        <span class="badge 
                            {% if response.response == 'YES' %}badge-success
                            {% elif response.response == 'NO' %}badge-danger
                            {% else %}badge-secondary{% endif %}">
                            {{ response.response }}
                        </span>
                    </div>
                    
                    {% if response.remarks %}
                    <div class="alert alert-warning mb-2">
                        <strong><i class="fas fa-comment mr-1"></i>Remarks:</strong>
                        {{ response.remarks }}
                    </div>
                    {% endif %}
                    
                    {% if response.photo_1 or response.photo_2 or response.photo_3 %}
                    <div class="photo-gallery">
                        {% if response.photo_1 %}
                        <img src="{{ response.photo_1.url }}" alt="Photo 1" data-toggle="modal" data-target="#imageModal">
                        {% endif %}
                        {% if response.photo_2 %}
                        <img src="{{ response.photo_2.url }}" alt="Photo 2" data-toggle="modal" data-target="#imageModal">
                        {% endif %}
                        {% if response.photo_3 %}
                        <img src="{{ response.photo_3.url }}" alt="Photo 3" data-toggle="modal" data-target="#imageModal">
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endfor %}

        <!-- Findings Section -->
        {% if findings %}
        <h5 class="mb-3 mt-4">
            <i class="fas fa-flag mr-2 text-danger"></i>Findings ({{ findings.count }})
        </h5>
        
        {% for finding in findings %}
        <div class="card finding-card">
            <div class="card-body">
                <h6>
                    <span class="badge badge-danger">{{ finding.finding_number }}</span>
                    {{ finding.inspection_point_text }}
                </h6>
                
                <div class="row mt-3">
                    <div class="col-md-3">
                        <small class="text-muted d-block">Category</small>
                        <strong>{{ finding.category_name }}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted d-block">Severity</small>
                        <span class="badge 
                            {% if finding.severity == 'CRITICAL' %}badge-danger
                            {% elif finding.severity == 'HIGH' %}badge-warning
                            {% else %}badge-info{% endif %}">
                            {{ finding.get_severity_display }}
                        </span>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted d-block">Assigned To</small>
                        <strong>{{ finding.assigned_to.get_full_name|default:"Unassigned" }}</strong>
                    </div>
                    <div class="col-md-3">
                        <small class="text-muted d-block">Status</small>
                        <span class="badge 
                            {% if finding.status == 'OPEN' %}badge-danger
                            {% elif finding.status == 'IN_PROGRESS' %}badge-warning
                            {% elif finding.status == 'CLOSED' %}badge-success
                            {% else %}badge-secondary{% endif %}">
                            {{ finding.get_status_display }}
                        </span>
                    </div>
                </div>
                
                <div class="mt-3">
                    <a href="{% url 'inspections:finding_detail' finding.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye mr-1"></i>View Finding
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>

{% endblock %}