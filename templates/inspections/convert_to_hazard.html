{% extends 'base/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <i class="fas fa-exchange-alt"></i>
                                Convert Inspection "No" Answer to Hazard Report
                            </h3>
                            <p class="mb-0 mt-2">
                                Create a hazard report from inspection non-compliance
                            </p>
                        </div>
                        <div>
                            <a href="{% url 'inspections:no_answers_list' %}" class="btn btn-dark">
                                <i class="fas fa-arrow-left"></i> Back to List
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inspection Details Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check"></i>
                        Source Inspection Details
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="40%">Inspection Code:</th>
                                    <td>
                                        <strong>{{ schedule.schedule_code }}</strong>
                                        <a href="{% url 'inspections:inspection_review' submission.id %}" 
                                           class="btn btn-sm btn-outline-info ms-2" target="_blank">
                                            <i class="fas fa-external-link-alt"></i> View
                                        </a>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Template:</th>
                                    <td>{{ schedule.template.template_name }}</td>
                                </tr>
                                <tr>
                                    <th>Inspector:</th>
                                    <td>{{ submission.submitted_by.get_full_name }}</td>
                                </tr>
                                <tr>
                                    <th>Inspection Date:</th>
                                    <td>{{ schedule.scheduled_date|date:"d M Y" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-sm table-borderless">
                                <tr>
                                    <th width="40%">Plant:</th>
                                    <td>{{ schedule.plant.name }}</td>
                                </tr>
                                <tr>
                                    <th>Zone:</th>
                                    <td>{{ schedule.zone.name|default:"N/A" }}</td>
                                </tr>
                                <tr>
                                    <th>Location:</th>
                                    <td>{{ schedule.location.name }}</td>
                                </tr>
                                <tr>
                                    <th>Sub-Location:</th>
                                    <td>{{ schedule.sublocation.name|default:"N/A" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question Details -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-times-circle"></i>
                        Non-Compliant Question Details
                        {% if question.is_critical %}
                            <span class="badge bg-warning text-dark float-end">
                                <i class="fas fa-star"></i> CRITICAL
                            </span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Question Code:</strong>
                        </div>
                        <div class="col-md-9">
                            <span class="badge bg-dark">{{ question.question_code }}</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Category:</strong>
                        </div>
                        <div class="col-md-9">
                            <span class="badge bg-secondary">{{ question.category.category_name }}</span>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Question:</strong>
                        </div>
                        <div class="col-md-9">
                            <p class="mb-0">{{ question.question_text }}</p>
                        </div>
                    </div>
                    
                    {% if question.reference_standard %}
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Reference Standard:</strong>
                        </div>
                        <div class="col-md-9">
                            <p class="mb-0 text-muted">{{ question.reference_standard }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Answer:</strong>
                        </div>
                        <div class="col-md-9">
                            <span class="badge bg-danger fs-6">NO (Non-Compliant)</span>
                        </div>
                    </div>
                    
                    {% if response.remarks %}
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <strong>Inspector Remarks:</strong>
                        </div>
                        <div class="col-md-9">
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-comment"></i>
                                {{ response.remarks }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if response.photo %}
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Photo Evidence:</strong>
                        </div>
                        <div class="col-md-9">
                            <a href="{{ response.photo.url }}" target="_blank">
                                <img src="{{ response.photo.url }}" 
                                     alt="Evidence Photo" 
                                     class="img-thumbnail" 
                                     style="max-height: 200px;">
                            </a>
                            <p class="text-muted small mb-0 mt-2">
                                <i class="fas fa-info-circle"></i> 
                                This photo will be copied to the hazard report
                            </p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Conversion Form -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle"></i>
                            Hazard Report Details
                        </h5>
                    </div>
                    <div class="card-body">
                        
                        <!-- Hazard Type -->
                        <div class="row mb-3">
                            <label class="col-md-3 col-form-label">
                                <strong>Hazard Type:</strong>
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-md-9">
                                <select name="hazard_type" class="form-select" required>
                                    <option value="">-- Select Hazard Type --</option>
                                    {% for code, name in hazard_types %}
                                        <option value="{{ code }}" {% if code == 'UC' %}selected{% endif %}>
                                            {{ name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    <strong>UC</strong> - Unsafe Condition (environmental) | 
                                    <strong>UA</strong> - Unsafe Act (behavior) |
                                    <strong>NM</strong> - Near Miss
                                </small>
                            </div>
                        </div>

                        <!-- Hazard Category -->
                        <div class="row mb-3">
                            <label class="col-md-3 col-form-label">
                                <strong>Hazard Category:</strong>
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-md-9">
                                <select name="hazard_category" class="form-select" required>
                                    <option value="">-- Select Category --</option>
                                    {% for code, name in hazard_categories %}
                                        <option value="{{ code }}">{{ name }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    Select the most appropriate hazard category for this issue
                                </small>
                            </div>
                        </div>

                        <!-- Severity -->
                        <div class="row mb-3">
                            <label class="col-md-3 col-form-label">
                                <strong>Severity Level:</strong>
                                <span class="text-danger">*</span>
                            </label>
                            <div class="col-md-9">
                                <select name="severity" class="form-select" required>
                                    {% for code, name in severity_choices %}
                                        <option value="{{ code }}" 
                                            {% if code == auto_severity %}selected{% endif %}>
                                            {{ name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    {% if question.is_critical %}
                                        <i class="fas fa-info-circle text-warning"></i>
                                        Auto-selected as <strong>HIGH</strong> because this is a critical inspection question
                                    {% else %}
                                        <i class="fas fa-info-circle text-info"></i>
                                        Auto-selected as <strong>MEDIUM</strong> - adjust if needed
                                    {% endif %}
                                </small>
                            </div>
                        </div>

                        <!-- Immediate Action Taken -->
                        <div class="row mb-3">
                            <label class="col-md-3 col-form-label">
                                <strong>Immediate Action Taken:</strong>
                            </label>
                            <div class="col-md-9">
                                <textarea name="immediate_action" 
                                          class="form-control" 
                                          rows="3"
                                          placeholder="Describe any immediate actions taken during inspection..."></textarea>
                                <small class="form-text text-muted">
                                    Optional: Any immediate corrective actions taken by the inspector
                                </small>
                            </div>
                        </div>

                        <!-- Auto-filled Information Alert -->
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle"></i> 
                                Auto-filled Information
                            </h6>
                            <p class="mb-0">
                                The following will be automatically set from inspection data:
                            </p>
                            <ul class="mb-0 mt-2">
                                <li><strong>Location:</strong> {{ schedule.plant.name }} → {{ schedule.zone.name|default:"N/A" }} → {{ schedule.location.name }} → {{ schedule.sublocation.name|default:"N/A" }}</li>
                                <li><strong>Reporter:</strong> {{ submission.submitted_by.get_full_name }} ({{ submission.submitted_by.email }})</li>
                                <li><strong>Incident Date:</strong> {{ response.answered_at|date:"d M Y, h:i A" }}</li>
                                <li><strong>Description:</strong> Will include inspection details, question text, and remarks</li>
                                {% if response.photo %}
                                <li><strong>Photo:</strong> Evidence photo will be copied to hazard report</li>
                                {% endif %}
                            </ul>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <button type="submit" class="btn btn-warning btn-lg me-2">
                            <i class="fas fa-exclamation-triangle"></i>
                            Create Hazard Report
                        </button>
                        <a href="{% url 'inspections:no_answers_list' %}" 
                           class="btn btn-secondary btn-lg">
                            <i class="fas fa-times"></i>
                            Cancel
                        </a>
                    </div>
                </div>
            </div>
        </div>

    </form>

    <!-- Preview of Generated Hazard Title -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-eye"></i>
                        Preview of Hazard Report Title
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-0">
                        <strong>Title:</strong> 
                        Inspection Non-Compliance: {{ question.category.category_name }} - {{ question.question_code }}
                    </p>
                </div>
            </div>
        </div>
    </div>

</div>

<style>
    /* Custom styling for better visual hierarchy */
    .table-borderless th {
        color: #495057;
        font-weight: 600;
    }
    
    .card-header h5 {
        font-size: 1.1rem;
    }
    
    .alert-info ul {
        padding-left: 20px;
    }
    
    .badge.fs-6 {
        font-size: 1rem !important;
        padding: 0.5rem 1rem;
    }
    
    /* Responsive image */
    .img-thumbnail {
        cursor: pointer;
        transition: transform 0.2s;
    }
    
    .img-thumbnail:hover {
        transform: scale(1.05);
    }
</style>

<script>
    // Optional: Add confirmation before submission
    document.querySelector('form').addEventListener('submit', function(e) {
        const severity = document.querySelector('select[name="severity"]').value;
        const hazardType = document.querySelector('select[name="hazard_type"]').value;
        
        if (!severity || !hazardType) {
            e.preventDefault();
            alert('Please fill all required fields marked with *');
            return false;
        }
        
        const confirmed = confirm(
            'Are you sure you want to create a hazard report from this inspection non-compliance?\n\n' +
            'This will:\n' +
            '- Create a new hazard record\n' +
            '- Copy all inspection details\n' +
            '- Link this inspection response to the hazard\n' +
            '- Send notifications to relevant personnel'
        );
        
        if (!confirmed) {
            e.preventDefault();
        }
    });
</script>

{% endblock %}