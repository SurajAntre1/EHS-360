{% extends 'base/base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block page_title %}EHS-360 Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block extra_css %}
<style>
  .section-card {
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
    margin-bottom: 28px;
    overflow: hidden;
  }

  .section-header {
    padding: 14px 20px;
    font-weight: 600;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .section-header.incidents {
    background: linear-gradient(135deg, #fee2e2, #fecaca);
    color: #7f1d1d;
  }

  .section-header.hazards {
    background: linear-gradient(135deg, #e0f2fe, #bae6fd);
    color: #0c4a6e;
  }

  .section-header i {
    font-size: 18px;
  }

  .section-body {
    padding: 16px 18px;
  }

  .section-body table {
    margin-bottom: 0;
  }

  .section-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 24px 0;
  }
</style>
{% endblock %}

{% block content %}
<!-- Stats Cards Row -->
<div class="row">
  <!-- Hazard Reports Card -->
  <div class="col-lg-3 col-md-6">
    <div class="ehs-stat-card">
      <div class="ehs-stat-icon ehs-icon-hazard">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="ehs-stat-content">
        <div class="ehs-stat-title">Total Hazards</div>
        <div class="ehs-stat-value">{{ total_hazards|default:0 }}</div>
        <div class="ehs-stat-trend">
          <i class="fas fa-arrow-up"></i>
          <span>This Month</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Incident Reports Card -->
  <div class="col-lg-3 col-md-6">
    <div class="ehs-stat-card">
      <div class="ehs-stat-icon ehs-icon-incident">
        <i class="fas fa-file-medical"></i>
      </div>
      <div class="ehs-stat-content">
        <div class="ehs-stat-title">Total Incidents</div>
        <div class="ehs-stat-value">{{ total_incidents|default:0 }}</div>
        <div class="ehs-stat-trend">
          <i class="fas fa-arrow-down"></i>
          <span>This Month</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Environmental Data Card -->
  <div class="col-lg-3 col-md-6">
    <div class="ehs-stat-card">
      <div class="ehs-stat-icon ehs-icon-environmental">
        <i class="fas fa-leaf"></i>
      </div>
      <div class="ehs-stat-content">
        <div class="ehs-stat-title">Environmental Records</div>
        <div class="ehs-stat-value">{{ total_environmental|default:0 }}</div>
        <div class="ehs-stat-trend">
          <i class="fas fa-check"></i>
          <span>Up to date</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Inspections Card -->
  <div class="col-lg-3 col-md-6">
    <div class="ehs-stat-card">
      <div class="ehs-stat-icon ehs-icon-inspection">
        <i class="fas fa-clipboard-check"></i>
      </div>
      <div class="ehs-stat-content">
        <div class="ehs-stat-title">Inspections</div>
        <div class="ehs-stat-value">{{ total_inspections|default:0 }}</div>
        <div class="ehs-stat-trend">
          <i class="fas fa-clock"></i>
          <span>{{ pending_inspections|default:0 }} pending</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Welcome Card -->
<div class="row mt-4">
  <div class="col-12">
    <div class="ehs-card">
      <div class="card-body">
        <h4>Welcome to EHS-360, {{ user.get_full_name|default:user.username }}!</h4>
        <p class="text-muted">Health, Safety & Environment Management System</p>
        <hr>
        <div class="row">
          <div class="col-md-3">
            <strong>Role: </strong> {{ user.role_display|default:"N/A" }}
          </div>
          <div class="col-md-3">
            <strong>Username:</strong> {{ user.username }}
          </div>
          <div class="col-md-3">
            <strong>Email:</strong> {{ user.email }}
          </div>
          <div class="col-md-3">
            <strong>Last Login:</strong> {{ user.last_login|date:"M d, Y H:i" }}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions -->
<div class="row mt-4 align-items-stretch">
  
  <div class="col-md-3">
    <div class="card text-center h-100" style="border-top: 3px solid #ff9800;">
      <div class="card-body d-flex flex-column justify-content-between">
        <div>
          <i class="fas fa-exclamation-triangle fa-3x mb-3" style="color: #ff9800;"></i>
          <h5>Report Hazard</h5>
          <p class="text-muted">Report hazards & near misses</p>
        </div>
        <a href="{% url 'hazards:hazard_create' %}" class="btn btn-primary btn-sm">Report Now</a>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card text-center h-100" style="border-top: 3px solid #dc3545;">
      <div class="card-body d-flex flex-column justify-content-between">
        <div>
          <i class="fas fa-file-medical fa-3x mb-3" style="color: #dc3545;"></i>
          <h5>Report Incident</h5>
          <p class="text-muted">Report accidents and incidents</p>
        </div>
        <a href="{% url 'accidents:incident_create' %}" class="btn btn-primary btn-sm">Report Now</a>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card text-center h-100" style="border-top: 3px solid #28a745;">
      <div class="card-body d-flex flex-column justify-content-between">
        <div>
          <i class="fas fa-leaf fa-3x mb-3" style="color: #28a745;"></i>
          <h5>Environmental Data</h5>
          <p class="text-muted">Enter environmental data</p>
        </div>
        <a href="{% url 'environmental:admin-all-plants' %}" class="btn btn-primary btn-sm">Enter Data</a>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card text-center h-100" style="border-top: 3px solid #1E90FF;">
      <div class="card-body d-flex flex-column justify-content-between">
        <div>
          <i class="fas fa-clipboard-check fa-3x mb-3" style="color: #1E90FF;"></i>
          <h5>Inspections</h5>
          <p class="text-muted">Create and manage inspections</p>
        </div>
        <a href="/accidents/incidents/" class="btn btn-primary btn-sm">View All</a>
      </div>
    </div>
  </div>
</div>

<!-- Recent Activities -->
<div class="row mt-4">
  <div class="col-12">
    <div class="ehs-card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-list mr-1"></i>
          Recent Activities
        </h3>
      </div>
      <div class="card-body">

      <!-- Recent Incidents -->
      <div class="section-card">
        <div class="section-header incidents">
          <i class="fas fa-exclamation-triangle"></i>
          Recent Incidents
        </div>
        <div class="section-body">
          <table class="table table-hover incident-table">
            <thead>
              <tr>
                <th>Report #</th>
                <th>Type</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for incident in recent_incidents %}
              <tr>
                <td><strong>{{ incident.report_number }}</strong></td>
                <td>
                  <span class="badge badge-custom bg-dark">
                    {{ incident.incident_type.name }}
                  </span>
                </td>
                <td>{{ incident.incident_date|date:"d/m/y" }}</td>
                <td>
                  <span class="badge badge-custom
                  {% if incident.status == 'CLOSED' %}bg-success
                  {% elif incident.status == 'REPORTED' %}bg-secondary
                  {% else %}bg-primary{% endif %}">
                  {{ incident.get_status_display }}
                  </span>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                  No recent activities found
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <!-- Recent Hazards -->
      <div class="section-card">
        <div class="section-header hazards">
          <i class="fas fa-radiation"></i>
          Recent Hazards
        </div>
        <div class="section-body">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Report No.</th>
                <th>Type</th>
                <th>Title</th>
                <th>Date</th>
                <th>Risk Level</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for hazard in recent_hazards %}
              <tr>
                <td><strong>{{ hazard.report_number }}</strong></td>
                <td>
                  <span class="badge 
                    {% if hazard.hazard_category == 'slip_trip_fall' %}badge-warning
                    {% elif hazard.hazard_category == 'chemical' %}badge-danger
                    {% else %}badge-info{% endif %}">
                    {{ hazard.get_hazard_category_display }}
                  </span>
                </td>
                <td>{{ hazard.hazard_title|truncatewords:8 }}</td>
                <td>
                  {{ hazard.incident_datetime|date:"d/m/Y" }}<br>
                  <small class="text-muted">{{ hazard.incident_datetime|time:"H:i" }}</small>
                </td>
                <td>
                  <span class="badge 
                    {% if hazard.risk_level == 'Critical' %}badge-dark
                    {% elif hazard.risk_level == 'High' %}badge-danger
                    {% elif hazard.risk_level == 'Medium' %}badge-warning
                    {% else %}badge-success{% endif %}">
                    {{ hazard.get_severity_display }}
                  </span>
                </td>
                <td>
                  <span class="badge 
                    {% if hazard.status == 'CLOSED' or hazard.status == 'RESOLVED' %}badge-success
                    {% elif hazard.status == 'REPORTED' %}badge-secondary
                    {% elif hazard.status == 'IN_PROGRESS' %}badge-primary 
                    {% else %}badge-dark{% endif %}">
                    {{ hazard.get_status_display }}
                  </span>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="8" class="text-center">
                  <div class="alert alert-info mb-0">
                    <i class="fas fa-info-circle mr-2"></i>No hazards reported yet.
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  console.log('Dashboard loaded successfully!');
</script>
{% endblock %}