{% extends 'base/base.html' %}
{% load static %}

{% block title %}{% if object %}Edit Zone{% else %}Create Zone{% endif %}{% endblock %}
{% block page_title %}{% if object %}Edit Zone{% else %}Create New Zone{% endif %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'organizations:dashboard' %}">Organization</a></li>
<li class="breadcrumb-item"><a href="{% url 'organizations:zone_list' %}">Zones</a></li>
<li class="breadcrumb-item active">{% if object %}Edit{% else %}Create{% endif %}</li>
{% endblock %}

{% block extra_css %}
<style>
  .location-row {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 10px;
    border-left: 3px solid #28a745;
    position: relative;
  }
  
  .location-header {
    background: #28a745;
    color: white;
    padding: 10px 15px;
    border-radius: 5px 5px 0 0;
    margin: -15px -15px 15px -15px;
    font-weight: 600;
  }
  
  .sublocation-row {
    background: #fff8e1;
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 8px;
    border-left: 3px solid #ffc107;
    position: relative;
  }

  .sublocation-header {
    background: #ffc107;
    color: #000;
    padding: 8px 12px;
    border-radius: 5px 5px 0 0;
    margin: -10px -10px 10px -10px;
    font-weight: 600;
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <div class="ehs-card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-layer-group mr-2"></i>{% if object %}Edit Zone: {{ object.name }}{% else %}Create New Zone{% endif %}
        </h3>
      </div>
      
      <div class="card-body">
        <form method="POST" id="zoneForm">
          {% csrf_token %}
          
          <!-- Basic Information -->
          <h5 class="mb-3">
            <i class="fas fa-info-circle mr-2"></i>Basic Information
          </h5>
          
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="id_plant">Plant *</label>
              {{ form.plant }}
              {% if form.plant.errors %}
                <div class="text-danger">{{ form.plant.errors }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.name.id_for_label }}">Zone Name *</label>
              {{ form.name }}
              {% if form.name.errors %}
                <div class="text-danger">{{ form.name.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="{{ form.code.id_for_label }}">Zone Code *</label>
              {{ form.code }}
              {% if form.code.errors %}
                <div class="text-danger">{{ form.code.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="{{ form.description.id_for_label }}">Description</label>
              {{ form.description }}
              {% if form.description.errors %}
                <div class="text-danger">{{ form.description.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <div class="form-check">
                {{ form.is_active }}
                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                  Active
                </label>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <!-- Locations Section -->
          <div class="locations-section">
            <h5 class="mb-3">
              <i class="fas fa-map-marker-alt mr-2"></i>Locations (Optional)
            </h5>
            <p class="text-muted mb-3">Add multiple locations under this zone</p>
            
            <div id="locations-list">
              <!-- Existing locations (for edit mode) -->
              {% if object and object.locations.all %}
                {% for location in object.locations.all %}
                <div class="location-row">
                  <div class="location-header">
                    <i class="fas fa-map-marker-alt mr-2"></i>Location {{ forloop.counter }}
                  </div>
                  <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: 10px; right: 10px;" onclick="this.closest('.location-row').remove()">
                    <i class="fas fa-trash"></i>
                  </button>
                  
                  <div class="row">
                    <div class="col-md-5">
                      <div class="form-group">
                        <label>Location Name *</label>
                        <input type="text" name="location_name_{{ forloop.counter0 }}" 
                               class="form-control" 
                               value="{{ location.name }}"
                               placeholder="e.g., Production Area 1" required>
                        <input type="hidden" name="location_id_{{ forloop.counter0 }}" value="{{ location.id }}">
                      </div>
                    </div>
                    
                    <div class="col-md-5">
                      <div class="form-group">
                        <label>Location Code *</label>
                        <input type="text" name="location_code_{{ forloop.counter0 }}" 
                               class="form-control" 
                               value="{{ location.code }}"
                               placeholder="e.g., L001" required>
                      </div>
                    </div>
                    
                    <div class="col-md-2">
                      <div class="form-group">
                        <label>Active</label>
                        <div class="form-check mt-2">
                          <input type="checkbox" name="location_active_{{ forloop.counter0 }}" 
                                 class="form-check-input" value="1" 
                                 {% if location.is_active %}checked{% endif %}>
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-12">
                      <div class="form-group">
                        <label>Description</label>
                        <textarea name="location_description_{{ forloop.counter0 }}" 
                                  class="form-control" 
                                  rows="2" 
                                  placeholder="Optional description">{{ location.description }}</textarea>
                      </div>
                    </div>
                  </div>

                  <!-- Sub-Locations for this Location -->
                  <div class="sublocations-section">
                    <h6 class="mb-2"><i class="fas fa-map-pin mr-2"></i>Sub-Locations</h6>
                    <div id="sublocations-list-{{ forloop.counter0 }}">
                      {% for sublocation in location.sublocations.all %}
                      <div class="sublocation-row">
                        <div class="sublocation-header">
                          <i class="fas fa-map-pin mr-2"></i>Sub-Location {{ forloop.counter }}
                        </div>
                        <button type="button" class="btn btn-danger btn-sm" 
                                style="position: absolute; top: 5px; right: 5px;" 
                                onclick="this.closest('.sublocation-row').remove()">
                          <i class="fas fa-times"></i>
                        </button>
                        
                        <div class="row">
                          <div class="col-md-5">
                            <input type="text" 
                                   name="location_{{ forloop.parentloop.counter0 }}_sublocation_name_{{ forloop.counter0 }}" 
                                   class="form-control form-control-sm" 
                                   value="{{ sublocation.name }}"
                                   placeholder="Sub-Location Name" required>
                            <input type="hidden" 
                                   name="location_{{ forloop.parentloop.counter0 }}_sublocation_id_{{ forloop.counter0 }}" 
                                   value="{{ sublocation.id }}">
                          </div>
                          <div class="col-md-5">
                            <input type="text" 
                                   name="location_{{ forloop.parentloop.counter0 }}_sublocation_code_{{ forloop.counter0 }}" 
                                   class="form-control form-control-sm" 
                                   value="{{ sublocation.code }}"
                                   placeholder="Code">
                          </div>
                          <div class="col-md-2">
                            <div class="form-check">
                              <input type="checkbox" 
                                     name="location_{{ forloop.parentloop.counter0 }}_sublocation_active_{{ forloop.counter0 }}" 
                                     class="form-check-input" value="1" 
                                     {% if sublocation.is_active %}checked{% endif %}>
                              <label class="form-check-label" style="font-size: 0.85rem;">Active</label>
                            </div>
                          </div>
                        </div>
                      </div>
                      {% endfor %}
                    </div>
                    <input type="hidden" name="sublocation_count_{{ forloop.counter0 }}" value="{{ location.sublocations.count }}">
                    <button type="button" class="btn btn-sm btn-block btn-outline-warning" 
                            onclick="addSublocation({{ forloop.counter0 }})">
                      <i class="fas fa-plus mr-1"></i>Add Sub-Location
                    </button>
                  </div>
                </div>
                {% endfor %}
              {% endif %}
            </div>
            
            <input type="hidden" name="location_count" id="location_count" value="{% if object %}{{ object.locations.count }}{% else %}0{% endif %}">
            
            <button type="button" class="btn btn-block btn-success" onclick="addLocation()">
              <i class="fas fa-plus-circle mr-2"></i>Add Location
            </button>
          </div>

          <!-- Form Actions -->
          <div class="row mt-4">
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save mr-1"></i> {% if object %}Update Zone{% else %}Create Zone{% endif %}
              </button>
              <a href="{% url 'organizations:zone_list' %}" class="btn btn-secondary">
                <i class="fas fa-times mr-1"></i> Cancel
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let locationCounter = parseInt(document.getElementById('location_count').value);

function addLocation() {
    const list = document.getElementById('locations-list');
    const index = locationCounter;
    
    const html = `
        <div class="location-row">
            <div class="location-header">
                <i class="fas fa-map-marker-alt mr-2"></i>Location ${index + 1}
            </div>
            <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: 10px; right: 10px;" onclick="this.closest('.location-row').remove()">
                <i class="fas fa-trash"></i>
            </button>
            
            <div class="row">
                <div class="col-md-5">
                    <div class="form-group">
                        <label>Location Name *</label>
                        <input type="text" name="location_name_${index}" class="form-control" placeholder="e.g., Production Area 1" required>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="form-group">
                        <label>Location Code *</label>
                        <input type="text" name="location_code_${index}" class="form-control" placeholder="e.g., L001" required>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-group">
                        <label>Active</label>
                        <div class="form-check mt-2">
                            <input type="checkbox" name="location_active_${index}" class="form-check-input" value="1" checked>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-12">
                    <div class="form-group">
                        <label>Description</label>
                        <textarea name="location_description_${index}" class="form-control" rows="2" placeholder="Optional description"></textarea>
                    </div>
                </div>
            </div>

            <div class="sublocations-section">
                <h6 class="mb-2"><i class="fas fa-map-pin mr-2"></i>Sub-Locations</h6>
                <div id="sublocations-list-${index}"></div>
                <input type="hidden" name="sublocation_count_${index}" value="0">
                <button type="button" class="btn btn-sm btn-block btn-outline-warning" onclick="addSublocation(${index})">
                    <i class="fas fa-plus mr-1"></i>Add Sub-Location
                </button>
            </div>
        </div>
    `;
    
    list.insertAdjacentHTML('beforeend', html);
    locationCounter++;
    document.getElementById('location_count').value = locationCounter;
}

function addSublocation(locationIndex) {
    const list = document.getElementById(`sublocations-list-${locationIndex}`);
    const countInput = document.querySelector(`input[name="sublocation_count_${locationIndex}"]`);
    const sublocationIndex = parseInt(countInput.value);
    
    const html = `
        <div class="sublocation-row">
            <div class="sublocation-header">
                <i class="fas fa-map-pin mr-2"></i>Sub-Location ${sublocationIndex + 1}
            </div>
            <button type="button" class="btn btn-danger btn-sm" style="position: absolute; top: 5px; right: 5px;" onclick="this.closest('.sublocation-row').remove()">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="row">
                <div class="col-md-5">
                    <input type="text" name="location_${locationIndex}_sublocation_name_${sublocationIndex}" class="form-control form-control-sm" placeholder="Sub-Location Name" required>
                </div>
                <div class="col-md-5">
                    <input type="text" name="location_${locationIndex}_sublocation_code_${sublocationIndex}" class="form-control form-control-sm" placeholder="Code">
                </div>
                <div class="col-md-2">
                    <div class="form-check">
                        <input type="checkbox" name="location_${locationIndex}_sublocation_active_${sublocationIndex}" class="form-check-input" value="1" checked>
                        <label class="form-check-label" style="font-size: 0.85rem;">Active</label>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    list.insertAdjacentHTML('beforeend', html);
    countInput.value = sublocationIndex + 1;
}
</script>
{% endblock %}