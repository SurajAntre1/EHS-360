{% extends 'base/base.html' %}
{% load static %}

{% block title %}Locations{% endblock %}
{% block page_title %}Locations Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'organizations:dashboard' %}">Organization</a></li>
<li class="breadcrumb-item active">Locations</li>
{% endblock %}

{% block extra_css %}
<style>
  .sublocation-list {
    margin: 0;
    padding-left: 20px;
    font-size: 0.85rem;
    color: #6c757d;
  }
  
  .sublocation-item {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-bottom: 3px;
  }
  
  .sublocation-badge {
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 10px;
  }
  
  .sublocation-toggle {
    cursor: pointer;
    color: #007bff;
    text-decoration: none;
    font-size: 0.85rem;
  }
  
  .sublocation-toggle:hover {
    text-decoration: underline;
  }
  
  .sublocations-container {
    display: none;
    margin-top: 8px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    border-left: 3px solid #007bff;
  }
  
  .sublocations-container.show {
    display: block;
  }
</style>
{% endblock %}

{% block content %}
<div class="ehs-card">
  <div class="card-header">
    <div class="row align-items-center">
      <div class="col">
        <h3 class="card-title mb-0">
          <i class="fas fa-map-marker-alt mr-2"></i>All Locations
        </h3>
      </div>
      <div class="col-auto">
        <a href="{% url 'organizations:location_create' %}" class="btn btn-primary">
          <i class="fas fa-plus mr-1"></i> Add New Location
        </a>
      </div>
    </div>
  </div>
  
  <div class="card-body">
    <!-- Search and Filter -->
    <form method="GET" class="mb-4">
      <div class="row">
        <div class="col-md-3">
          <input type="text" name="search" class="form-control" 
                 placeholder="Search by name, code..." 
                 value="{{ search_query }}">
        </div>
        <div class="col-md-2">
          <select name="plant" class="form-control" id="filter_plant">
            <option value="">All Plants</option>
            {% for plant in plants %}
            <option value="{{ plant.id }}" {% if selected_plant == plant.id|stringformat:"s" %}selected{% endif %}>
              {{ plant.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <select name="zone" class="form-control" id="filter_zone">
            <option value="">All Zones</option>
            {% for zone in zones %}
            <option value="{{ zone.id }}" data-plant="{{ zone.plant_id }}" {% if selected_zone == zone.id|stringformat:"s" %}selected{% endif %}>
              {{ zone.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <select name="status" class="form-control">
            <option value="">All Status</option>
            <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>Inactive</option>
          </select>
        </div>
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-search"></i> Filter
          </button>
          <a href="{% url 'organizations:location_list' %}" class="btn btn-secondary">
            <i class="fas fa-redo"></i> Reset
          </a>
        </div>
      </div>
    </form>

    <!-- Locations Table -->
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Zone</th>
            <th>Plant</th>
            <th>Sub-Locations</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for location in locations %}
          <tr>
            <td><strong>{{ location.code }}</strong></td>
            <td>
              {{ location.name }}
              {% if location.description %}
                <br><small class="text-muted">{{ location.description|truncatewords:8 }}</small>
              {% endif %}
            </td>
            <td>
              <span class="badge badge-info">{{ location.zone.name }}</span>
            </td>
            <td>
              <span class="badge badge-primary">{{ location.zone.plant.name }}</span>
            </td>
            <td>
              {% if location.sublocations.all %}
                <div>
                  <span class="badge badge-secondary">
                    {{ location.sublocations.count }} Sub-location{{ location.sublocations.count|pluralize }}
                  </span>
                  <a href="javascript:void(0)" 
                     class="sublocation-toggle ml-2" 
                     onclick="toggleSublocations('subloc-{{ location.id }}')">
                    <i class="fas fa-chevron-down"></i> View
                  </a>
                </div>
                
                <!-- Sublocations Container -->
                <div id="subloc-{{ location.id }}" class="sublocations-container">
                  <strong class="d-block mb-2">
                    <i class="fas fa-map-pin mr-1"></i>Sub-Locations:
                  </strong>
                  <ul class="sublocation-list">
                    {% for sublocation in location.sublocations.all %}
                    <li class="sublocation-item">
                      <i class="fas fa-angle-right"></i>
                      <strong>{{ sublocation.name }}</strong>
                      {% if sublocation.code %}
                        <span class="sublocation-badge badge badge-light">{{ sublocation.code }}</span>
                      {% endif %}
                      {% if sublocation.is_active %}
                        <span class="sublocation-badge badge badge-success">Active</span>
                      {% else %}
                        <span class="sublocation-badge badge badge-danger">Inactive</span>
                      {% endif %}
                      {% if sublocation.description %}
                        <br><small class="text-muted ml-3">{{ sublocation.description|truncatewords:10 }}</small>
                      {% endif %}
                    </li>
                    {% endfor %}
                  </ul>
                </div>
              {% else %}
                <span class="text-muted">
                  <i class="fas fa-minus-circle"></i> None
                </span>
              {% endif %}
            </td>
            <td>
              {% if location.is_active %}
                <span class="badge badge-success">Active</span>
              {% else %}
                <span class="badge badge-danger">Inactive</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group" role="group">
                <a href="{% url 'organizations:location_update' location.pk %}" 
                   class="btn btn-sm btn-primary" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="{% url 'organizations:location_delete' location.pk %}" 
                   class="btn btn-sm btn-danger" title="Delete"
                   onclick="return confirm('Are you sure you want to delete this location and all its sub-locations?');">
                  <i class="fas fa-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="text-center">
              <div class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>No locations found.
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
        </li>
        {% endif %}
        
        <li class="page-item active">
          <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>
        
        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filter zones based on selected plant
document.getElementById('filter_plant').addEventListener('change', function() {
    var plantId = this.value;
    var zoneSelect = document.getElementById('filter_zone');
    var options = zoneSelect.querySelectorAll('option');
    
    options.forEach(function(option) {
        if (option.value === '') {
            option.style.display = 'block';
        } else if (plantId === '' || option.dataset.plant === plantId) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Reset zone selection if current selection is hidden
    if (zoneSelect.selectedOptions[0] && zoneSelect.selectedOptions[0].style.display === 'none') {
        zoneSelect.value = '';
    }
});

// Toggle Sublocations Display
function toggleSublocations(containerId) {
    const container = document.getElementById(containerId);
    const toggle = container.previousElementSibling.querySelector('.sublocation-toggle');
    const icon = toggle.querySelector('i');
    
    if (container.classList.contains('show')) {
        container.classList.remove('show');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
        toggle.innerHTML = '<i class="fas fa-chevron-down"></i> View';
    } else {
        container.classList.add('show');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
        toggle.innerHTML = '<i class="fas fa-chevron-up"></i> Hide';
    }
}
</script>
{% endblock %}