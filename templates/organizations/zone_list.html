{% extends 'base/base.html' %}
{% load static %}

{% block title %}Zones{% endblock %}
{% block page_title %}Zones Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'organizations:dashboard' %}">Organization</a></li>
<li class="breadcrumb-item active">Zones</li>
{% endblock %}

{% block extra_css %}
<style>
  .locations-dropdown {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    margin-top: 10px;
    border-left: 3px solid #28a745;
  }
  
  .location-item {
    background: white;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 3px;
    border: 1px solid #dee2e6;
  }
  
  .sublocation-badge {
    font-size: 0.75rem;
    margin: 2px;
  }
  
  .expand-btn {
    cursor: pointer;
    transition: transform 0.2s;
  }
  
  .expand-btn:hover {
    transform: scale(1.1);
  }

  .location-name-list {
    font-size: 0.85rem;
    color: #495057;
  }

  .location-name-item {
    display: inline-block;
    background: #e7f3ff;
    padding: 2px 8px;
    border-radius: 3px;
    margin: 2px;
  }
</style>
{% endblock %}

{% block content %}
<div class="ehs-card">
  <div class="card-header">
    <div class="row align-items-center">
      <div class="col">
        <h3 class="card-title mb-0">
          <i class="fas fa-layer-group mr-2"></i>All Zones
        </h3>
      </div>
      <div class="col-auto">
        <a href="{% url 'organizations:zone_create' %}" class="btn btn-primary">
          <i class="fas fa-plus mr-1"></i> Add New Zone
        </a>
      </div>
    </div>
  </div>
  
  <div class="card-body">
    <!-- Search and Filter -->
    <form method="GET" class="mb-4">
      <div class="row">
        <div class="col-md-4">
          <input type="text" name="search" class="form-control" 
                 placeholder="Search by name, code, plant..." 
                 value="{{ search_query }}">
        </div>
        <div class="col-md-3">
          <select name="plant" class="form-control">
            <option value="">All Plants</option>
            {% for plant in plants %}
            <option value="{{ plant.id }}" {% if selected_plant == plant.id|stringformat:"s" %}selected{% endif %}>
              {{ plant.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <select name="status" class="form-control">
            <option value="">All Status</option>
            <option value="active" {% if selected_status == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if selected_status == 'inactive' %}selected{% endif %}>Inactive</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary btn-block">
            <i class="fas fa-search"></i> Filter
          </button>
        </div>
      </div>
    </form>

    <!-- Zones Table -->
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th width="3%"></th>
            <th>Code</th>
            <th>Name</th>
            <th>Plant</th>
            <th>Locations</th>
            <th>Sub-Locations</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for zone in zones %}
          <tr>
            <td class="text-center">
              {% if zone.locations.exists %}
              <i class="fas fa-chevron-right expand-btn" 
                 onclick="toggleLocations({{ zone.id }})" 
                 id="icon-{{ zone.id }}"
                 title="Click to view details"></i>
              {% endif %}
            </td>
            <td><strong>{{ zone.code }}</strong></td>
            <td>{{ zone.name }}</td>
            <td>
              <span class="badge badge-primary">{{ zone.plant.name }}</span>
            </td>
            <td>
              <div class="mb-1">
                <span class="badge badge-info">
                  <i class="fas fa-map-marker-alt mr-1"></i>{{ zone.total_locations }}
                </span>
                <span class="badge badge-success">{{ zone.active_locations }} Active</span>
              </div>
              {% if zone.locations.exists %}
              <div class="location-name-list">
                {% for location in zone.locations.all|slice:":3" %}
                  <span class="location-name-item">{{ location.code }}</span>
                {% endfor %}
                {% if zone.locations.count > 3 %}
                  <span class="text-muted">+{{ zone.locations.count|add:"-3" }} more</span>
                {% endif %}
              </div>
              {% endif %}
            </td>
            <td>
              {% with subloc_count=zone.locations.all|length %}
                {% if subloc_count > 0 %}
                  <span class="badge badge-warning">
                    <i class="fas fa-map-pin mr-1"></i>
                    {% for location in zone.locations.all %}
                      {{ location.sublocations.count }}{% if not forloop.last %} + {% endif %}
                    {% endfor %}
                    Total
                  </span>
                {% else %}
                  <span class="badge badge-secondary">0</span>
                {% endif %}
              {% endwith %}
            </td>
            <td>
              {% if zone.is_active %}
                <span class="badge badge-success">Active</span>
              {% else %}
                <span class="badge badge-danger">Inactive</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group" role="group">
                <a href="{% url 'organizations:zone_update' zone.pk %}" 
                   class="btn btn-sm btn-primary" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                <a href="{% url 'organizations:zone_delete' zone.pk %}" 
                   class="btn btn-sm btn-danger" title="Delete"
                   onclick="return confirm('Are you sure you want to delete this zone?');">
                  <i class="fas fa-trash"></i>
                </a>
              </div>
            </td>
          </tr>
          
          <!-- Expandable Locations Row -->
          {% if zone.locations.exists %}
          <tr id="locations-{{ zone.id }}" style="display: none;">
            <td colspan="8">
              <div class="locations-dropdown">
                <h6 class="mb-3">
                  <i class="fas fa-map-marker-alt text-success mr-2"></i>
                  Locations in {{ zone.name }} ({{ zone.locations.count }})
                </h6>
                <div class="row">
                  {% for location in zone.locations.all %}
                  <div class="col-md-6 mb-2">
                    <div class="location-item">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <strong>{{ location.code }}</strong> - {{ location.name }}
                          {% if not location.is_active %}
                            <span class="badge badge-danger badge-sm">Inactive</span>
                          {% endif %}
                        </div>
                        <div>
                          <a href="{% url 'organizations:zone_update' zone.pk %}"
                           
                             class="btn btn-sm btn-outline-primary" title="Edit Location">
                            <i class="fas fa-edit"></i>
                          </a>
                        </div>
                      </div>
                      
                      {% if location.sublocations.exists %}
                      <div class="mt-2">
                        <small class="text-muted">
                          <i class="fas fa-map-pin mr-1"></i>Sub-Locations ({{ location.sublocations.count }}):
                        </small>
                        <div class="mt-1">
                          {% for sublocation in location.sublocations.all %}
                            <span class="badge badge-secondary sublocation-badge" title="{{ sublocation.name }}">
                              {{ sublocation.code|default:sublocation.name }}
                              {% if not sublocation.is_active %}
                                <i class="fas fa-ban text-danger" title="Inactive"></i>
                              {% endif %}
                            </span>
                          {% endfor %}
                        </div>
                      </div>
                      {% else %}
                      <div class="mt-2">
                        <small class="text-muted">
                          <i class="fas fa-info-circle mr-1"></i>No sub-locations
                        </small>
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </td>
          </tr>
          {% endif %}
          {% empty %}
          <tr>
            <td colspan="8" class="text-center">
              <div class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>No zones found.
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_plant %}&plant={{ selected_plant }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Previous</a>
        </li>
        {% endif %}
        
        <li class="page-item active">
          <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
        </li>
        
        {% if page_obj.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_plant %}&plant={{ selected_plant }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}">Next</a>
        </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleLocations(zoneId) {
  const row = document.getElementById('locations-' + zoneId);
  const icon = document.getElementById('icon-' + zoneId);
  
  if (row.style.display === 'none') {
    row.style.display = 'table-row';
    icon.classList.remove('fa-chevron-right');
    icon.classList.add('fa-chevron-down');
  } else {
    row.style.display = 'none';
    icon.classList.remove('fa-chevron-down');
    icon.classList.add('fa-chevron-right');
  }
}
</script>
{% endblock %}