{% extends 'base/base.html' %}
{% load static %}

{% block title %}Unit Management{% endblock %}
{% block page_title %}Unit Management{% endblock %}

{% block extra_css %}
<style>
/* ==================== ROOT VARIABLES ==================== */
:root {
    --primary-color: #2196f3;
    --primary-dark: #1976d2;
    --success-color: #4caf50;
    --danger-color: #f44336;
    --warning-color: #ff9800;
    --info-color: #00bcd4;
    --border-color: #dee2e6;
    --bg-light: #f8f9fa;
    --bg-white: #ffffff;
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
    --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
    --radius: 8px;
}

/* ==================== GENERAL STYLES ==================== */
.ehs-card {
    border: none;
    box-shadow: var(--shadow-md);
    border-radius: var(--radius);
    margin-bottom: 20px;
}

.card-header {
    border-radius: var(--radius) var(--radius) 0 0 !important;
    padding: 1.5rem;
}

.card-header h3 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
}

/* ==================== TAB NAVIGATION ==================== */
.nav-tabs {
    border-bottom: 2px solid var(--border-color);
}

.nav-tabs .nav-link {
    color: var(--text-secondary);
    border: none;
    padding: 12px 24px;
    font-weight: 500;
    transition: all 0.3s;
}

.nav-tabs .nav-link:hover {
    color: var(--primary-color);
    background: rgba(33, 150, 243, 0.1);
}

.nav-tabs .nav-link.active {
    color: var(--primary-color);
    background: var(--bg-white);
    border-bottom: 3px solid var(--primary-color);
    font-weight: 600;
}

/* ==================== ALERT STYLES ==================== */
.alert {
    border-radius: var(--radius);
    border-left: 4px solid;
    padding: 15px 20px;
}

.alert-info {
    background: #e3f2fd;
    border-left-color: var(--info-color);
    color: #01579b;
}

.alert-warning {
    background: #fff3e0;
    border-left-color: var(--warning-color);
    color: #e65100;
}

.alert-danger {
    background: #ffebee;
    border-left-color: var(--danger-color);
    color: #b71c1c;
}

.alert-success {
    background: #e8f5e9;
    border-left-color: var(--success-color);
    color: #1b5e20;
}

/* ==================== FORM SECTIONS ==================== */
.form-section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 20px;
    border-radius: var(--radius);
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
}

.form-section-header h5 {
    margin: 0;
    font-weight: 600;
    font-size: 1.1rem;
}

.unit-form-section {
    background-color: var(--bg-white);
    border: 2px solid var(--border-color);
    border-radius: var(--radius);
    padding: 25px;
    margin-bottom: 20px;
}

/* ==================== FORM CONTROLS ==================== */
.form-control {
    border: 2px solid var(--border-color);
    border-radius: 6px;
    padding: 10px 15px;
    height: 45px;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
    outline: none;
}

.form-check-input {
    width: 20px;
    height: 20px;
    margin-top: 0;
}

.form-check-label {
    margin-left: 8px;
    font-weight: 500;
}

/* ==================== CONVERSION INFO ==================== */
.conversion-info {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    border: 2px solid var(--info-color);
    padding: 15px 20px;
    border-radius: var(--radius);
    margin-top: 15px;
}

.conversion-info h6 {
    margin: 0 0 8px 0;
    color: #01579b;
    font-weight: 600;
}

.conversion-info p {
    margin: 0;
    font-size: 1.1rem;
    color: #01579b;
}

/* ==================== BUTTONS ==================== */
.btn {
    padding: 10px 24px;
    font-weight: 600;
    border-radius: 6px;
    transition: all 0.3s;
    border: none;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-success {
    background: var(--success-color);
    color: white;
}

.btn-success:hover {
    background: #45a049;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.btn-danger {
    background: var(--danger-color);
    color: white;
}

.btn-danger:hover {
    background: #da190b;
}

.btn-secondary {
    background: var(--text-secondary);
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-outline-danger {
    border: 2px solid var(--danger-color);
    color: var(--danger-color);
    background: transparent;
}

.btn-outline-danger:hover {
    background: var(--danger-color);
    color: white;
}

.btn-info {
    background: var(--info-color);
    color: white;
}

.btn-info:hover {
    background: #0097a7;
}

/* ==================== CATEGORY CARDS ==================== */
.category-card {
    background-color: var(--bg-white);
    border: 2px solid #e3f2fd;
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.category-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.category-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 2px solid var(--border-color);
}

.category-name {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--primary-dark);
}

.category-description {
    color: var(--text-secondary);
    font-size: 0.95rem;
    margin-bottom: 15px;
    font-style: italic;
}

/* ==================== STATUS BADGES ==================== */
.status-badge {
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
    color: #1b5e20;
}

.status-inactive {
    background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
    color: #b71c1c;
}

/* ==================== UNIT BADGES ==================== */
.unit-badges-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.unit-badge {
    display: inline-flex;
    align-items: center;
    padding: 8px 16px;
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid var(--primary-color);
    border-radius: 20px;
    font-size: 0.9rem;
    color: #0d47a1;
    transition: all 0.3s;
}

.unit-badge:hover {
    box-shadow: var(--shadow-sm);
    transform: translateY(-2px);
}

.unit-badge strong {
    font-weight: 700;
    margin-right: 5px;
}

.unit-badge .conversion-rate {
    font-weight: 600;
    color: #1565c0;
    margin-left: 5px;
}

.unit-badge a {
    margin-left: 8px;
    transition: all 0.2s;
}

.unit-badge a:hover i {
    transform: scale(1.2);
}

/* ==================== EMPTY STATE ==================== */
.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 5rem;
    margin-bottom: 20px;
    opacity: 0.3;
    color: var(--primary-color);
}

.empty-state h5 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 10px;
}

/* ==================== MODAL ==================== */
.modal-content {
    border-radius: var(--radius);
    border: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
}

.modal-header {
    border-radius: var(--radius) var(--radius) 0 0;
}

.modal-header.bg-danger {
    background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%) !important;
}

/* ==================== VALIDATION STYLES ==================== */
.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* ==================== RESPONSIVE ==================== */
@media (max-width: 768px) {
    .category-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }

    .unit-form-section {
        padding: 15px;
    }

    .btn {
        width: 100%;
        margin-bottom: 10px;
    }

    .action-buttons {
        flex-direction: column;
        width: 100%;
    }
}

/* ==================== UTILITY CLASSES ==================== */
.action-buttons {
    display: flex;
    gap: 10px;
}

.badge {
    display: inline-block;
    padding: 0.35rem 0.65rem;
    font-size: 0.875rem;
    font-weight: 600;
    border-radius: 0.375rem;
}

.badge-primary {
    background: var(--primary-color);
    color: white;
}

.badge-info {
    background: var(--info-color);
    color: white;
}
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'environmental:plant-entry' %}">Home</a></li>
<li class="breadcrumb-item"><a href="#">Environmental Management</a></li>
<li class="breadcrumb-item active">Unit Management</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <div class="ehs-card">
      <div class="card-header bg-primary text-white">
        <h3 class="card-title mb-0">
          <i class="fas fa-balance-scale mr-2"></i>Unit Management System
        </h3>
      </div>

      <!-- Tab Navigation -->
      <ul class="nav nav-tabs mt-3 ml-3" id="unitTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="create-tab" data-toggle="tab" href="#create" role="tab">
            <i class="fas fa-plus-circle mr-1"></i>Create Units
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="list-tab" data-toggle="tab" href="#list" role="tab">
            <i class="fas fa-list mr-1"></i>View All Units
          </a>
        </li>
      </ul>

      <div class="tab-content p-3">
        <!-- ==================== CREATE TAB ==================== -->
        <div class="tab-pane fade show active" id="create" role="tabpanel">
          <form method="POST" id="unitManagementForm">
            {% csrf_token %}
            
            <div class="card-body">
              <!-- Alert Info -->
              <div class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>Note:</strong> Create unit categories first, then add individual units with their conversion rates.
                All fields marked with <span class="text-danger">*</span> are mandatory.
              </div>

              <!-- Success/Error Messages -->
              <!-- {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {% if message.tags == 'success' %}
                      <i class="fas fa-check-circle mr-2"></i>
                    {% elif message.tags == 'error' or message.tags == 'danger' %}
                      <i class="fas fa-exclamation-circle mr-2"></i>
                    {% elif message.tags == 'warning' %}
                      <i class="fas fa-exclamation-triangle mr-2"></i>
                    {% else %}
                      <i class="fas fa-info-circle mr-2"></i>
                    {% endif %}
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                {% endfor %}
              {% endif %} -->

              <!-- ==================== SECTION 1: UNIT CATEGORY FORM ==================== -->
              <div class="form-section-header">
                <h5><i class="fas fa-folder-plus mr-2"></i>Step 1: Create Unit Category</h5>
              </div>

              <div class="unit-form-section">
                <div class="alert alert-warning">
                  <i class="fas fa-lightbulb mr-2"></i>
                  <strong>Tip:</strong> A Unit Category groups related units together (e.g., Weight, Volume, Energy).
                  Create categories before adding individual units.
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="id_category_name">Category Name <span class="text-danger">*</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="id_category_name" 
                           name="category_name" 
                           placeholder="e.g., Weight, Volume, Energy"
                           maxlength="100">
                    <small class="form-text text-muted">Examples: Weight, Volume, Energy, Time, Distance</small>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="id_category_is_active">Status</label>
                    <div class="form-check mt-2">
                      <input type="checkbox" 
                             class="form-check-input" 
                             id="id_category_is_active" 
                             name="category_is_active"
                             checked>
                      <label class="form-check-label" for="id_category_is_active">
                        Active
                      </label>
                    </div>
                    <small class="form-text text-muted">Inactive categories won't appear in selections</small>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="id_category_description">Description</label>
                    <textarea class="form-control" 
                              id="id_category_description" 
                              name="category_description" 
                              rows="3" 
                              placeholder="Brief description of what this category represents"></textarea>
                    <small class="form-text text-muted">Optional: Brief description of what this category represents</small>
                  </div>
                </div>

                <div class="text-right">
                  <button type="submit" name="action" value="create_category" class="btn btn-primary">
                    <i class="fas fa-save mr-2"></i>Save Category
                  </button>
                </div>
              </div>

              <hr class="my-4">

              <!-- ==================== SECTION 2: UNIT FORM ==================== -->
              <div class="form-section-header">
                <h5><i class="fas fa-ruler-combined mr-2"></i>Step 2: Add Individual Units</h5>
              </div>

              <div class="unit-form-section">
                <div class="alert alert-warning">
                  <i class="fas fa-lightbulb mr-2"></i>
                  <strong>Tip:</strong> Select a category, then add units with their conversion rates relative to the base unit.
                  Example: If base unit is 'kg', then 'MT' would have conversion rate 1000 (1 MT = 1000 kg).
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="id_unit_category">Select Category <span class="text-danger">*</span></label>
                    <select class="form-control" id="id_unit_category" name="unit_category">
                      <option value="">-- Select Category --</option>
                      {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.name }}</option>
                      {% endfor %}
                    </select>
                    <small class="form-text text-muted">Choose the category this unit belongs to</small>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="id_unit_name">Unit Name <span class="text-danger">*</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="id_unit_name" 
                           name="unit_name" 
                           placeholder="e.g., kg, MT, m³, kWh"
                           maxlength="50">
                    <small class="form-text text-muted">e.g., kg, MT, m³, kWh, liters</small>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="id_unit_base_unit">Base Unit <span class="text-danger">*</span></label>
                    <input type="text" 
                           class="form-control" 
                           id="id_unit_base_unit" 
                           name="unit_base_unit" 
                           placeholder="e.g., kg, liters, meters"
                           maxlength="50">
                    <small class="form-text text-muted">The reference unit for this category (e.g., kg for Weight)</small>
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="id_unit_conversion_rate">Conversion Rate <span class="text-danger">*</span></label>
                    <input type="number" 
                           class="form-control" 
                           id="id_unit_conversion_rate" 
                           name="unit_conversion_rate" 
                           placeholder="e.g., 1000 (for MT to kg)"
                           step="0.0001"
                           min="0.0001">
                    <small class="form-text text-muted">How many base units equal 1 of this unit</small>
                  </div>
                </div>

                <!-- Conversion Rate Explanation -->
                <div class="conversion-info" id="conversionInfo" style="display: none;">
                  <h6><i class="fas fa-calculator mr-2"></i>Conversion Preview:</h6>
                  <p id="conversionText" class="mb-0"></p>
                </div>

                <div class="row mt-3">
                  <div class="col-md-6 mb-3">
                    <label for="id_unit_is_active">Status</label>
                    <div class="form-check mt-2">
                      <input type="checkbox" 
                             class="form-check-input" 
                             id="id_unit_is_active" 
                             name="unit_is_active"
                             checked>
                      <label class="form-check-label" for="id_unit_is_active">
                        Active
                      </label>
                    </div>
                    <small class="form-text text-muted">Inactive units won't appear in selections</small>
                  </div>
                </div>

                <div class="text-right">
                  <button type="submit" name="action" value="create_unit" class="btn btn-success">
                    <i class="fas fa-plus-circle mr-2"></i>Add Unit
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>

        <!-- ==================== LIST TAB ==================== -->
        <div class="tab-pane fade" id="list" role="tabpanel">
          <div class="card-body">
            <h5 class="mb-4">
              <i class="fas fa-list-alt mr-2"></i>All Unit Categories & Units
              <span class="badge badge-primary ml-2">{{ categories.count }} Categories</span>
            </h5>

            {% if categories %}
              {% for category in categories %}
              <div class="category-card">
                <div class="category-header">
                  <div>
                    <span class="category-name">
                      <i class="fas fa-folder-open mr-2"></i>{{ category.name }}
                    </span>
                    <span class="status-badge {% if category.is_active %}status-active{% else %}status-inactive{% endif %} ml-2">
                      {% if category.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                  </div>
                  <div class="action-buttons">
                    <button type="button"
                            class="btn btn-sm btn-outline-danger"
                            onclick="confirmDelete('category', {{ category.id }}, '{{ category.name }}')">
                      <i class="fas fa-trash mr-1"></i> Delete
                    </button>
                  </div>
                </div>

                {% if category.description %}
                <div class="category-description">
                  <i class="fas fa-info-circle mr-1"></i>{{ category.description }}
                </div>
                {% endif %}

                <div class="mt-3">
                  <strong class="d-block mb-2">
                    <i class="fas fa-ruler mr-2"></i>Units in this category:
                    <span class="badge badge-info ml-1">{{ category.units.count }}</span>
                  </strong>
                  
                  {% if category.units.all %}
                    <div class="unit-badges-container">
                      {% for unit in category.units.all %}
                        <span class="unit-badge">
                          <strong>{{ unit.name }}</strong>
                          <span class="conversion-rate">
                            (1 {{ unit.name }} = {{ unit.conversion_rate }} {{ unit.base_unit }})
                          </span>

                          {% if not unit.is_active %}
                            <span class="badge badge-danger ml-1">Inactive</span>
                          {% endif %}

                          <!-- Delete button -->
                          <a href="#" onclick="confirmDelete('unit', {{ unit.id }}, '{{ unit.name }}'); return false;"
                             title="Delete Unit">
                            <i class="fas fa-times-circle text-danger"></i>
                          </a>
                        </span>
                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="text-muted mb-0">
                      <i class="fas fa-inbox mr-1"></i><em>No units added yet for this category</em>
                    </p>
                  {% endif %}
                </div>
              </div>
              {% endfor %}
            {% else %}
              <div class="empty-state">
                <i class="fas fa-inbox"></i>
                <h5>No Categories Found</h5>
                <p class="text-muted">Start by creating a unit category in the "Create Units" tab.</p>
                <a href="#create" data-toggle="tab" class="btn btn-primary mt-3">
                  <i class="fas fa-plus-circle mr-2"></i>Create First Category
                </a>
              </div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card-footer bg-light">
        <a href="{% url 'environmental:plant-entry' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
        <a href="{% url 'environmental:questions-manager' %}" class="btn btn-info float-right">
          <i class="fas fa-question-circle mr-2"></i>Manage Questions
        </a>
      </div>
    </div>
  </div>
</div>

<!-- ==================== DELETE CONFIRMATION MODAL ==================== -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">
          <i class="fas fa-exclamation-triangle mr-2"></i>Confirm Deletion
        </h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p id="deleteMessage"></p>
        <p class="text-danger mb-0">
          <strong><i class="fas fa-exclamation-circle mr-1"></i>Warning:</strong> This action cannot be undone.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          <i class="fas fa-times mr-2"></i>Cancel
        </button>
        <form id="deleteForm" method="POST" style="display: inline;">
          {% csrf_token %}
          <input type="hidden" name="action" id="deleteAction">
          <input type="hidden" name="category_id" id="deleteCategoryId">
          <input type="hidden" name="unit_id" id="deleteUnitId">
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash mr-2"></i>Yes, Delete
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // ==================== CONVERSION RATE PREVIEW ====================
    function updateConversionPreview() {
        const rate = $('#id_unit_conversion_rate').val();
        const unitName = $('#id_unit_name').val();
        const baseUnit = $('#id_unit_base_unit').val();
        
        if (rate && unitName && baseUnit) {
            const conversionInfo = $('#conversionInfo');
            const conversionText = $('#conversionText');
            
            conversionText.html(`<strong>1 ${unitName}</strong> = <strong>${rate} ${baseUnit}</strong>`);
            conversionInfo.slideDown();
        } else {
            $('#conversionInfo').slideUp();
        }
    }

    // Trigger on input changes
    $('#id_unit_conversion_rate, #id_unit_name, #id_unit_base_unit').on('input', updateConversionPreview);

    // ==================== DELETE CONFIRMATION ====================
    window.confirmDelete = function(type, id, name) {
        const modal = $('#deleteModal');
        const deleteMessage = $('#deleteMessage');
        const deleteAction = $('#deleteAction');
        const deleteCategoryId = $('#deleteCategoryId');
        const deleteUnitId = $('#deleteUnitId');

        // Reset hidden fields
        deleteCategoryId.val('');
        deleteUnitId.val('');

        if (type === 'category') {
            deleteAction.val('delete_category');
            deleteCategoryId.val(id);
            deleteMessage.html(
                `Are you sure you want to delete the category <strong>"${name}"</strong>?<br><br>` +
                `<span class="text-danger"><strong><i class="fas fa-exclamation-triangle mr-1"></i>All units in this category will also be deactivated!</strong></span>`
            );
        } else if (type === 'unit') {
            deleteAction.val('delete_unit');
            deleteUnitId.val(id);
            deleteMessage.html(
                `Are you sure you want to delete the unit <strong>"${name}"</strong>?`
            );
        }

        modal.modal('show');
    };

    // ==================== AUTO-DISMISS SUCCESS ALERTS ====================
    setTimeout(function() {
        $('.alert-success').fadeOut('slow');
    }, 5000);

    // ==================== DYNAMIC FORM VALIDATION ====================
    // Handle form submission with dynamic validation based on which button clicked
    $('#unitManagementForm').on('submit', function(e) {
        // Get which button was clicked
        const submitButton = $(document.activeElement);
        const action = submitButton.val();
        
        // Clear previous validation
        $('.is-invalid').removeClass('is-invalid');
        
        if (action === 'create_category') {
            // Validate Step 1 fields only
            const categoryName = $('#id_category_name').val().trim();
            
            if (!categoryName) {
                e.preventDefault();
                $('#id_category_name').addClass('is-invalid');
                alert('Please enter a category name');
                $('#id_category_name').focus();
                return false;
            }
        }
        
        if (action === 'create_unit') {
            // Validate Step 2 fields only
            const category = $('#id_unit_category').val();
            const unitName = $('#id_unit_name').val().trim();
            const baseUnit = $('#id_unit_base_unit').val().trim();
            const conversionRate = $('#id_unit_conversion_rate').val();
            
            if (!category) {
                e.preventDefault();
                $('#id_unit_category').addClass('is-invalid');
                alert('Please select a category');
                $('#id_unit_category').focus();
                return false;
            }
            
            if (!unitName) {
                e.preventDefault();
                $('#id_unit_name').addClass('is-invalid');
                alert('Please enter a unit name');
                $('#id_unit_name').focus();
                return false;
            }
            
            if (!baseUnit) {
                e.preventDefault();
                $('#id_unit_base_unit').addClass('is-invalid');
                alert('Please enter a base unit');
                $('#id_unit_base_unit').focus();
                return false;
            }
            
            if (!conversionRate || parseFloat(conversionRate) <= 0) {
                e.preventDefault();
                $('#id_unit_conversion_rate').addClass('is-invalid');
                alert('Please enter a valid conversion rate (greater than 0)');
                $('#id_unit_conversion_rate').focus();
                return false;
            }
        }
    });

    // ==================== SMOOTH TAB SWITCHING ====================
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        // Scroll to top when switching tabs
        $('html, body').animate({ scrollTop: 0 }, 300);
    });
});
</script>
{% endblock %}