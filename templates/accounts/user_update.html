{% extends 'base/base.html' %}
{% load static %}

{% block title %}Edit User{% endblock %}
{% block page_title %}Edit User{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'accounts:user_list' %}">User Management</a></li>
<li class="breadcrumb-item active">Edit User</li>
{% endblock %}

{% block extra_css %}
<style>
  .form-helper-text {
    font-size: 0.875rem;
    color: #6c757d;
    margin-top: 0.25rem;
  }
  
  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 10px;
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    padding: 15px;
    border-radius: 5px;
    background: #f8f9fa;
  }
  
  .checkbox-item {
    display: flex;
    align-items: center;
    padding: 8px;
    background: white;
    border-radius: 4px;
    border: 1px solid #e9ecef;
  }
  
  .checkbox-item:hover {
    background: #e7f3ff;
  }
  
  .checkbox-item input[type="checkbox"] {
    margin-right: 10px;
  }
  
  .select-all-section {
    margin-bottom: 10px;
    padding: 10px;
    background: #e9ecef;
    border-radius: 5px;
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-10 offset-md-1">
    <div class="ehs-card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="fas fa-user-edit mr-2"></i>Edit User: {{ object.username }}
        </h3>
      </div>
      
      <div class="card-body">
        <form method="POST" id="userForm">
          {% csrf_token %}
          
          <!-- Personal Information -->
          <h5 class="mb-3"><i class="fas fa-id-card mr-2"></i>Personal Information</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.first_name.id_for_label }}">First Name *</label>
              {{ form.first_name }}
              {% if form.first_name.errors %}
                <div class="text-danger">{{ form.first_name.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="{{ form.last_name.id_for_label }}">Last Name *</label>
              {{ form.last_name }}
              {% if form.last_name.errors %}
                <div class="text-danger">{{ form.last_name.errors }}</div>
              {% endif %}
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.email.id_for_label }}">Email *</label>
              {{ form.email }}
              {% if form.email.errors %}
                <div class="text-danger">{{ form.email.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="{{ form.phone.id_for_label }}">Phone</label>
              {{ form.phone }}
              {% if form.phone.errors %}
                <div class="text-danger">{{ form.phone.errors }}</div>
              {% endif %}
            </div>
          </div>

          <hr class="my-4">

          <!-- Account Information -->
          <h5 class="mb-3"><i class="fas fa-user-lock mr-2"></i>Account Information</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.username.id_for_label }}">Username *</label>
              {{ form.username }}
              {% if form.username.errors %}
                <div class="text-danger">{{ form.username.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="{{ form.employee_id.id_for_label }}">Employee ID</label>
              {{ form.employee_id }}
              {% if form.employee_id.errors %}
                <div class="text-danger">{{ form.employee_id.errors }}</div>
              {% endif %}
            </div>
          </div>

          <hr class="my-4">

          <!-- Personal & Employment Details -->
          <h5 class="mb-3"><i class="fas fa-user-circle mr-2"></i>Personal & Employment Details</h5>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="{{ form.date_of_birth.id_for_label }}">Date of Birth</label>
              {{ form.date_of_birth }}
              <small class="form-helper-text">Age will be calculated automatically</small>
              {% if form.date_of_birth.errors %}
                <div class="text-danger">{{ form.date_of_birth.errors }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
              <label for="{{ form.gender.id_for_label }}">Gender</label>
              {{ form.gender }}
              {% if form.gender.errors %}
                <div class="text-danger">{{ form.gender.errors }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
              <label for="id_age_display">Current Age</label>
              <input type="text" id="id_age_display" class="form-control" readonly 
                     value="{% if object.age %}{{ object.age }} years{% else %}N/A{% endif %}">
              <small class="form-helper-text">Calculated from date of birth</small>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="{{ form.employment_type.id_for_label }}">Employment Type *</label>
              {{ form.employment_type }}
              {% if form.employment_type.errors %}
                <div class="text-danger">{{ form.employment_type.errors }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
              <label for="{{ form.job_title.id_for_label }}">Job Title *</label>
              {{ form.job_title }}
              {% if form.job_title.errors %}
                <div class="text-danger">{{ form.job_title.errors }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-4 mb-3">
              <label for="{{ form.date_joined_company.id_for_label }}">Date of Joining *</label>
              {{ form.date_joined_company }}
              <small class="form-helper-text">Employee's joining date</small>
              {% if form.date_joined_company.errors %}
                <div class="text-danger">{{ form.date_joined_company.errors }}</div>
              {% endif %}
            </div>
          </div>

          <div class="row">
            <div class="col-md-12 mb-3">
              <div class="alert alert-info">
                <i class="fas fa-info-circle mr-2"></i>
                <strong>Experience:</strong> 
                {% if object.years_in_current_job %}
                  {{ object.years_in_current_job }} with the company
                {% else %}
                  Not calculated
                {% endif %}
              </div>
            </div>
          </div>

          <hr class="my-4">

          <!-- Organization Information -->
          <h5 class="mb-3"><i class="fas fa-building mr-2"></i>Organization Information</h5>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.role.id_for_label }}">Role *</label>
              {{ form.role }}
              
              <!-- Display help text if it exists (for non-admins) -->
              {% if form.role.help_text %}
                <small class="form-helper-text">{{ form.role.help_text }}</small>
              {% endif %}
              
              {% if form.role.errors %}
                <div class="text-danger">{{ form.role.errors }}</div>
              {% endif %}
            </div>
            <div class="col-md-6 mb-3">
              <label for="{{ form.department.id_for_label }}">Department</label>
              {{ form.department }}

              <!-- Display help text if it exists (for non-admins) -->
              {% if form.department.help_text %}
                <small class="form-helper-text">{{ form.department.help_text }}</small>
              {% endif %}

              {% if form.department.errors %}
                <div class="text-danger">{{ form.department.errors }}</div>
              {% endif %}
            </div>
          </div>

          <hr class="my-4">

          <!-- Location Assignment Section - ALL CHECKBOXES -->
          <h5 class="mb-3"><i class="fas fa-map-marked-alt mr-2"></i>Location Assignment</h5>

          <!-- Check if the logged-in user is a superuser or admin -->
          {% if request.user.is_superuser or request.user.is_admin_user %}
            
            <!-- EDITABLE VIEW FOR ADMINS -->
            <!-- This block contains the interactive checkboxes for location assignment -->

            <!-- Plants (Multiple Checkboxes) - LOADED FROM BACKEND -->
            <div class="mb-4">
              <!-- ... your existing code for Plants checkbox grid ... -->
              <label><strong>Assigned Plants</strong></label>
              <small class="form-helper-text d-block mb-2">Select multiple plants</small>
              <div class="select-all-section">
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllPlants()"><i class="fas fa-check-square mr-1"></i>Select All</button>
                <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="deselectAllPlants()"><i class="fas fa-square mr-1"></i>Deselect All</button>
              </div>
              <div class="checkbox-grid" id="plantsCheckboxGrid">
                {% for plant in all_plants %}
                <div class="checkbox-item">
                    <input type="checkbox" name="assigned_plants" value="{{ plant.id }}" id="plant_{{ plant.id }}" class="plant-checkbox" onchange="loadZonesForSelectedPlants()" {% if plant.id in user_assigned_plants %}checked{% endif %}>
                    <label for="plant_{{ plant.id }}" class="mb-0"><strong>{{ plant.name }}</strong> ({{ plant.code }})</label>
                </div>
                {% empty %}
                <div class="text-muted">No plants available</div>
                {% endfor %}
              </div>
            </div>

          <!-- Zones (Multiple Checkboxes) -->
          <div class="mb-4">
            <label><strong>Assigned Zones</strong></label>
            <small class="form-helper-text d-block mb-2">Select plants first, then select zones</small>
            
            <div class="select-all-section" id="zoneSelectAllSection" style="display: none;">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllZones()">
                <i class="fas fa-check-square mr-1"></i>Select All
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="deselectAllZones()">
                <i class="fas fa-square mr-1"></i>Deselect All
              </button>
            </div>
            
            <div class="checkbox-grid" id="zonesCheckboxGrid">
              <div class="text-muted">Please select plants first</div>
            </div>
          </div>

          <!-- Locations (Multiple Checkboxes) -->
          <div class="mb-4">
            <label><strong>Assigned Locations</strong></label>
            <small class="form-helper-text d-block mb-2">Select zones first, then select locations</small>
            
            <div class="select-all-section" id="locationSelectAllSection" style="display: none;">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllLocations()">
                <i class="fas fa-check-square mr-1"></i>Select All
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="deselectAllLocations()">
                <i class="fas fa-square mr-1"></i>Deselect All
              </button>
            </div>
            
            <div class="checkbox-grid" id="locationsCheckboxGrid">
              <div class="text-muted">Please select zones first</div>
            </div>
          </div>

          <!-- Sub-Locations (Multiple Checkboxes) -->
          <div class="mb-4">
            <label><strong>Assigned Sub-Locations</strong></label>
            <small class="form-helper-text d-block mb-2">Select locations first, then select sub-locations</small>

            <div class="select-all-section" id="sublocationSelectAllSection" style="display: none;">
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllSublocations()">
                <i class="fas fa-check-square mr-1"></i>Select All
              </button>
              <button type="button" class="btn btn-sm btn-outline-secondary ml-2" onclick="deselectAllSublocations()">
                <i class="fas fa-square mr-1"></i>Deselect All
              </button>
            </div>

            <div class="checkbox-grid" id="sublocationsCheckboxGrid">
              <div class="text-muted">Please select locations first</div>
            </div>
          </div>

          {% else %}
            
            <!-- READ-ONLY VIEW FOR OTHER USERS -->
            <!-- This block displays the assigned locations as a simple list -->

            <div class="alert alert-info">
              <i class="fas fa-info-circle mr-2"></i>
              Location assignments can only be changed by an administrator.
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                  <h6><strong>Plants</strong></h6>
                  <ul class="list-group">
                      {% for plant in user_assigned_plants_details %}
                          <li class="list-group-item">{{ plant.name }} ({{ plant.code }})</li>
                      {% empty %}
                          <li class="list-group-item">No plants assigned.</li>
                      {% endfor %}
                  </ul>
              </div>
              <div class="col-md-6 mb-3">
                  <h6><strong>Assigned Zones</strong></h6>
                  <ul class="list-group">
                      {% for zone in user_assigned_zones_details %}
                          <li class="list-group-item">{{ zone.name }} ({{ zone.code }})</li>
                      {% empty %}
                          <li class="list-group-item">No zones assigned.</li>
                      {% endfor %}
                  </ul>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-6 mb-3">
                  <h6><strong>Assigned Locations</strong></h6>
                  <ul class="list-group">
                      {% for location in user_assigned_locations_details %}
                          <li class="list-group-item">{{ location.name }} ({{ location.code }})</li>
                      {% empty %}
                          <li class="list-group-item">No locations assigned.</li>
                      {% endfor %}
                  </ul>
              </div> 
              <div class="col-md-6 mb-3">
                  <h6><strong>Assigned Sub-Locations</strong></h6>
                  <ul class="list-group">
                      {% for sublocation in user_assigned_sublocations_details %}
                          <li class="list-group-item">{{ sublocation.name }}{% if sublocation.code %} ({{ sublocation.code }}){% endif %}</li>
                      {% empty %}
                          <li class="list-group-item">No sub-locations assigned.</li>
                      {% endfor %}
                  </ul>
              </div>
            </div>

          {% endif %}

          <hr class="my-4">

          <!-- Active Status -->
          <div class="row">
            <div class="col-md-12 mb-3">
              
              <!-- Check if the logged-in user is a superuser or admin -->
              {% if request.user.is_superuser or request.user.is_admin_user %}
                
                <!-- EDITABLE VIEW FOR ADMINS -->
                <div class="form-check">
                  {{ form.is_active }}
                  <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                    Active User
                  </label>
                  <small class="form-helper-text d-block">Only administrators can change the active status.</small>
                </div>

              {% else %}

                <!-- READ-ONLY VIEW FOR OTHER USERS -->
                <div>
                  <label>User Status</label>
                  <div class="mt-1">
                    {% if object.is_active %}
                      <span class="badge badge-success" style="font-size: 1rem; padding: 0.5em 0.8em;">
                        <i class="fas fa-check-circle mr-1"></i>Active
                      </span>
                    {% else %}
                      <span class="badge badge-danger" style="font-size: 1rem; padding: 0.5em 0.8em;">
                        <i class="fas fa-times-circle mr-1"></i>Inactive
                      </span>
                    {% endif %}
                  </div>
                </div>

              {% endif %}
              <!-- End of conditional block for Active Status -->

            </div>
          </div>

          <!-- Form Actions -->
          <div class="row mt-4">
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-save mr-1"></i> Update User
              </button>
              <a href="{{ cancel_url }}" class="btn btn-secondary">
                <i class="fas fa-times mr-1"></i> Cancel
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// SIMPLE JAVASCRIPT - ALL CHECKBOXES FOR UPDATE

// Store user's existing assignments (from backend)
var userAssignedZones = {{ user_assigned_zones|safe }};
var userAssignedLocations = {{ user_assigned_locations|safe }};
var userAssignedSublocations = {{ user_assigned_sublocations|safe }};

console.log('User Assigned Zones:', userAssignedZones);
console.log('User Assigned Locations:', userAssignedLocations);
console.log('User Assigned Sublocations:', userAssignedSublocations);

document.addEventListener('DOMContentLoaded', function() {
    // Age Calculation
    var dobInput = document.getElementById('id_date_of_birth');
    var ageDisplay = document.getElementById('id_age_display');

    if (dobInput) {
        dobInput.addEventListener('change', function() {
            var dob = new Date(this.value);
            var today = new Date();
            
            if (dob && dob < today) {
                var age = today.getFullYear() - dob.getFullYear();
                var monthDiff = today.getMonth() - dob.getMonth();
                
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                
                ageDisplay.value = age + ' years';
            } else {
                ageDisplay.value = 'N/A';
            }
        });

        var eighteenYearsAgo = new Date();
        eighteenYearsAgo.setFullYear(eighteenYearsAgo.getFullYear() - 18);
        dobInput.max = eighteenYearsAgo.toISOString().split('T')[0];
    }

    var joiningDateInput = document.getElementById('id_date_joined_company');
    if (joiningDateInput) {
        var today = new Date();
        joiningDateInput.max = today.toISOString().split('T')[0];
    }
    
    // Auto-load zones for pre-selected plants
    setTimeout(function() {
        var checkedPlants = document.querySelectorAll('.plant-checkbox:checked');
        if (checkedPlants.length > 0) {
            console.log('Found checked plants, loading zones...');
            loadZonesForSelectedPlants();
        }
    }, 500);
});

// Load zones when plants are selected
function loadZonesForSelectedPlants() {
    var checkboxes = document.querySelectorAll('.plant-checkbox:checked');
    var selectedPlants = [];
    for (var i = 0; i < checkboxes.length; i++) {
        selectedPlants.push(checkboxes[i].value);
    }
    
    console.log('Selected Plants:', selectedPlants);
    
    var grid = document.getElementById('zonesCheckboxGrid');
    
    if (selectedPlants.length === 0) {
        grid.innerHTML = '<div class="text-muted">Please select plants first</div>';
        document.getElementById('zoneSelectAllSection').style.display = 'none';
        document.getElementById('locationsCheckboxGrid').innerHTML = '<div class="text-muted">Please select zones first</div>';
        document.getElementById('sublocationsCheckboxGrid').innerHTML = '<div class="text-muted">Please select locations first</div>';
        document.getElementById('locationSelectAllSection').style.display = 'none';
        document.getElementById('sublocationSelectAllSection').style.display = 'none';
        return;
    }
    
    grid.innerHTML = '<div class="text-muted">Loading zones...</div>';
    
    var plantIds = selectedPlants.join(',');
    fetch('/organizations/ajax/get-zones-by-plants/?plant_ids=' + plantIds)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            console.log('Zones loaded:', data);
            grid.innerHTML = '';
            
            if (data.length === 0) {
                grid.innerHTML = '<div class="text-muted">No zones available in selected plants</div>';
                document.getElementById('zoneSelectAllSection').style.display = 'none';
                return;
            }
            
            // Group by plant
            var grouped = {};
            for (var i = 0; i < data.length; i++) {
                var plantName = data[i].plant_name;
                if (!grouped[plantName]) {
                    grouped[plantName] = [];
                }
                grouped[plantName].push(data[i]);
            }
            
            // Display grouped
            for (var plantName in grouped) {
                // Plant header
                var header = document.createElement('div');
                header.style.cssText = 'grid-column: 1 / -1; background: #d1ecf1; padding: 8px 12px; font-weight: 600; border-radius: 4px; font-size: 0.9rem; color: #0c5460; border-left: 3px solid #17a2b8;';
                header.innerHTML = '<i class="fas fa-industry mr-2"></i>' + plantName;
                grid.appendChild(header);
                
                // Zones
                for (var j = 0; j < grouped[plantName].length; j++) {
                    var zone = grouped[plantName][j];
                    var div = document.createElement('div');
                    div.className = 'checkbox-item';
                    
                    // Check if this zone is in user's assigned zones
                    var isChecked = userAssignedZones.indexOf(zone.id) !== -1;
                    
                    div.innerHTML = '<input type="checkbox" name="assigned_zones" value="' + zone.id + '" id="zone_' + zone.id + '" class="zone-checkbox" onchange="loadLocationsForSelectedZones()" ' + (isChecked ? 'checked' : '') + '><label for="zone_' + zone.id + '" class="mb-0"><strong>' + zone.name + '</strong> (' + zone.code + ')</label>';
                    grid.appendChild(div);
                }
            }
            
            document.getElementById('zoneSelectAllSection').style.display = 'block';
            
            // Auto-load locations if there are checked zones
            setTimeout(function() {
                var checkedZones = document.querySelectorAll('.zone-checkbox:checked');
                if (checkedZones.length > 0) {
                    console.log('Found checked zones, loading locations...');
                    loadLocationsForSelectedZones();
                }
            }, 300);
        })
        .catch(function(error) {
            console.error('Error loading zones:', error);
            grid.innerHTML = '<div class="text-danger">Error loading zones</div>';
        });
}

// Load locations when zones are selected
function loadLocationsForSelectedZones() {
    var checkboxes = document.querySelectorAll('.zone-checkbox:checked');
    var selectedZones = [];
    for (var i = 0; i < checkboxes.length; i++) {
        selectedZones.push(checkboxes[i].value);
    }
    
    console.log('Selected Zones:', selectedZones);
    
    var grid = document.getElementById('locationsCheckboxGrid');
    
    if (selectedZones.length === 0) {
        grid.innerHTML = '<div class="text-muted">Please select zones first</div>';
        document.getElementById('locationSelectAllSection').style.display = 'none';
        document.getElementById('sublocationsCheckboxGrid').innerHTML = '<div class="text-muted">Please select locations first</div>';
        document.getElementById('sublocationSelectAllSection').style.display = 'none';
        return;
    }
    
    grid.innerHTML = '<div class="text-muted">Loading locations...</div>';
    
    var zoneIds = selectedZones.join(',');
    fetch('/organizations/ajax/get-locations-by-zones/?zone_ids=' + zoneIds)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            console.log('Locations loaded:', data);
            grid.innerHTML = '';
            
            if (data.length === 0) {
                grid.innerHTML = '<div class="text-muted">No locations available in selected zones</div>';
                document.getElementById('locationSelectAllSection').style.display = 'none';
                return;
            }
            
            // Group by zone
            var grouped = {};
            for (var i = 0; i < data.length; i++) {
                var zoneName = data[i].zone_name;
                if (!grouped[zoneName]) {
                    grouped[zoneName] = [];
                }
                grouped[zoneName].push(data[i]);
            }
            
            // Display grouped
            for (var zoneName in grouped) {
                // Zone header
                var header = document.createElement('div');
                header.style.cssText = 'grid-column: 1 / -1; background: #d1ecf1; padding: 8px 12px; font-weight: 600; border-radius: 4px; font-size: 0.9rem; color: #0c5460; border-left: 3px solid #17a2b8;';
                header.innerHTML = '<i class="fas fa-map-pin mr-2"></i>' + zoneName;
                grid.appendChild(header);
                
                // Locations
                for (var j = 0; j < grouped[zoneName].length; j++) {
                    var location = grouped[zoneName][j];
                    var div = document.createElement('div');
                    div.className = 'checkbox-item';
                    
                    // Check if this location is in user's assigned locations
                    var isChecked = userAssignedLocations.indexOf(location.id) !== -1;
                    
                    div.innerHTML = '<input type="checkbox" name="assigned_locations" value="' + location.id + '" id="location_' + location.id + '" class="location-checkbox" onchange="loadSublocationsForSelectedLocations()" ' + (isChecked ? 'checked' : '') + '><label for="location_' + location.id + '" class="mb-0"><strong>' + location.name + '</strong> (' + location.code + ')</label>';
                    grid.appendChild(div);
                }
            }
            
            document.getElementById('locationSelectAllSection').style.display = 'block';
            
            // Auto-load sublocations if there are checked locations
            setTimeout(function() {
                var checkedLocations = document.querySelectorAll('.location-checkbox:checked');
                if (checkedLocations.length > 0) {
                    console.log('Found checked locations, loading sublocations...');
                    loadSublocationsForSelectedLocations();
                }
            }, 300);
        })
        .catch(function(error) {
            console.error('Error loading locations:', error);
            grid.innerHTML = '<div class="text-danger">Error loading locations</div>';
        });
}

// Load sublocations when locations are selected
function loadSublocationsForSelectedLocations() {
    var checkboxes = document.querySelectorAll('.location-checkbox:checked');
    var selectedLocations = [];
    for (var i = 0; i < checkboxes.length; i++) {
        selectedLocations.push(checkboxes[i].value);
    }
    
    console.log('Selected Locations:', selectedLocations);
    
    var grid = document.getElementById('sublocationsCheckboxGrid');
    
    if (selectedLocations.length === 0) {
        grid.innerHTML = '<div class="text-muted">Please select locations first</div>';
        document.getElementById('sublocationSelectAllSection').style.display = 'none';
        return;
    }
    
    grid.innerHTML = '<div class="text-muted">Loading sub-locations...</div>';
    
    var locationIds = selectedLocations.join(',');
    fetch('/organizations/ajax/get-sublocations-by-locations/?location_ids=' + locationIds)
        .then(function(response) { return response.json(); })
        .then(function(data) {
            console.log('Sublocations loaded:', data);
            grid.innerHTML = '';
            
            if (data.length === 0) {
                grid.innerHTML = '<div class="text-muted">No sub-locations available in selected locations</div>';
                document.getElementById('sublocationSelectAllSection').style.display = 'none';
                return;
            }
            
            // Group by location
            var grouped = {};
            for (var i = 0; i < data.length; i++) {
                var locationName = data[i].location_name;
                if (!grouped[locationName]) {
                    grouped[locationName] = [];
                }
                grouped[locationName].push(data[i]);
            }
            
            // Display grouped
            for (var locationName in grouped) {
                // Location header
                var header = document.createElement('div');
                header.style.cssText = 'grid-column: 1 / -1; background: #d1ecf1; padding: 8px 12px; font-weight: 600; border-radius: 4px; font-size: 0.9rem; color: #0c5460; border-left: 3px solid #17a2b8;';
                header.innerHTML = '<i class="fas fa-map-marker-alt mr-2"></i>' + locationName;
                grid.appendChild(header);
                
                // Sublocations
                for (var j = 0; j < grouped[locationName].length; j++) {
                    var sublocation = grouped[locationName][j];
                    var div = document.createElement('div');
                    div.className = 'checkbox-item';
                    var codeText = sublocation.code ? ' (' + sublocation.code + ')' : '';
                    
                    // Check if this sublocation is in user's assigned sublocations
                    var isChecked = userAssignedSublocations.indexOf(sublocation.id) !== -1;
                    
                    div.innerHTML = '<input type="checkbox" name="assigned_sublocations" value="' + sublocation.id + '" id="sublocation_' + sublocation.id + '" class="sublocation-checkbox" ' + (isChecked ? 'checked' : '') + '><label for="sublocation_' + sublocation.id + '" class="mb-0">' + sublocation.name + codeText + '</label>';
                    grid.appendChild(div);
                }
            }
            
            document.getElementById('sublocationSelectAllSection').style.display = 'block';
        })
        .catch(function(error) {
            console.error('Error loading sublocations:', error);
            grid.innerHTML = '<div class="text-danger">Error loading sublocations</div>';
        });
}

// Select/Deselect All Functions
function selectAllPlants() {
    var checkboxes = document.querySelectorAll('.plant-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = true;
    }
    loadZonesForSelectedPlants();
}

function deselectAllPlants() {
    var checkboxes = document.querySelectorAll('.plant-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
    }
    loadZonesForSelectedPlants();
}

function selectAllZones() {
    var checkboxes = document.querySelectorAll('.zone-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = true;
    }
    loadLocationsForSelectedZones();
}

function deselectAllZones() {
    var checkboxes = document.querySelectorAll('.zone-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
    }
    loadLocationsForSelectedZones();
}

function selectAllLocations() {
    var checkboxes = document.querySelectorAll('.location-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = true;
    }
    loadSublocationsForSelectedLocations();
}

function deselectAllLocations() {
    var checkboxes = document.querySelectorAll('.location-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
    }
    loadSublocationsForSelectedLocations();
}

function selectAllSublocations() {
    var checkboxes = document.querySelectorAll('.sublocation-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = true;
    }
}

function deselectAllSublocations() {
    var checkboxes = document.querySelectorAll('.sublocation-checkbox');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
    }
}
</script>
{% endblock %}