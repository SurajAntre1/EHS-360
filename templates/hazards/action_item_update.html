{% extends 'base/base.html' %}
{% load static %}

{% block title %}Update Action Item{% endblock %}

{% block extra_css %}
<style>
    .email-tags-input {
        min-height: 60px;
        padding: 8px;
        border: 2px solid #ced4da;
        border-radius: 0.25rem;
        cursor: text;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        align-items: center;
    }
    
    .email-tag {
        background-color: #007bff;
        color: white;
        padding: 5px 10px;
        border-radius: 20px;
        display: inline-flex;
        align-items: center;
        font-size: 14px;
    }
    
    .email-tag .remove-tag {
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .email-input-field {
        border: none;
        outline: none;
        flex: 1;
        min-width: 200px;
        padding: 5px;
    }
    
    .self-assigned-badge {
        background-color: #28a745;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        display: inline-block;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block content %}
<section class="content-header">
    <div class="container-fluid">
        <h1><i class="fas fa-edit"></i> Update Action Item</h1>
    </div>
</section>

<section class="content">
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible fade show">
                {{ message|safe }}
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-warning">
                    <h3 class="card-title text-white">Edit Action Item</h3>
                </div>
                <div class="card-body">
                    <form method="POST" id="actionItemForm">
                        {% csrf_token %}

                        <!-- Action Description -->
                        <div class="form-group">
                            <label>Action Description *</label>
                            <textarea name="action_description" class="form-control" rows="4" required>{{ object.action_description }}</textarea>
                        </div>

                        <!-- Check if self-assigned (only 1 email and it's current user) -->
                        {% if object.get_emails_count == 1 and user.email in object.responsible_emails %}
                        <div class="self-assigned-badge">
                            <i class="fas fa-user-check"></i> <strong>Self-Assigned Action</strong>
                            <br>
                            <small>Assigned to: {{ user.email }}</small>
                        </div>
                        <input type="hidden" name="responsible_emails" value="{{ object.responsible_emails }}">
                        <input type="hidden" name="is_self_assigned" value="true">
                        {% else %}
                        <!-- Responsible Emails (Editable) -->
                        <div class="form-group">
                            <label><i class="fas fa-envelope"></i> Assigned To (Emails) *</label>
                            <div class="email-tags-input" id="emailTagsContainer">
                                <input type="text" class="email-input-field" id="emailInput" placeholder="Type email and press Enter...">
                            </div>
                            <div class="email-count" id="emailCount"></div>
                            <input type="hidden" name="responsible_emails" id="responsibleEmails">
                            <input type="hidden" name="is_self_assigned" value="false">
                        </div>
                        {% endif %}

                        <!-- Target Date -->
                        <div class="form-group">
                            <label>Target Date *</label>
                            <input type="date" name="target_date" class="form-control" value="{{ object.target_date|date:'Y-m-d' }}" required>
                        </div>

                        <!-- Status -->
                        <div class="form-group">
                            <label>Status *</label>
                            <select name="status" id="statusSelect" class="form-control">
                                {% for value, label in object.STATUS_CHOICES %}
                                <option value="{{ value }}" {% if object.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            {% if object.get_emails_count == 1 and user.email in object.responsible_emails %}
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle"></i> When you change status to <strong>Completed</strong>, the action will automatically close!
                            </small>
                            {% endif %}
                        </div>

                        <!-- Completion Date (if status is COMPLETED) -->
                        <div class="form-group" id="completionDateGroup" style="display: none;">
                            <label>Completion Date</label>
                            <input type="date" name="completion_date" class="form-control" value="{{ object.completion_date|date:'Y-m-d' }}">
                        </div>

                        <!-- Completion Remarks -->
                        <div class="form-group" id="completionRemarksGroup" style="display: none;">
                            <label>Completion Remarks</label>
                            <textarea name="completion_remarks" class="form-control" rows="3">{{ object.completion_remarks }}</textarea>
                        </div>

                        <hr>
                        <button type="submit" class="btn btn-warning btn-lg">
                            <i class="fas fa-save"></i> Update
                        </button>
                        <a href="{% url 'hazards:hazard_detail' object.hazard.pk %}" class="btn btn-secondary btn-lg">Cancel</a>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const isSelfAssigned = document.querySelector('input[name="is_self_assigned"]').value === 'true';
    
    // Only initialize email editor if not self-assigned
    if (!isSelfAssigned) {
        const emailInput = document.getElementById('emailInput');
        const emailTagsContainer = document.getElementById('emailTagsContainer');
        const responsibleEmails = document.getElementById('responsibleEmails');
        const emailCount = document.getElementById('emailCount');
        
        let emails = [];
        
        // Load existing emails
        const existingEmails = '{{ object.responsible_emails|escapejs }}';
        if (existingEmails) {
            emails = existingEmails.split(',').map(e => e.trim()).filter(e => e);
            updateUI();
        }
        
        function isValidEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }
        
        function addEmail(email) {
            email = email.trim().toLowerCase();
            if (!email) return;
            if (!isValidEmail(email)) {
                alert('⚠️ Invalid email: ' + email);
                return;
            }
            if (emails.includes(email)) {
                alert('ℹ️ Already added: ' + email);
                return;
            }
            emails.push(email);
            updateUI();
        }
        
        function removeEmail(email) {
            emails = emails.filter(e => e !== email);
            updateUI();
        }
        
        function updateUI() {
            const existingTags = emailTagsContainer.querySelectorAll('.email-tag');
            existingTags.forEach(tag => tag.remove());
            
            emails.forEach(email => {
                const tag = document.createElement('span');
                tag.className = 'email-tag';
                tag.innerHTML = `${email} <span class="remove-tag" data-email="${email}">×</span>`;
                emailTagsContainer.insertBefore(tag, emailInput);
            });
            
            responsibleEmails.value = emails.join(', ');
            emailCount.textContent = `${emails.length} email(s) added`;
            emailInput.value = '';
        }
        
        emailInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                addEmail(emailInput.value);
            }
        });
        
        emailTagsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-tag')) {
                removeEmail(e.target.getAttribute('data-email'));
            }
        });
    }
    
    // Show/hide completion fields based on status
    const statusSelect = document.getElementById('statusSelect');
    const completionDateGroup = document.getElementById('completionDateGroup');
    const completionRemarksGroup = document.getElementById('completionRemarksGroup');
    
    function toggleCompletionFields() {
        if (statusSelect.value === 'COMPLETED') {
            completionDateGroup.style.display = 'block';
            completionRemarksGroup.style.display = 'block';
        } else {
            completionDateGroup.style.display = 'none';
            completionRemarksGroup.style.display = 'none';
        }
    }
    
    statusSelect.addEventListener('change', toggleCompletionFields);
    toggleCompletionFields();
});
</script>
{% endblock %}