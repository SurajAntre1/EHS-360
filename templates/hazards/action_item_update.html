<!-- templates/hazards/action_item_update.html -->
{% extends 'base/base.html' %}
{% load static %}

{% block title %}Update Action Item{% endblock %}
{% block page_title %}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'hazards:dashboard' %}">Hazard Management</a></li>
<li class="breadcrumb-item"><a href="{% url 'hazards:hazard_list' %}">All Hazards</a></li>
<li class="breadcrumb-item">Update Action Item</li>
{% endblock %}

{% block extra_css %}
<style>
    .assignment-option {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: 0.3s;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }
    .assignment-option:hover {
        border-color: #007bff;
        background-color: #f8f9fa;
    }
    .assignment-option.active {
        border-color: #007bff;
        background-color: #e7f3ff;
    }
    .option-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
    }
    .self-icon { background:#d4edda; color:#28a745; }
    .forward-icon { background:#d1ecf1; color:#17a2b8; }

    .user-card {
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: 0.3s;
    }
    .user-card.selected {
        border-color:#28a745;
        background:#d4edda;
    }
    .user-avatar {
        width:50px;
        height:50px;
        border-radius:50%;
        background:linear-gradient(135deg,#667eea,#764ba2);
        color:white;
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight:bold;
    }
    .user-card {
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .user-card:hover {
        transform: translateY(-2px);
    }

    .user-card.selected {
        border-color: #28a745;
        background: #d4edda;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">

            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="mb-1">
                        <i class="fas fa-edit text-warning"></i> 
                            Update Action Item
                    </h3>
                    <p class="text-muted mb-0">
                        For Hazard {{ object.hazard.report_number }}
                    </p>
                </div>
            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check"></i> Action Item Details
                    </h5>
                </div>

                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="actionItemForm">
                    {% csrf_token %}

                    <!-- Description -->
                    <div class="form-group">
                        <label class="font-weight-bold">
                            <i class="fas fa-align-left"></i> Action Taken
                            <!-- Add ID to the asterisk -->
                            <span class="text-danger" id="action-desc-star">*</span>
                        </label>
                        <!-- Add ID and remove hardcoded 'required' -->
                        <textarea name="action_description" id="action-description-textarea" class="form-control" rows="4">{{ object.action_description }}</textarea>
                    </div>

                    <!-- Assignment Type -->
                    <div class="form-group">
                        <label class="font-weight-bold">
                            <i class="fas fa-user-check"></i> Assignment Type *
                        </label>

                        <!-- Self -->
                        <div class="assignment-option {% if is_self_assignment %}active{% endif %}">
                            <input type="radio" name="assignment_type" value="self" hidden
                            {% if is_self_assignment %}checked{% endif %}>
                            <div class="option-icon self-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                        <div>
                        <strong>Assign to Self & Close</strong>
                        <p class="text-muted small mb-0">
                        Hazard will be marked <strong class="text-success">COMPLETED</strong>
                        </p>
                    </div>
                </div>

                <!-- Forward -->
                <div class="assignment-option {% if not is_self_assignment %}active{% endif %}">
                    <input type="radio" name="assignment_type" value="forward" hidden
                        {% if not is_self_assignment %}checked{% endif %}>
                    <div class="option-icon forward-icon">
                        <i class="fas fa-share-square"></i>
                    </div>
                <div>
                <strong>Forward to Others</strong>
                <p class="text-muted small mb-0">
                Status will remain <strong class="text-primary">PENDING</strong>
                </p>
            </div>
        </div>
    </div>

    <!-- User Selection -->
    <div id="user-selection-section" 
    {% if is_self_assignment %}style="display:none"{% endif %}>

        <label class="font-weight-bold">
        <i class="fas fa-users"></i> Select Users *
        </label>

        <div class="row">
        {% for user in plant_users %}
            <div class="col-md-6 mb-3">
                <div class="card user-card h-100 
                {% if user.email in selected_emails %}selected{% endif %}">

                    <div class="card-body p-3">

                        <input type="checkbox"
                            class="user-checkbox"
                            name="responsible_emails"
                            value="{{ user.email }}"
                            {% if user.email in selected_emails %}checked{% endif %}>

                        <div class="d-flex align-items-center mt-2">
                            <div class="user-avatar mr-3">
                                {{ user.first_name|first }}{{ user.last_name|first }}
                            </div>
                            <div>
                                <strong>{{ user.get_full_name|default:user.username }}</strong><br>
                                <small class="text-muted">{{ user.email }}</small>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Target Date -->
    <div class="form-group mt-3">
        <label class="font-weight-bold">
        <i class="fas fa-calendar-alt"></i> Target Date *
        </label>
        <input type="date"
            name="target_date"
            class="form-control"
            value="{{ object.target_date|date:'Y-m-d' }}"
            readonly>
    </div>


    <!-- Completion Date -->
    <div class="form-group" id="completionDateGroup" style="display:none;">
        <label>Completion Date</label>
        <input type="date"
            name="completion_date"
            class="form-control"
            value="{{ object.completion_date|date:'Y-m-d' }}">
    </div>

    <!-- Attachment -->
    <div class="form-group">
        <label class="font-weight-bold">
        <i class="fas fa-paperclip"></i> Attachment
        <span id="attachment-star">*</span>
        </label>

        {% if object.attachment %}
        <div class="mb-2">
            <strong>Current:</strong>
            <a href="{{ object.attachment.url }}" target="_blank">
            {{ object.get_attachment_name }}
            </a>
        </div>
        {% endif %}

        <input type="file"
            name="attachment"
            id="attachment-input"
            class="form-control-file">

        <div id="attachment-help"></div>
        </div>

        <hr>
        <button type="submit" class="btn btn-warning btn-lg px-5">
            <i class="fas fa-save"></i> Update Action Item
        </button>

        <a href="{{ request.META.HTTP_REFERER|default:'/' }}"
            class="btn btn-secondary btn-lg ml-2">
            Cancel
        </a>

    </form>
    </div>
    </div>
</div>
</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(function(){
    function toggleAssignmentUI() {
        const type = $('input[name="assignment_type"]:checked').val();
        
        // Target UI elements
        const actionTextarea = $('#action-description-textarea');
        const actionStar = $('#action-desc-star');

        $('.assignment-option').removeClass('active');
        $('input[name="assignment_type"]:checked')
            .closest('.assignment-option')
            .addClass('active');

        if (type === 'forward') {
            $('#user-selection-section').slideDown();
            $('#attachment-input').removeAttr('required');
            $('#attachment-star').hide();
            $('#attachment-help').html('<div class="text-muted small">Attachment optional when forwarding.</div>');
            
            // Make Action Taken optional
            actionTextarea.prop('required', false);
            actionStar.hide();

        } else { // 'self'
            $('#user-selection-section').slideUp();
            $('#attachment-input').attr('required', true);
            $('#attachment-star').show();
            $('#attachment-help').html('<div class="text-warning small">Attachment required when self-closing.</div>');

            // Make Action Taken required
            actionTextarea.prop('required', true);
            actionStar.show();
        }
    }

    // Event handlers
    $('.assignment-option').click(function(){
        $(this).find('input[type="radio"]').prop('checked', true).trigger('change');
    });

    $('input[name="assignment_type"]').change(toggleAssignmentUI);

    // Initial call on page load
    toggleAssignmentUI();

    // --- rest of your existing script for user cards ---
    $('.user-card').click(function(e){
        if($(e.target).is('input')) return;
        const checkbox = $(this).find('.user-checkbox');
        checkbox.prop('checked', !checkbox.prop('checked')).trigger('change');
    });

    $('.user-checkbox').change(function(){
        const card = $(this).closest('.user-card');
        if($(this).is(':checked')){
            card.addClass('selected');
        }else{
            card.removeClass('selected');
        }
    });
});
</script>
{% endblock %}