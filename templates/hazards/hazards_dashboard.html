<!-- hazards/hazards_dashboard.html -->

{% extends 'base/base.html' %}
{% load static %}

{% block title %}Hazard Management Dashboard{% endblock %}
{% block page_title %}Hazard Management Dashboard{% endblock %}

{% block extra_css %}
<style>
/* ... (Aapki CSS styles waise hi rahengi) ... */
.dashboard-card{border:none;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1);transition:transform .3s ease,box-shadow .3s ease;margin-bottom:20px}.dashboard-card:hover{transform:translateY(-5px);box-shadow:0 5px 20px rgba(0,0,0,0.15)}.stat-card{padding:20px;border-left:4px solid}.stat-card.danger{border-left-color:#dc3545;background:linear-gradient(135deg,#fff 0%,#ffebee 100%)}.stat-card.warning{border-left-color:#ffc107;background:linear-gradient(135deg,#fff 0%,#fff9e6 100%)}.stat-card.info{border-left-color:#17a2b8;background:linear-gradient(135deg,#fff 0%,#e6f7ff 100%)}.stat-card.success{border-left-color:#28a745;background:linear-gradient(135deg,#fff 0%,#e8f5e9 100%)}.stat-card.primary{border-left-color:#007bff;background:linear-gradient(135deg,#fff 0%,#e3f2fd 100%)}.stat-card .stat-icon{font-size:3rem;opacity:.3;position:absolute;right:20px;top:50%;transform:translateY(-50%)}.stat-card .stat-number{font-size:2.5rem;font-weight:700;margin:0;line-height:1}.stat-card .stat-label{font-size:.9rem;color:#6c757d;margin-top:5px;text-transform:uppercase;letter-spacing:.5px}.filter-section{background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,0.1);margin-bottom:20px}.filter-section .form-label{font-weight:600;color:#495057;margin-bottom:5px;font-size:.9rem}.filter-section .form-control,.filter-section .form-select{border-radius:6px;border:1px solid #ced4da;padding:8px 12px;font-size:.9rem}.filter-section .btn{padding:8px 20px;font-size:.9rem;border-radius:6px}.chart-container{position:relative;height:300px;padding:20px}.hazard-table th{background-color:#f8f9fa;font-weight:600;text-transform:uppercase;font-size:.75rem}.section-header{border-bottom:3px solid #007bff;padding-bottom:10px;margin-bottom:20px}h5{margin:0;font-weight:700}.severity-indicator{display:inline-block;width:12px;height:12px;border-radius:50%;margin-right:5px}.severity-critical{background-color:#dc3545}.severity-high{background-color:#ffc107}.severity-medium{background-color:#17a2b8}.severity-low{background-color:#28a745}.active-filter-badge{display:inline-block;background:#007bff;color:#fff;padding:5px 12px;border-radius:15px;font-size:.85rem;margin:5px}.active-filter-badge i{margin-left:5px;cursor:pointer}.clickable-card{cursor:pointer}

    .quick-actions-container {
        display: flex;
        flex-direction: column; /* Stack items vertically */
        gap: 10px; /* Space between buttons */
    }
    .quick-action-btn {
        display: flex; /* Use flex for internal alignment */
        align-items: center; /* Center icon and text vertically */
        justify-content: center; /* Center content horizontally */
        padding: 12px;
        border-radius: 8px;
        color: white;
        text-decoration: none;
        transition: all 0.3s ease;
        text-align: center;
    }
    .quick-action-btn:hover {
        color: white;
        transform: translateX(5px);
    }
    .quick-action-btn i {
        font-size: 1.2rem;
        margin-right: 10px; /* Space between icon and text */
    }
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'dashboards:home' %}">Home</a></li>
<li class="breadcrumb-item active">Hazard Management</li>
{% endblock %}

{% block content %}




<!-- Filter Section -->
<div class="filter-section">
    <form method="GET" action="{% url 'hazards:hazard_dashboard' %}" id="filterForm">
        <div class="row align-items-end">
            <!-- Row 1 -->
            <div class="col-md-3 mb-3">
                <label for="plant_filter" class="form-label small font-weight-bold"><i class="fas fa-industry mr-1"></i> Plant</label>
                <select name="plant" id="plant_filter" class="form-control">
                    <option value="">All Plants</option>
                    {% for plant in plants %}
                    <option value="{{ plant.id }}" {% if selected_plant == plant.id|stringformat:"s" %}selected{% endif %}>{{ plant.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="zone_filter" class="form-label small font-weight-bold"><i class="fas fa-map-marker-alt mr-1"></i> Zone</label>
                <select name="zone" id="zone_filter" class="form-control">
                    <option value="">All Zones</option>
                    {% for zone in zones %}
                    <option value="{{ zone.id }}" {% if selected_zone == zone.id|stringformat:"s" %}selected{% endif %}>{{ zone.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="location_filter" class="form-label small font-weight-bold"><i class="fas fa-location-arrow mr-1"></i> Location</label>
                <select name="location" id="location_filter" class="form-control">
                    <option value="">All Locations</option>
                    {% for location in locations %}
                    <option value="{{ location.id }}" {% if selected_location == location.id|stringformat:"s" %}selected{% endif %}>{{ location.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="sublocation_filter" class="form-label small font-weight-bold"><i class="fas fa-map-pin mr-1"></i> Sub-Location</label>
                <select name="sublocation" id="sublocation_filter" class="form-control">
                    <option value="">All Sub-Locations</option>
                    {% for sublocation in sublocations %}
                    <option value="{{ sublocation.id }}" {% if selected_sublocation == sublocation.id|stringformat:"s" %}selected{% endif %}>{{ sublocation.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Row 2 -->
            <!-- <div class="col-md-3 mb-3">
                <label for="department_filter" class="form-label small font-weight-bold"><i class="fas fa-building mr-1"></i> Department</label>
                <select name="department" id="department_filter" class="form-control">
                    <option value="">All Departments</option>
                    {% for dept in all_departments %}
                    <option value="{{ dept.id }}" {% if selected_department == dept.id|stringformat:"s" %}selected{% endif %}>{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div> -->
            <div class="col-md-3 mb-3">
                <label for="category_filter" class="form-label small font-weight-bold"><i class="fas fa-tags mr-1"></i> Category</label>
                <select name="category" id="category_filter" class="form-control">
                    <option value="">All Categories</option>
                    {% for cat_val, cat_name in all_categories %}
                    <option value="{{ cat_val }}" {% if selected_category == cat_val %}selected{% endif %}>{{ cat_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <label for="month_filter" class="form-label small font-weight-bold"><i class="fas fa-calendar mr-1"></i> Month</label>
                <select name="month" id="month_filter" class="form-control">
                    <option value="">All Time</option>
                    {% for month in month_options %}
                    <option value="{{ month.value }}" {% if selected_month == month.value %}selected{% endif %}>{{ month.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 mb-3">
                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-filter mr-1"></i> Apply Filters</button>
            </div>
        </div>

        {% if has_active_filters %}
        <div class="row mt-2">
            <div class="col-md-12">
                <strong>Active Filters:</strong>
                {% if selected_plant_name %}<span class="active-filter-badge">Plant: {{ selected_plant_name }}<i class="fas fa-times" onclick="removeFilter('plant')"></i></span>{% endif %}
                {% if selected_zone_name %}<span class="active-filter-badge">Zone: {{ selected_zone_name }}<i class="fas fa-times" onclick="removeFilter('zone')"></i></span>{% endif %}
                {% if selected_location_name %}<span class="active-filter-badge">Location: {{ selected_location_name }}<i class="fas fa-times" onclick="removeFilter('location')"></i></span>{% endif %}
                {% if selected_sublocation_name %}<span class="active-filter-badge">Sub-Location: {{ selected_sublocation_name }}<i class="fas fa-times" onclick="removeFilter('sublocation')"></i></span>{% endif %}
                {% if selected_department_name %}<span class="active-filter-badge">Dept: {{ selected_department_name }}<i class="fas fa-times" onclick="removeFilter('department')"></i></span>{% endif %}
                {% if selected_category_name %}<span class="active-filter-badge">Category: {{ selected_category_name }}<i class="fas fa-times" onclick="removeFilter('category')"></i></span>{% endif %}
                {% if selected_month_label %}<span class="active-filter-badge">Month: {{ selected_month_label }}<i class="fas fa-times" onclick="removeFilter('month')"></i></span>{% endif %}
                {% if selected_severity %}<span class="active-filter-badge">Risk: {{ selected_severity|capfirst }}<i class="fas fa-times" onclick="removeFilter('severity')"></i></span>{% endif %}
                {% if selected_status %}<span class="active-filter-badge">Status: {{ selected_status|capfirst }}<i class="fas fa-times" onclick="removeFilter('status')"></i></span>{% endif %}
                <a href="{% url 'hazards:hazard_dashboard' %}" class="btn btn-sm btn-outline-danger ml-2"><i class="fas fa-times-circle"></i> Clear All</a>
            </div>
        </div>
        {% endif %}
    </form>
</div>

<!-- Clickable Summary Statistics -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6"><a href="{% url 'hazards:dashboard' %}" class="text-decoration-none"><div class="dashboard-card clickable-card"><div class="stat-card primary"><i class="fas fa-shield-alt stat-icon"></i><p class="stat-number">{{ total_hazards }}</p><p class="stat-label">Total Hazards</p></div></div></a></div>
    <div class="col-xl-3 col-md-6"><a href="{% url 'hazards:dashboard' %}?status=open" class="text-decoration-none"><div class="dashboard-card clickable-card"><div class="stat-card danger"><i class="fas fa-folder-open stat-icon"></i><p class="stat-number">{{ open_hazards }}</p><p class="stat-label">Open Hazards</p></div></div></a></div>
    <div class="col-xl-3 col-md-6"><div class="dashboard-card"><div class="stat-card warning"><i class="fas fa-calendar-alt stat-icon"></i><p class="stat-number">{{ this_month_hazards }}</p><p class="stat-label">{% if selected_month_label %}{{ selected_month_label }}{% else %}This Month{% endif %}</p></div></div></div>
    <div class="col-xl-3 col-md-6"><div class="dashboard-card"><div class="stat-card info"><i class="fas fa-clock stat-icon"></i><p class="stat-number">{{ overdue_hazards_count }}</p><p class="stat-label">Overdue Hazards</p></div></div></div>
</div>


<!-- The rest of the page remains the same: Charts, Quick Actions, Recent Hazards -->
<div class="row mb-4">
    <!-- Hazards by Risk Level Chart -->
    <div class="col-lg-6 mb-4">
        <div class="dashboard-card">
            <div class="card-body">
                <div class="section-header">
                    <h5><i class="fas fa-chart-pie mr-2"></i>Hazards by Risk Level</h5>
                </div>
                <div class="chart-container"><canvas id="severityChart"></canvas></div>
            </div>
        </div>
    </div>
 <!-- Status Distribution Chart (Previously Monthly Trend) -->
    <div class="col-lg-6 mb-4">
        <div class="dashboard-card">
            <div class="card-body">
                <div class="section-header"> 
                    <h5><i class="fas fa-tasks mr-2"></i>Status Distribution</h5>
                </div>
                <div class="chart-container"><canvas id="statusChart"></canvas></div>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <!-- Monthly Trend Chart (Previously Status Distribution) -->
    <div class="col-lg-8 mb-4">
        <div class="dashboard-card">
            <div class="card-body">
                <div class="section-header">
                    <h5><i class="fas fa-chart-line mr-2"></i>Monthly Trend</h5>
                </div>
                <div class="chart-container"><canvas id="monthlyTrendChart"></canvas></div>
            </div>
        </div>
    </div>
    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="dashboard-card">
            <div class="card-body">
                <div class="section-header">
                    <h5><i class="fas fa-bolt mr-2"></i>Quick Actions</h5>
                </div>
                <div class="quick-actions-container">
                    <a href="{% url 'hazards:hazard_create' %}" class="quick-action-btn bg-danger">
                        <i class="fas fa-plus-circle"></i>
                        <span>Report New Hazard</span>
                    </a>
                    <a href="{% url 'hazards:hazard_list' %}" class="quick-action-btn bg-primary">
                        <i class="fas fa-list"></i>
                        <span>View All Hazards</span>
                    </a>
                    <a href="#" id="exportReportBtn" class="quick-action-btn bg-success"><i class="fas fa-file-excel"></i><span>Export Report</span></a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- NEW: Top 3 Hazard Categories -->
<!-- <div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-body">
                <div class="section-header"><h5><i class="fas fa-star mr-2"></i>Top 3 Hazard Categories</h5></div>
                <div class="row">
                    {% for category in top_hazard_categories %}
                    <div class="col-md-4">
                        <a href="{% url 'hazards:hazard_list' %}?category={{ category.value }}" class="text-decoration-none">
                            <div class="stat-card info clickable-card">
                                <i class="fas fa-exclamation-triangle stat-icon"></i>
                                <p class="stat-number">{{ category.count }}</p>
                                <p class="stat-label">{{ category.display_name }}</p>
                            </div>
                        </a>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center text-muted py-3">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No hazard data available to determine top categories.
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div> -->


<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-body">
                <div class="section-header"><h5><i class="fas fa-star mr-2"></i>Top 3 Hazard Categories</h5></div>
                
                {# The 'if' condition now correctly checks if the top_hazard_categories queryset has any data #}
                {% if top_hazard_categories %}
                    <div class="chart-container" style="height: 320px;">
                        <canvas id="topCategoriesChart"></canvas>
                    </div>
                {% else %}
                    <div class="col-12 text-center text-muted py-5">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No hazard data available to determine top categories.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <div class="card-body">
                <div class="section-header">
                    <h5><i class="fas fa-building mr-2"></i>Hazards by Department</h5>
                </div>
                {% if department_chart_data %}
                    <div class="chart-container">
                        <canvas id="departmentChart"></canvas>
                    </div>
                {% else %}
                    <div class="col-12 text-center text-muted py-5">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No department-specific hazard data is available for the selected filters.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>


<!-- Recent Hazards Table -->
<div class="row">
    <div class="col-lg-12 mb-4">
        <div class="dashboard-card">
            <div class="card-body">
                <div class="section-header"><h5><i class="fas fa-clock mr-2"></i>Recent Hazards</h5></div>
                <div class="table-responsive">
                    <table class="table table-hover hazard-table">
                        <thead>
                            <tr>
                                <th>Report</th>
                                <th>Title</th>
                                <th>Type</th>
                                <th>Risk Level</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for hazard in recent_hazards %}
                            <tr>
                                <td><strong>{{ hazard.report_number }}</strong></td>
                                <td>{{ hazard.hazard_title|truncatewords:5 }}</td>
                                <td>{{ hazard.get_hazard_type_display }}</td>
                                <td>
                                    <span class="severity-indicator severity-{{ hazard.severity|lower }}"></span>
                                    {{ hazard.get_severity_display }}
                                </td>
                                <td>{{ hazard.incident_datetime|date:"d/m/Y" }}</td>
                                <td>
                                    <span class="badge badge-custom 
                                        {% if hazard.status == 'CLOSED' or hazard.status == 'RESOLVED' %}badge-success
                                        {% elif hazard.status == 'REPORTED' %}badge-secondary
                                        {% else %}badge-primary{% endif %}">
                                        {{ hazard.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'hazards:hazard_detail' hazard.pk %}" class="btn btn-sm btn-outline-primary" title="View Details"><i class="fas fa-eye"></i></a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="7" class="text-center text-muted py-4"><i class="fas fa-inbox fa-3x mb-3 d-block"></i>No recent hazards found</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if recent_hazards %}<div class="text-center mt-3"><a href="{% url 'hazards:hazard_list' %}" class="btn btn-outline-primary"><i class="fas fa-arrow-right mr-2"></i>View All Hazards</a></div>{% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>


<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- CASCADING DROPDOWNS LOGIC ---
    // ... (This section remains unchanged) ...
    const plantSelect = document.getElementById('plant_filter');
    const zoneSelect = document.getElementById('zone_filter');
    const locationSelect = document.getElementById('location_filter');
    const sublocationSelect = document.getElementById('sublocation_filter');

    plantSelect.addEventListener('change', function() {
        const plantId = this.value;
        zoneSelect.innerHTML = '<option value="">All Zones</option>';
        locationSelect.innerHTML = '<option value="">All Locations</option>';
        sublocationSelect.innerHTML = '<option value="">All Sub-Locations</option>';
        if (plantId) {
            fetch(`{% url 'hazards:ajax_get_zones' %}?plant_id=${plantId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(zone => {
                        zoneSelect.add(new Option(zone.name, zone.id));
                    });
                });
        }
    });

    document.getElementById('zone_filter').addEventListener('change', function() {
        const zoneId = this.value;
        locationSelect.innerHTML = '<option value="">All Locations</option>';
        sublocationSelect.innerHTML = '<option value="">All Sub-Locations</option>';
        if (zoneId) {
            fetch(`{% url 'hazards:ajax_get_locations' %}?zone_id=${zoneId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(location => {
                        locationSelect.add(new Option(location.name, location.id));
                    });
                });
        }
    });

    locationSelect.addEventListener('change', function() {
        const locationId = this.value;
        const sublocationSelect = document.getElementById('sublocation_filter');
        sublocationSelect.innerHTML = '<option value="">All Sub-Locations</option>';
        if (locationId) {
            fetch(`{% url 'hazards:ajax_get_sublocations' %}?location_id=${locationId}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(sublocation => {
                        sublocationSelect.add(new Option(sublocation.name, sublocation.id));
                    });
                });
        }
    });

    // --- EXPORT BUTTON LOGIC ---
    document.getElementById('exportReportBtn').addEventListener('click', function(e) {
        e.preventDefault();
        const currentParams = window.location.search;
        const exportUrl = "{% url 'hazards:export_hazards' %}" + currentParams;
        window.location.href = exportUrl;
    });

    // --- CHART INITIALIZATION ---
    const colors = {danger: '#dc3545', warning: '#ffc107', info: '#17a2b8', success: '#28a745', primary: '#007bff'};
    
    // Severity Chart (Hazards by Risk Level)
    const severityCtx = document.getElementById('severityChart').getContext('2d');
    const severityChart = new Chart(severityCtx, {
        type: 'doughnut',
        data: { labels: {{ severity_labels|safe }}, datasets: [{ data: {{ severity_data|safe }}, backgroundColor: [colors.danger, colors.warning, colors.info, colors.success] }] },
        options: {
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { position: 'bottom' },
                datalabels: {
                    color: '#fff',
                    font: { weight: 'bold', size: 16 },
                    formatter: (value) => value > 0 ? value : ''
                }
            },
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const label = severityChart.data.labels[elements[0].index].toLowerCase();
                    const currentParams = new URLSearchParams(window.location.search);
                    currentParams.set('severity', label);
                    window.location.href = window.location.pathname + '?' + currentParams.toString();
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Monthly Trend Chart
    new Chart(document.getElementById('monthlyTrendChart').getContext('2d'), { type: 'line', data: { labels: {{ monthly_labels|safe }}, datasets: [{ label: 'Hazards', data: {{ monthly_data|safe }}, borderColor: colors.primary, backgroundColor: 'rgba(0,123,255,0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
    
    // Status Chart (Status Distribution) - UPDATED
    const statusChartCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusChartCtx, { 
        type: 'bar', 
        data: { 
            labels: {{ status_labels|safe }}, 
            datasets: [{ 
                label: 'Hazards', 
                data: {{ status_data|safe }}, 
                backgroundColor: '#563d7c',
                barPercentage: 0.4
            }] 
        }, 
        options: { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { 
                legend: { display: false },
                // ✅ CHANGED: Data labels configuration for Status chart
                datalabels: {
                    anchor: 'end',
                    align: 'bottom',  // <-- CHANGE: Aligns label inside the bar from the top
                    color: '#fff',      // <-- CHANGE: White color for contrast
                    offset: 4,          // Optional: Adds a little padding from the top edge
                    font: {
                        weight: 'bold'
                    },
                    formatter: (value) => value > 0 ? value : ''
                }
            }, 
            scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const statusKeys = {{ status_keys|safe }};
                    const clickedStatusKey = statusKeys[elements[0].index];
                    const currentParams = new URLSearchParams(window.location.search);
                    currentParams.set('status', clickedStatusKey);
                    window.location.href = window.location.pathname + '?' + currentParams.toString();
                }
            }
        },
        plugins: [ChartDataLabels] // Registering the plugin
    });

    // Top Categories Pie Chart
    const topCategoriesCtx = document.getElementById('topCategoriesChart');
    if (topCategoriesCtx) {
        const topCategoryLabels = {{ top_category_labels|safe }};
        const topCategoryValues = {{ top_category_values|safe }};

        new Chart(topCategoriesCtx.getContext('2d'), {
            type: 'pie',
            data: {
                labels: topCategoryLabels,
                datasets: [{
                    data: {{ top_category_data|safe }},
                    backgroundColor: ['#17a2b8', '#563d7c', '#007bff'],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 16 },
                        formatter: (value) => value  
                    }
                },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const clickedCategoryValue = topCategoryValues[elements[0].index];
                        const currentParams = new URLSearchParams(window.location.search);
                        currentParams.set('category', clickedCategoryValue);
                        window.location.href = window.location.pathname + '?' + currentParams.toString();
                    }
                }
            },
            plugins: [ChartDataLabels]
        });
    }

    // Department Chart (Hazards by Department) - UPDATED
    const departmentChartCtx = document.getElementById('departmentChart');
    if (departmentChartCtx) {
        new Chart(departmentChartCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ department_labels|safe }},
                datasets: [{
                    label: 'Hazards',
                    data: {{ department_data|safe }},
                    backgroundColor: '#6f42c1',
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    // ✅ CHANGED: Data labels configuration for Department chart
                    datalabels: {
                        anchor: 'end',
                        align: 'bottom',  // <-- CHANGE: Aligns label inside the bar from the top
                        color: '#fff',      // <-- CHANGE: White color for contrast
                        offset: 4,          // Optional: Adds a little padding from the top edge
                        font: {
                            weight: 'bold'
                        },
                        formatter: (value) => value > 0 ? value : ''
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            },
            plugins: [ChartDataLabels] // Registering the plugin
        });
    }

}); // DOMContentLoaded listener ends here.

// --- REMOVE FILTER FUNCTION ---
// ... (This section remains unchanged) ...
function removeFilter(filterName) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.delete(filterName);
    
    if (filterName === 'plant') {
        urlParams.delete('zone');
        urlParams.delete('location'); 
        urlParams.delete('sublocation');
    }
    if (filterName === 'zone') {
        urlParams.delete('location');
        urlParams.delete('sublocation');
    }
    if (filterName === 'location') {
        urlParams.delete('sublocation');
    }
    
    window.location.href = window.location.pathname + '?' + urlParams.toString();
}

</script>
{% endblock %}